# UAT 測試報告 - Epic 18 本地帳號認證系統

**測試日期**: 2026-01-19
**測試工具**: Playwright (MCP)
**測試環境**: localhost:3003 (開發環境)
**測試人員**: Claude AI Assistant

---

## 測試摘要

| 項目 | 結果 |
|------|------|
| **Stories 範圍** | 18-1 至 18-4 |
| **測試案例總數** | 12 |
| **通過** | 12 |
| **部分通過** | 0 |
| **失敗** | 0 |
| **整體通過率** | 100% |

---

## Story 18-1: 用戶註冊

| # | 測試案例 | 狀態 | 備註 |
|---|----------|------|------|
| 1.1 | 成功註冊流程 | ✅ 通過 | 帳號成功建立，重導向至登入頁 |
| 1.2 | 密碼強度驗證 | ✅ 通過 | 弱密碼顯示 "Password must be at least 8 characters" |
| 1.4 | 重複郵件註冊 | ✅ 通過 | 顯示 "This email address is already registered" (409 Conflict) |

**測試帳號**: `uat-test-18@example.com` / `TestPass123!`

---

## Story 18-2: 本地帳號登入

| # | 測試案例 | 狀態 | 備註 |
|---|----------|------|------|
| 2.2 | 未驗證帳號登入 | ✅ 通過 | 顯示「請先驗證您的電郵地址」+ 重新發送驗證郵件連結 |
| 2.3 | 錯誤密碼登入 | ✅ 通過 | 顯示「電郵或密碼錯誤」 |

### 問題記錄

**Issue #1: EmailNotVerified 錯誤訊息未正確顯示** - ✅ 已修復

- **嚴重程度**: 中
- **描述**: 未驗證帳號登入時，後端正確返回 `EmailNotVerified` 錯誤，但前端 LoginForm 顯示通用錯誤訊息
- **修復方案**: 使用 Auth.js v5 的 `result.code` 獲取自定義錯誤代碼
- **修復文件**: `FIX-024-emailnotverified-error-display.md`
- **修復日期**: 2026-01-19

---

## Story 18-3: 密碼重設流程

| # | 測試案例 | 狀態 | 備註 |
|---|----------|------|------|
| 3.1 | 請求重設連結 | ✅ 通過 | 顯示「請檢查您的電子郵件」+ 安全訊息（防帳號枚舉） |
| 3.4 | 無效 Token 重設頁面 | ✅ 通過 | 顯示「重設連結無效」+「此密碼重設連結無效或已過期。請重新申請。」 |

---

## Story 18-4: 郵件驗證系統

| # | 測試案例 | 狀態 | 備註 |
|---|----------|------|------|
| 4.2 | 過期驗證連結 | ✅ 通過 | 顯示「驗證連結已過期」+「此驗證連結已超過 24 小時有效期」 |
| 4.3 | 無效驗證連結 | ✅ 通過 | 顯示「驗證連結無效」+「此驗證連結無效或已被使用」 |
| 4.4 | 重新發送驗證郵件 | ✅ 通過 | 顯示「驗證郵件已發送，請檢查您的收件匣」 |
| 4.5 | 已驗證帳號狀態 | ✅ 通過 | 顯示「電子郵件已驗證」+ 登入按鈕 |

---

## 測試環境配置

### 環境變數調整

為了顯示本地帳號登入表單，測試期間在 `.env.local` 添加了以下測試用 Azure AD 配置：

```env
AZURE_AD_CLIENT_ID="test-client-id-for-uat"
AZURE_AD_CLIENT_SECRET="test-client-secret-for-uat"
AZURE_AD_TENANT_ID="test-tenant-id-for-uat"
```

**注意**: 這些是測試用的假值，生產環境需要配置真實的 Azure AD 憑證。

### 服務端口

- 開發伺服器: `http://localhost:3003` (port 3000 被佔用)
- PostgreSQL: `localhost:5433`

---

## 截圖證據

測試過程使用 Playwright MCP 的 accessibility snapshot 功能記錄頁面狀態，主要驗證點：

1. **註冊頁面** - 表單欄位、密碼要求指示器、錯誤訊息
2. **登入頁面** - 本地登入表單、Microsoft 登入按鈕、錯誤處理
3. **忘記密碼頁面** - 郵件輸入、成功訊息
4. **密碼重設頁面** - 無效 Token 處理
5. **郵件驗證頁面** - 各種狀態顯示（expired/invalid/already_verified）

---

## 結論與建議

### 通過項目

- ✅ 用戶註冊流程完整運作
- ✅ 密碼強度驗證正確
- ✅ 重複郵件檢測正常
- ✅ 密碼重設流程正確
- ✅ 郵件驗證狀態頁面全部正確
- ✅ 重新發送驗證郵件功能正常
- ✅ 未驗證帳號登入錯誤訊息正確顯示（已修復）

### 待修復項目

（無）

### 建議後續測試

1. 使用真實 SMTP 服務測試郵件發送
2. 測試有效驗證 Token 的完整流程
3. 測試帳號鎖定機制（連續 5 次失敗）
4. 測試速率限制（重發驗證郵件 5次/小時）
5. 端對端流程測試：註冊 → 驗證 → 登入

---

**報告生成時間**: 2026-01-19 13:45 (UTC+8)
**報告更新時間**: 2026-01-19 (Bug 修復後更新)
**報告生成者**: Claude AI Assistant
