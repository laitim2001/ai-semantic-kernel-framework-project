# TEST-PLAN-002: Epic 0 歷史數據初始化 - 完整測試計劃

> **建立日期**: 2025-12-27
> **更新日期**: 2025-12-27
> **測試範圍**: Epic 0（Stories 0-1 到 0-9）
> **目標**: 驗證歷史數據初始化完整流程，從未知文件中**探索並發現**公司、文件格式和術語，建立三層映射規則的初始數據基礎

---

## 核心理念

```
┌─────────────────────────────────────────────────────────────────┐
│ ⚠️ 重要：這是一個「探索未知」的功能                              │
├─────────────────────────────────────────────────────────────────┤
│ • 我們不知道文件裡有哪些公司                                     │
│ • 我們不知道文件裡有哪些術語                                     │
│ • 我們不知道每間公司的文件格式有幾種                             │
│                                                                  │
│ → 這個功能的目的就是「找出來」並「記錄下來」                     │
│ → 輸出是一份「發現報告」，而非「驗證報告」                       │
└─────────────────────────────────────────────────────────────────┘
```

---

## 功能流程圖

```
┌─────────────────────────────────────────────────────────────────┐
│                    歷史文件數據初始化流程                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Step 1: 文件上傳入口                                            │
│  ├── 單張上傳                                                    │
│  └── 批量上傳                                                    │
│          ↓                                                       │
│  Step 2: 文件類型檢測                                            │
│  ├── Native PDF (可選取文字)                                     │
│  ├── Scanned PDF (掃描圖像)                                      │
│  └── Image (JPG/PNG)                                             │
│          ↓                                                       │
│  Step 3: 智能處理路由                                            │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ Native PDF:                                                  ││
│  │ → GPT-5.2: 識別發行者 + 文件格式分類                         ││
│  │ → Azure DI: 數據提取 + 術語數據提取                          ││
│  ├─────────────────────────────────────────────────────────────┤│
│  │ Scanned PDF / Image:                                         ││
│  │ → GPT-5.2: 識別發行者 + 文件格式分類                         ││
│  │          + 文字數據提取 + 術語數據提取                       ││
│  └─────────────────────────────────────────────────────────────┘│
│          ↓                                                       │
│  Step 4: 發行者匹配                                              │
│  ├── 嘗試匹配現有公司記錄                                        │
│  │   ├── 匹配成功 → 使用該公司記錄                               │
│  │   └── 無匹配 → 自動創建新公司記錄                             │
│  └── 標記來源為 AUTO_CREATED                                     │
│          ↓                                                       │
│  Step 5: 文件格式識別                                            │
│  ├── 識別文件類型 (Invoice/DN/CN/Statement)                      │
│  ├── 識別子類型 (Ocean/Air/Land/Courier) - 如有                  │
│  └── 建立 Company → Format → Terms 三層聚合結構                  │
│          ↓                                                       │
│  Step 6: 數據保存與報告輸出                                      │
│  ├── 保存所有識別結果                                            │
│  └── 輸出階層式報告：                                            │
│      • 發現了多少間發行公司？                                    │
│      • 每間公司有多少種文件格式？                                │
│      • 每種格式中出現了哪些術語/資料類型？                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 測試環境準備

### 測試數據來源

```
docs/Doc Sample/
├── 約 130+ 個真實發票/單據 PDF 文件
├── 來自不同的 Freight Forwarder
├── 包含多種文件類型（Invoice, Credit Note, Debit Note, Statement 等）
└── 文件命名格式：{公司名}_{單號}_{編號}.pdf
```

### 測試數據特徵

| 特徵 | 說明 |
|------|------|
| **公司數量** | 未知（需通過測試發現） |
| **文件類型** | 未知（需通過測試發現） |
| **術語數量** | 未知（需通過測試發現） |
| **文件格式** | PDF（包含 Native 和 Scanned） |

### 探索目標

> ⚠️ **注意**：以下不是「預期結果」，而是「探索目標」
> 系統應該能夠從測試文件中發現並整理出這些信息

| 探索項目 | 說明 |
|----------|------|
| 發行公司清單 | 從文件內容識別出的所有公司 |
| 文件格式類型 | 每間公司使用的文件類型和子類型 |
| 術語清單 | 每種文件格式中出現的所有術語/費用項目 |
| 術語頻率 | 每個術語在各公司/格式中的出現次數 |

---

## 測試案例

### Phase 1: 文件上傳與類型檢測

#### TC-1.1: 批量文件上傳

| 項目 | 內容 |
|------|------|
| **測試目的** | 驗證從 `docs/Doc Sample/` 上傳批量文件 |
| **測試步驟** | 1. 進入 `/admin/historical-data` <br> 2. 創建新批次，名稱：「測試批次 - Doc Sample」 <br> 3. 選擇 `docs/Doc Sample/` 中的文件上傳 <br> 4. 確認上傳完成 |
| **驗證點** | - 所有文件成功上傳 <br> - 文件列表正確顯示 <br> - 批次狀態為 `CREATED` |

#### TC-1.2: 文件類型自動偵測

| 項目 | 內容 |
|------|------|
| **測試目的** | 驗證系統能正確識別 PDF 類型（Native vs Scanned） |
| **驗證點** | - 每個文件有 `detectedType` 欄位 <br> - 類型為 `NATIVE_PDF` 或 `SCANNED_PDF` |
| **驗證 API** | `GET /api/v1/batches/:batchId/files` |

---

### Phase 2: 智能處理路由

#### TC-2.1: Native PDF 雙重處理

| 項目 | 內容 |
|------|------|
| **測試目的** | 驗證 Native PDF 使用 GPT + Azure DI 雙重處理 |
| **處理流程** | 1. GPT-5.2 識別發行者和文件格式 <br> 2. Azure DI 提取數據和術語 |
| **驗證點** | - `processingMethod` = `DUAL_PROCESSING` <br> - 有發行者識別結果 <br> - 有術語提取結果 |

#### TC-2.2: Scanned PDF 完整 Vision 處理

| 項目 | 內容 |
|------|------|
| **測試目的** | 驗證 Scanned PDF 使用 GPT Vision 完整處理 |
| **處理流程** | GPT-5.2 處理所有：發行者、格式、文字、術語 |
| **驗證點** | - `processingMethod` = `GPT_VISION` <br> - 所有欄位由 Vision 填充 |

---

### Phase 3: 發行者識別與公司匹配

#### TC-3.1: 發行者自動識別

| 項目 | 內容 |
|------|------|
| **測試目的** | 驗證系統能從文件內容識別發行公司 |
| **驗證點** | - 每個文件有 `documentIssuer` 欄位 <br> - 有 `identificationConfidence` 信心度 |
| **注意** | 我們不知道會識別出什麼公司名稱，這是探索過程 |

#### TC-3.2: 公司記錄匹配

| 項目 | 內容 |
|------|------|
| **測試目的** | 驗證識別的發行者能正確匹配/創建公司記錄 |
| **匹配策略** | 1. 完全匹配 <br> 2. 變體匹配（nameVariants） <br> 3. 模糊匹配（Levenshtein） |
| **驗證點** | - 已匹配：`matchMethod` = `EXACT` / `VARIANT` / `FUZZY` <br> - 新創建：`source` = `AUTO_CREATED`, `status` = `PENDING` |

#### TC-3.3: 公司發現報告

| 項目 | 內容 |
|------|------|
| **測試目的** | 驗證處理完成後能輸出公司發現清單 |
| **驗證 API** | `GET /api/v1/batches/:batchId/company-stats` |
| **預期輸出** | 發現的公司清單（數量未知，由系統識別決定） |

---

### Phase 4: 文件格式識別

#### TC-4.1: 文件類型分類

| 項目 | 內容 |
|------|------|
| **測試目的** | 驗證系統能識別文件類型 |
| **可能的類型** | INVOICE, DEBIT_NOTE, CREDIT_NOTE, STATEMENT, QUOTATION, OTHER |
| **驗證點** | - 每個文件有 `documentType` 欄位 <br> - 類型合理（發票類文件應為 INVOICE） |

#### TC-4.2: 文件子類型分類

| 項目 | 內容 |
|------|------|
| **測試目的** | 驗證系統能識別運輸類型（如有） |
| **可能的子類型** | OCEAN_FREIGHT, AIR_FREIGHT, LAND_TRANSPORT, CUSTOMS_CLEARANCE, GENERAL |
| **驗證點** | - `documentSubtype` 欄位（可為 null） <br> - 海運單據應為 OCEAN_FREIGHT |

---

### Phase 5: 術語發現與聚合

#### TC-5.1: 術語提取

| 項目 | 內容 |
|------|------|
| **測試目的** | 驗證系統能從文件內容提取費用術語 |
| **驗證點** | - 每個文件有提取的術語列表 <br> - 術語經過正規化處理（大小寫、空格） |
| **注意** | 我們不知道會提取出什麼術語，這是探索過程 |

#### TC-5.2: 術語頻率統計

| 項目 | 內容 |
|------|------|
| **測試目的** | 驗證術語出現頻率正確統計 |
| **驗證 API** | `GET /api/v1/batches/:batchId/term-stats` |
| **預期輸出** | 術語列表 + 每個術語的出現次數 |

---

### Phase 6: 三層聚合結構

#### TC-6.1: Company → Format → Terms 結構驗證

| 項目 | 內容 |
|------|------|
| **測試目的** | 驗證三層聚合結構正確建立 |
| **驗證 API** | `GET /api/v1/batches/:batchId/hierarchical-terms` |
| **預期結構** | |

```json
{
  "companies": [
    {
      "companyName": "[由系統識別]",
      "documentCount": "[處理的文件數]",
      "formats": [
        {
          "documentType": "[識別的類型]",
          "documentSubtype": "[識別的子類型或null]",
          "terms": [
            { "term": "[發現的術語]", "frequency": "[出現次數]" }
          ]
        }
      ]
    }
  ],
  "summary": {
    "totalCompanies": "[發現的公司數]",
    "totalFormats": "[發現的格式數]",
    "totalUniqueTerms": "[發現的術語數]"
  }
}
```

#### TC-6.2: 階層式報告 UI

| 項目 | 內容 |
|------|------|
| **測試目的** | 驗證樹狀視圖正確顯示三層結構 |
| **驗證點** | - 公司節點可展開 <br> - 格式節點顯示類型標籤 <br> - 術語按頻率排序 |

---

### Phase 7: 報告輸出

#### TC-7.1: 階層式報告匯出

| 項目 | 內容 |
|------|------|
| **測試目的** | 驗證 Excel 報告匯出功能（CHANGE-002） |
| **驗證點** | - 報告包含 4 個工作表 <br> - Summary 顯示統計 <br> - Companies/Formats/Terms 正確列出 |

#### TC-7.2: 報告內容驗證

| 項目 | 內容 |
|------|------|
| **測試目的** | 驗證報告能回答關鍵問題 |
| **關鍵問題** | |
| Q1 | 處理的文件中發現了多少間發行公司？ |
| Q2 | 每間公司發出的文件格式有幾種？ |
| Q3 | 每種格式中出現了哪些費用術語？ |
| Q4 | 哪些術語是跨公司通用的？ |

---

## 端到端測試場景

### E2E-01: 完整歷史數據初始化流程

```
測試目標：驗證從文件上傳到報告輸出的完整流程

Step 1: 創建批次
├── 進入 /admin/historical-data
├── 點擊「新增批次」
├── 批次名稱：「E2E 測試 - Doc Sample」
├── 啟用「公司識別」和「術語聚合」
└── 確認創建

Step 2: 上傳測試文件
├── 選擇 docs/Doc Sample/ 中的文件（建議先選 10-20 個）
├── 確認上傳完成
└── 查看文件類型偵測結果

Step 3: 開始處理
├── 點擊「開始處理」
├── 查看成本估算
└── 確認開始

Step 4: 監控進度
├── 觀察 SSE 進度更新
├── 確認每個文件處理狀態
└── 等待處理完成

Step 5: 查看發現結果
├── 查看「公司發現」區塊
│   └── 記錄：發現了 N 間公司（具體數字由系統識別決定）
├── 查看「格式分類」區塊
│   └── 記錄：每間公司有 M 種文件格式
├── 查看「術語聚合」區塊
│   └── 記錄：發現了 K 個獨立術語
└── 查看階層式報告
    └── 確認 Company → Format → Terms 結構正確

Step 6: 匯出報告
├── 點擊「匯出術語報告」
├── 下載 Excel 報告
└── 驗證報告回答了以下問題：
    • 有多少間公司？
    • 每間公司有哪些文件格式？
    • 每種格式中有哪些術語？
```

### 預期成果

> 📝 **注意**：以下是「報告應包含的信息類型」，而非具體數值

| 報告項目 | 說明 |
|----------|------|
| 公司清單 | 從文件中識別出的所有發行公司名稱 |
| 格式統計 | 每間公司使用的文件類型分佈 |
| 術語清單 | 每種文件格式中出現的費用項目 |
| 頻率數據 | 每個術語在各公司/格式中的出現次數 |

---

## 非功能性測試

### 性能測試

| 測試項目 | 目標 |
|----------|------|
| 批次上傳 | 100 個文件 < 30 秒 |
| 單文件處理 | 平均 < 15 秒 |
| 報告生成 | < 30 秒 |

### 錯誤處理測試

| 測試項目 | 測試方法 | 預期結果 |
|----------|----------|----------|
| 損壞文件 | 上傳無法解析的 PDF | 標記為 ERROR，可跳過 |
| 空白文件 | 上傳空白 PDF | 正確識別並標記 |
| 無法識別發行者 | 上傳無公司信息的文件 | 創建 UNKNOWN 公司或提示人工處理 |

---

## 測試執行記錄

### 測試環境

| 項目 | 值 |
|------|-----|
| 測試日期 | |
| 測試人員 | |
| 環境 | Development / Staging |
| 測試文件數 | |

### 發現結果記錄

> 在測試後填寫實際發現的數據

| 項目 | 發現值 |
|------|--------|
| 發現公司數 | |
| 發現格式數 | |
| 發現術語數 | |
| 通用術語數 | |

### 測試結果摘要

| Phase | 通過 | 失敗 | 備註 |
|-------|------|------|------|
| Phase 1: 文件上傳 | /2 | | |
| Phase 2: 處理路由 | /2 | | |
| Phase 3: 公司識別 | /3 | | |
| Phase 4: 格式識別 | /2 | | |
| Phase 5: 術語發現 | /2 | | |
| Phase 6: 三層聚合 | /2 | | |
| Phase 7: 報告輸出 | /2 | | |
| **總計** | /15 | | |

---

## 附錄

### A. 相關文檔

| 文檔 | 路徑 |
|------|------|
| Epic 0 Stories | `docs/03-stories/epic-0/` |
| Sprint Status | `docs/04-implementation/sprint-status.yaml` |
| CHANGE-001 (雙重處理) | `claudedocs/4-changes/feature-changes/CHANGE-001-*.md` |
| CHANGE-002 (報告匯出) | `claudedocs/4-changes/feature-changes/CHANGE-002-*.md` |

### B. 測試數據

| 項目 | 路徑 |
|------|------|
| 測試文件目錄 | `docs/Doc Sample/` |
| 文件數量 | 約 130+ 個 PDF |

### C. 驗收清單

- [ ] 批次上傳功能正常
- [ ] 文件類型正確識別
- [ ] 處理路由正確（Native PDF vs Scanned）
- [ ] 發行者成功識別並匹配/創建公司
- [ ] 文件格式正確分類
- [ ] 術語成功提取並聚合
- [ ] 三層結構 (Company → Format → Terms) 正確建立
- [ ] 階層式報告正確顯示
- [ ] Excel 報告成功匯出
- [ ] 報告內容完整回答關鍵業務問題

---

**建立者**: Claude AI Assistant
**建立日期**: 2025-12-27
**更新日期**: 2025-12-27
**文檔版本**: 2.0.0

### 版本記錄

| 版本 | 日期 | 變更 |
|------|------|------|
| 2.0.0 | 2025-12-27 | 重寫：修正測試數據路徑、移除預期值、改為探索導向設計 |
| 1.0.0 | 2025-12-27 | 初始版本 |
