# Epic 13: æ–‡ä»¶é è¦½èˆ‡æ¬„ä½æ˜ å°„

**Status:** ğŸš§ è¦åŠƒä¸­

---

## Epic æ¦‚è¦½

### ç›®æ¨™

æä¾›ç›´è§€çš„æ–‡ä»¶é è¦½ä»‹é¢å’Œéˆæ´»çš„æ¬„ä½æ˜ å°„é…ç½®ï¼Œè®“ç”¨æˆ¶å¯ä»¥æŸ¥çœ‹ AI æå–çµæœä¸¦è‡ªå®šç¾©æ¬„ä½æ˜ å°„è¦å‰‡ã€‚

### å•é¡Œé™³è¿°

ç›®å‰ç³»çµ±æå–æ–‡ä»¶å…§å®¹å¾Œï¼š
1. **ç¼ºä¹è¦–è¦ºåŒ–é è¦½**: ç”¨æˆ¶ç„¡æ³•ç›´è§€çœ‹åˆ°æå–æ¬„ä½åœ¨åŸå§‹æ–‡ä»¶ä¸­çš„ä½ç½®
2. **æ˜ å°„è¦å‰‡å›ºå®š**: Azure DI æå–çš„æ¬„ä½åç¨±èˆ‡ç³»çµ±å…§éƒ¨æ¬„ä½åç¨±ä¹‹é–“çš„æ˜ å°„æ˜¯å¯«æ­»çš„
3. **ç¼ºä¹è‡ªå®šç¾©èƒ½åŠ›**: ä¸åŒæ ¼å¼çš„æ–‡ä»¶å¯èƒ½éœ€è¦ä¸åŒçš„æ¬„ä½æ˜ å°„ç­–ç•¥

### è§£æ±ºæ–¹æ¡ˆ

å»ºç«‹æ–‡ä»¶é è¦½èˆ‡æ¬„ä½æ˜ å°„ç³»çµ±ï¼š
1. **æ–‡ä»¶é è¦½çµ„ä»¶**: ä½¿ç”¨ react-pdf é¡¯ç¤º PDFï¼Œæ”¯æ´ç¸®æ”¾ã€ç¿»é 
2. **æ¬„ä½é«˜äº®è¦†è“‹å±¤**: åœ¨é è¦½ä¸Šç–ŠåŠ æå–æ¬„ä½çš„ bounding box
3. **æ¬„ä½æ˜ å°„é…ç½®**: å¯è¦–åŒ–é…ç½® source â†’ target æ¬„ä½æ˜ å°„
4. **å‹•æ…‹æ˜ å°„å¼•æ“**: é‹è¡Œæ™‚æ ¹æ“šé…ç½®åŸ·è¡Œæ¬„ä½æ˜ å°„

### æ¶æ§‹è¨­è¨ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æ–‡ä»¶é è¦½èˆ‡æ¬„ä½æ˜ å°„ç³»çµ±                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ–‡ä»¶é è¦½å±¤ (Story 13-1)                                  â”‚   â”‚
â”‚  â”‚ - PDFViewer (react-pdf)                                 â”‚   â”‚
â”‚  â”‚ - FieldHighlightOverlay (bounding box è¦†è“‹)            â”‚   â”‚
â”‚  â”‚ - Zoom/Pan/Navigation æ§åˆ¶                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                          â†• äº’å‹•                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æå–çµæœé¢æ¿ (Story 13-2)                                â”‚   â”‚
â”‚  â”‚ - ExtractedFieldsPanel                                  â”‚   â”‚
â”‚  â”‚ - FieldCard (ä¿¡å¿ƒåº¦é¡¯ç¤ºã€inline ç·¨è¼¯)                   â”‚   â”‚
â”‚  â”‚ - æœå°‹/éæ¿¾/æ’åºåŠŸèƒ½                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                          â†• é…ç½®                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ¬„ä½æ˜ å°„é…ç½® (Story 13-3, 13-4)                          â”‚   â”‚
â”‚  â”‚ - MappingConfigPanel                                    â”‚   â”‚
â”‚  â”‚ - SourceFieldSelector / TargetFieldSelector             â”‚   â”‚
â”‚  â”‚ - MappingRuleList (drag-drop æ’åº)                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                          â†• åŸ·è¡Œ                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ å‹•æ…‹æ˜ å°„æœå‹™ (Story 13-5)                                â”‚   â”‚
â”‚  â”‚ - FieldMappingEngine                                    â”‚   â”‚
â”‚  â”‚ - DynamicMappingService                                 â”‚   â”‚
â”‚  â”‚ - çµæœç·©å­˜èˆ‡è™•ç†æµæ°´ç·šæ•´åˆ                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### èˆ‡å…¶ä»– Epic çš„é—œä¿‚

| Epic | é—œä¿‚ | èªªæ˜ |
|------|------|------|
| **Epic 14** | äº’è£œ | Epic 13 è™•ç†æ¬„ä½æ˜ å°„ï¼ŒEpic 14 è™•ç† Prompt é…ç½® |
| **Epic 15** | ä¸‹æ¸¸ | Epic 15 çš„çµ±ä¸€è™•ç†æµç¨‹æœƒä½¿ç”¨ Epic 13 çš„æ˜ å°„æœå‹™ |
| **Epic 0** | ä¸Šæ¸¸ | ä½¿ç”¨ Epic 0 å»ºç«‹çš„ DocumentFormat æ¨¡å‹ |

---

## Stories åˆ—è¡¨

| Story ID | æ¨™é¡Œ | ä¼°é» | ç‹€æ…‹ |
|----------|------|------|------|
| 13-1 | æ–‡ä»¶é è¦½çµ„ä»¶èˆ‡æ¬„ä½é«˜äº® | 8 | drafted |
| 13-2 | æ¬„ä½æå–çµæœé¢æ¿ | 5 | drafted |
| 13-3 | æ¬„ä½æ˜ å°„é…ç½®ä»‹é¢ | 5 | drafted |
| 13-4 | æ˜ å°„é…ç½® API | 5 | drafted |
| 13-5 | å‹•æ…‹æ¬„ä½æ˜ å°„æœå‹™æ•´åˆ | 8 | drafted |

**ç¸½ä¼°é»**: 31 é»

---

## Story æ‘˜è¦

### Story 13-1: æ–‡ä»¶é è¦½çµ„ä»¶èˆ‡æ¬„ä½é«˜äº®

å»ºç«‹å¯äº’å‹•çš„ PDF é è¦½çµ„ä»¶ï¼Œæ”¯æ´æ¬„ä½ä½ç½®é«˜äº®ã€‚

**é—œéµç”¢å‡º**:
- `PDFViewer` çµ„ä»¶ (react-pdf)
- `FieldHighlightOverlay` çµ„ä»¶ (bounding box æ¸²æŸ“)
- ç¸®æ”¾ã€ç¿»é ã€å°èˆªæ§åˆ¶
- æ¬„ä½é»æ“Šäº’å‹•

### Story 13-2: æ¬„ä½æå–çµæœé¢æ¿

å»ºç«‹æå–çµæœçš„å±•ç¤ºå’Œç·¨è¼¯é¢æ¿ã€‚

**é—œéµç”¢å‡º**:
- `ExtractedFieldsPanel` å®¹å™¨çµ„ä»¶
- `FieldCard` çµ„ä»¶ï¼ˆä¿¡å¿ƒåº¦é¡¯ç¤ºã€inline ç·¨è¼¯ï¼‰
- `FieldValueEditor` çµ„ä»¶
- æœå°‹ã€éæ¿¾ã€æ’åºåŠŸèƒ½

### Story 13-3: æ¬„ä½æ˜ å°„é…ç½®ä»‹é¢

å»ºç«‹æ¬„ä½æ˜ å°„è¦å‰‡çš„å¯è¦–åŒ–é…ç½®ä»‹é¢ã€‚

**é—œéµç”¢å‡º**:
- `MappingConfigPanel` çµ„ä»¶
- `SourceFieldSelector` / `TargetFieldSelector` çµ„ä»¶
- `MappingRuleList` çµ„ä»¶ (drag-drop æ’åº)
- æ˜ å°„è¦å‰‡é è¦½

### Story 13-4: æ˜ å°„é…ç½® API

å»ºç«‹æ¬„ä½æ˜ å°„é…ç½®çš„ CRUD APIã€‚

**é—œéµç”¢å‡º**:
- `FieldMappingConfig` Prisma æ¨¡å‹
- `FieldMappingRule` Prisma æ¨¡å‹
- CRUD REST API (`/api/v1/field-mapping-configs`)
- æ¸¬è©¦ç«¯é»ã€å°å…¥/å°å‡ºåŠŸèƒ½

### Story 13-5: å‹•æ…‹æ¬„ä½æ˜ å°„æœå‹™æ•´åˆ

å¯¦ç¾å‹•æ…‹æ¬„ä½æ˜ å°„å¼•æ“ä¸¦æ•´åˆåˆ°è™•ç†æµæ°´ç·šã€‚

**é—œéµç”¢å‡º**:
- `FieldMappingEngine` æœå‹™
- `DynamicMappingService` æœå‹™
- çµæœç·©å­˜æ©Ÿåˆ¶
- è™•ç†æµæ°´ç·šæ•´åˆ

---

## æŠ€è¡“è¨­è¨ˆ

### Prisma Schema

```prisma
model FieldMappingConfig {
  id               String       @id @default(cuid())
  name             String
  description      String?      @db.Text

  // é©ç”¨ç¯„åœ
  companyId        String?      @map("company_id")
  company          Company?     @relation(fields: [companyId], references: [id])

  documentFormatId String?      @map("document_format_id")
  documentFormat   DocumentFormat? @relation(fields: [documentFormatId], references: [id])

  // æ˜ å°„è¦å‰‡
  rules            FieldMappingRule[]

  // ç‹€æ…‹
  isActive         Boolean      @default(true) @map("is_active")
  priority         Int          @default(0)

  // å¯©è¨ˆ
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")
  createdById      String       @map("created_by_id")
  createdBy        User         @relation(fields: [createdById], references: [id])

  @@unique([companyId, documentFormatId])
  @@index([companyId])
  @@index([documentFormatId])
  @@map("field_mapping_configs")
}

model FieldMappingRule {
  id               String       @id @default(cuid())
  configId         String       @map("config_id")
  config           FieldMappingConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  // æ˜ å°„å®šç¾©
  sourceField      String       @map("source_field")     // Azure DI æ¬„ä½
  targetField      String       @map("target_field")     // ç³»çµ±æ¬„ä½
  transformType    TransformType @default(DIRECT)
  transformConfig  Json?        @map("transform_config")

  // é †åºèˆ‡ç‹€æ…‹
  order            Int          @default(0)
  isRequired       Boolean      @default(false) @map("is_required")
  defaultValue     String?      @map("default_value")

  @@index([configId])
  @@map("field_mapping_rules")
}

enum TransformType {
  DIRECT          // ç›´æ¥æ˜ å°„
  CONCAT          // ä¸²æ¥å¤šå€‹ä¾†æºæ¬„ä½
  SPLIT           // æ‹†åˆ†ä¾†æºæ¬„ä½
  LOOKUP          // æŸ¥è¡¨è½‰æ›
  CUSTOM          // è‡ªå®šç¾©å‡½æ•¸
}
```

### æ ¸å¿ƒé¡å‹å®šç¾©

```typescript
interface BoundingBox {
  x: number;
  y: number;
  width: number;
  height: number;
  page: number;
}

interface ExtractedField {
  id: string;
  name: string;
  value: string | null;
  confidence: number;
  boundingBox?: BoundingBox;
  source: 'azure_di' | 'gpt_vision';
}

interface MappingRule {
  id: string;
  sourceField: string;
  targetField: string;
  transformType: TransformType;
  transformConfig?: Record<string, unknown>;
  order: number;
  isRequired: boolean;
  defaultValue?: string;
}
```

---

## ä¾è³´é—œä¿‚

### ä¸Šæ¸¸ä¾è³´
- **Epic 0**: DocumentFormat æ¨¡å‹ï¼ˆStory 0-9ï¼‰
- **Epic 2**: æ–‡ä»¶æå–çµæœï¼ˆStory 2-4ï¼‰

### ä¸‹æ¸¸ä¾è³´
- **Epic 15**: çµ±ä¸€è™•ç†æµç¨‹ï¼ˆä½¿ç”¨æ­¤æ¬„ä½æ˜ å°„æœå‹™ï¼‰

---

## æˆåŠŸæŒ‡æ¨™

| æŒ‡æ¨™ | ç›®æ¨™ |
|------|------|
| PDF é è¦½è¼‰å…¥æ™‚é–“ | < 2 ç§’ |
| æ¬„ä½é«˜äº®æ¸²æŸ“å»¶é² | < 100ms |
| æ˜ å°„é…ç½® API éŸ¿æ‡‰æ™‚é–“ | < 200ms |
| å‹•æ…‹æ˜ å°„åŸ·è¡Œæ™‚é–“ | < 50ms/æ–‡ä»¶ |

---

## é¢¨éšªèˆ‡ç·©è§£

| é¢¨éšª | å½±éŸ¿ | ç·©è§£ç­–ç•¥ |
|------|------|----------|
| å¤§å‹ PDF è¼‰å…¥æ…¢ | ç”¨æˆ¶é«”é©—å·® | åˆ†é è¼‰å…¥ã€ç¸®åœ–é è¦½ |
| Bounding box ä½ç½®ä¸æº– | é«˜äº®éŒ¯ä½ | åº§æ¨™æ ¡æ­£ç®—æ³• |
| è¤‡é›œæ˜ å°„é‚è¼¯æ•ˆèƒ½ | è™•ç†å»¶é² | çµæœç·©å­˜ã€æ‰¹æ¬¡è™•ç† |

---

*Epic created: 2026-01-02*
*Last updated: 2026-01-02*
