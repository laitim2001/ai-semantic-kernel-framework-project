# FEAT-002: 貨幣功能系統化擴展 - 需求文檔

> **功能編號**: FEAT-002
> **創建日期**: 2025-11-17
> **狀態**: 📋 規劃階段
> **優先級**: P1 (高優先)
> **預估工時**: 12-16 小時
> **前置需求**: FEAT-001 (專案頁面貨幣功能) ✅ 已完成

---

## 📋 需求概述

### 業務背景
FEAT-001 已成功在專案頁面實現貨幣功能，驗證了技術可行性和使用者體驗。現在需要將貨幣支援擴展到整個系統的所有金額相關頁面，確保多幣種管理的完整性和一致性。

### 目標
系統化地將貨幣功能擴展到以下 7 個模組，確保所有金額欄位都有對應的貨幣標示。

---

## 🎯 影響範圍分析

根據資料庫 Schema 分析，以下模組需要添加貨幣支援：

### 模組優先級分類

#### 🔴 P1 - 核心財務模組（第一階段）
與專案直接關聯，必須優先處理：

1. **BudgetPool** (預算池)
   - 當前欄位: `totalAmount`, `usedAmount`
   - 需要: `currencyId` 欄位
   - 影響頁面: 預算池列表、預算池詳情、預算池建立/編輯

2. **BudgetProposal** (預算提案)
   - 當前欄位: `amount`, `approvedAmount`
   - 需要: `currencyId` 欄位（繼承自專案）
   - 影響頁面: 提案列表、提案詳情、提案建立/編輯、提案審批

3. **Quote** (報價單)
   - 當前欄位: `amount`
   - 需要: `currencyId` 欄位（繼承自專案）
   - 影響頁面: 報價單列表、報價單上傳

#### 🟡 P2 - 採購與費用模組（第二階段）
與採購流程相關：

4. **PurchaseOrder** (採購單)
   - 當前欄位: `totalAmount`
   - 需要: `currencyId` 欄位（繼承自專案）
   - 影響頁面: 採購單列表、採購單詳情、採購單建立/編輯

5. **Expense** (費用記錄)
   - 當前欄位: `totalAmount`
   - 需要: `currencyId` 欄位（繼承自專案或採購單）
   - 影響頁面: 費用列表、費用詳情、費用建立/編輯、費用審批

#### 🟢 P3 - 營運與轉嫁模組（第三階段）
獨立營運費用，與專案關聯較弱：

6. **OMExpense** (OM費用)
   - 當前欄位: `budgetAmount`, `actualSpent`
   - 需要: `currencyId` 欄位（獨立設定）
   - 影響頁面: OM費用列表、OM費用詳情、OM費用建立/編輯、月度記錄

7. **ChargeOut** (費用轉嫁)
   - 當前欄位: `totalAmount`
   - 需要: `currencyId` 欄位（繼承自專案）
   - 影響頁面: 費用轉嫁列表、費用轉嫁詳情、費用轉嫁建立

---

## 📝 詳細需求

### FR-002.1: BudgetPool 貨幣支援

**業務規則**:
- 每個預算池使用單一貨幣
- 貨幣欄位為**必填**
- 預設使用系統預設貨幣（TWD）
- 現有預算池在 Migration 時自動設定為 TWD
- 預算池建立後貨幣**不可修改**（避免歷史資料混亂）

**資料庫變更**:
```prisma
model BudgetPool {
  // ... 現有欄位 ...
  currencyId String  // 新增：關聯到 Currency 表（必填）

  currency Currency @relation(fields: [currencyId], references: [id])

  @@index([currencyId])
}
```

**UI 要求**:
- **建立頁面**: 顯示貨幣選擇器（Select Dropdown）
- **編輯頁面**: 顯示當前貨幣（**只讀**，不可修改）
- **列表頁面**: 顯示貨幣代碼（如 "TWD"）
- **詳情頁面**: 顯示完整貨幣信息（如 "TWD - 新台幣"）
- **統計資訊**: 按貨幣分組統計

**驗收標準**:
- [x] 資料庫 Migration 成功
- [x] 現有預算池自動設定 TWD
- [x] 建立頁面貨幣欄位必填
- [x] 編輯頁面貨幣欄位只讀
- [x] 列表和詳情頁正確顯示

---

### FR-002.2: BudgetProposal 貨幣支援

**業務規則**:
- 提案的貨幣**自動繼承自專案**
- 不需要獨立的 `currencyId` 欄位（透過 `project.currency` 取得）
- 金額必須與專案貨幣一致

**UI 要求**:
- **建立/編輯頁面**:
  - 顯示專案的貨幣（只讀）
  - 金額輸入框旁邊顯示貨幣符號
- **列表頁面**: 顯示金額 + 貨幣代碼
- **詳情頁面**: 顯示完整貨幣信息
- **審批頁面**: 顯示批准金額 + 貨幣

**驗收標準**:
- [x] 提案自動使用專案貨幣
- [x] 金額顯示包含貨幣符號
- [x] 列表和詳情頁正確顯示

---

### FR-002.3: Quote 貨幣支援

**業務規則**:
- 報價單的貨幣**自動繼承自專案**
- 不需要獨立的 `currencyId` 欄位
- 支援多幣種報價比較（未來功能）

**UI 要求**:
- **上傳頁面**:
  - 顯示專案的貨幣（只讀）
  - 金額輸入框旁邊顯示貨幣符號
- **列表頁面**: 顯示金額 + 貨幣代碼
- **比較頁面**: 按專案貨幣顯示所有報價

**驗收標準**:
- [x] 報價單自動使用專案貨幣
- [x] 金額顯示包含貨幣符號
- [x] 報價比較頁面按貨幣分組

---

### FR-002.4: PurchaseOrder 貨幣支援

**業務規則**:
- 採購單的貨幣**自動繼承自專案**
- 不需要獨立的 `currencyId` 欄位
- 明細項目（PurchaseOrderItem）使用相同貨幣

**UI 要求**:
- **建立/編輯頁面**:
  - 顯示專案的貨幣（只讀）
  - 所有金額欄位旁邊顯示貨幣符號
- **列表頁面**: 顯示總金額 + 貨幣代碼
- **詳情頁面**: 完整顯示貨幣信息

**驗收標準**:
- [x] 採購單自動使用專案貨幣
- [x] 明細項目金額顯示貨幣符號
- [x] 總金額計算正確

---

### FR-002.5: Expense 貨幣支援

**業務規則**:
- 費用的貨幣**自動繼承自採購單**（採購單繼承自專案）
- 不需要獨立的 `currencyId` 欄位
- 明細項目（ExpenseItem）使用相同貨幣

**UI 要求**:
- **建立/編輯頁面**:
  - 顯示採購單的貨幣（只讀）
  - 所有金額欄位旁邊顯示貨幣符號
- **列表頁面**: 顯示總金額 + 貨幣代碼
- **詳情頁面**: 完整顯示貨幣信息
- **審批頁面**: 顯示批准金額 + 貨幣

**驗收標準**:
- [x] 費用自動使用採購單貨幣
- [x] 明細項目金額顯示貨幣符號
- [x] 總金額計算正確

---

### FR-002.6: OMExpense 貨幣支援

**業務規則**:
- OM費用需要**獨立設定貨幣**（不關聯專案）
- 貨幣欄位為**必填**
- 月度記錄（OMExpenseMonthly）使用相同貨幣

**資料庫變更**:
```prisma
model OMExpense {
  // ... 現有欄位 ...
  currencyId String  // 新增：關聯到 Currency 表（必填）

  currency Currency @relation(fields: [currencyId], references: [id])

  @@index([currencyId])
}
```

**UI 要求**:
- **建立頁面**: 顯示貨幣選擇器（必填）
- **編輯頁面**: 貨幣欄位**可編輯**（但需警告）
- **列表頁面**: 顯示預算/實際金額 + 貨幣代碼
- **月度記錄**: 所有金額顯示貨幣符號

**驗收標準**:
- [x] 資料庫 Migration 成功
- [x] 現有 OM費用自動設定 TWD
- [x] 建立頁面貨幣欄位必填
- [x] 月度記錄金額正確顯示

---

### FR-002.7: ChargeOut 貨幣支援

**業務規則**:
- 費用轉嫁的貨幣**自動繼承自專案**
- 不需要獨立的 `currencyId` 欄位
- 明細項目（ChargeOutItem）使用相同貨幣

**UI 要求**:
- **建立/編輯頁面**:
  - 顯示專案的貨幣（只讀）
  - 所有金額欄位旁邊顯示貨幣符號
- **列表頁面**: 顯示總金額 + 貨幣代碼
- **詳情頁面**: 完整顯示貨幣信息

**驗收標準**:
- [x] 費用轉嫁自動使用專案貨幣
- [x] 明細項目金額顯示貨幣符號
- [x] 總金額計算正確

---

## 🔄 資料模型變更總覽

### 需要新增 currencyId 欄位的模型

| 模型 | 需要新增欄位 | 貨幣來源 | Migration 預設值 |
|------|------------|---------|----------------|
| BudgetPool | ✅ `currencyId` (必填) | 獨立設定 | TWD |
| BudgetProposal | ❌ | 繼承自 Project | - |
| Quote | ❌ | 繼承自 Project | - |
| PurchaseOrder | ❌ | 繼承自 Project | - |
| Expense | ❌ | 繼承自 PurchaseOrder → Project | - |
| OMExpense | ✅ `currencyId` (必填) | 獨立設定 | TWD |
| ChargeOut | ❌ | 繼承自 Project | - |

**說明**:
- ✅ 表示需要在資料庫新增 `currencyId` 欄位
- ❌ 表示不需要新增欄位，透過關聯關係取得貨幣

---

## 🎯 驗收標準

### AC-002.1: 資料庫 Migration
- [x] BudgetPool 新增 `currencyId` 欄位
- [x] OMExpense 新增 `currencyId` 欄位
- [x] Currency Model 新增關聯
- [x] Migration 成功執行
- [x] 現有資料自動設定 TWD

### AC-002.2: 預算池頁面
- [x] 列表頁顯示貨幣代碼
- [x] 建立頁面貨幣選擇器
- [x] 編輯頁面貨幣只讀
- [x] 詳情頁完整貨幣信息

### AC-002.3: 預算提案頁面
- [x] 顯示專案貨幣
- [x] 金額欄位顯示貨幣符號
- [x] 審批頁面顯示貨幣

### AC-002.4: 報價單頁面
- [x] 上傳頁面顯示專案貨幣
- [x] 列表頁顯示金額 + 貨幣
- [x] 比較頁面按貨幣分組

### AC-002.5: 採購單頁面
- [x] 建立/編輯頁面顯示專案貨幣
- [x] 列表頁顯示總金額 + 貨幣
- [x] 詳情頁完整貨幣信息

### AC-002.6: 費用記錄頁面
- [x] 建立/編輯頁面顯示採購單貨幣
- [x] 列表頁顯示總金額 + 貨幣
- [x] 審批頁面顯示貨幣

### AC-002.7: OM費用頁面
- [x] 列表頁顯示貨幣代碼
- [x] 建立頁面貨幣選擇器
- [x] 月度記錄顯示貨幣符號

### AC-002.8: 費用轉嫁頁面
- [x] 建立/編輯頁面顯示專案貨幣
- [x] 列表頁顯示總金額 + 貨幣

### AC-002.9: I18N 支援
- [x] 繁體中文翻譯完整
- [x] 英文翻譯完整
- [x] 兩種語言切換正常

### AC-002.10: TypeScript 類型安全
- [x] 所有新欄位有正確的型別定義
- [x] tRPC Schema 正確更新
- [x] Prisma Schema 正確更新
- [x] API package TypeScript 檢查通過

---

## 🚨 風險與約束

### 技術風險

1. **資料庫 Migration 風險**:
   - 現有 BudgetPool 和 OMExpense 沒有貨幣值
   - 緩解: Migration 自動設定 TWD，後續可手動調整

2. **貨幣不一致風險**:
   - 專案、預算池、OM費用可能使用不同貨幣
   - 緩解: UI 清楚標示貨幣，提供貨幣轉換提示

3. **預算池貨幣鎖定影響**:
   - 預算池貨幣不可修改可能導致靈活性降低
   - 緩解: 提供清楚的說明和警告訊息

### 業務約束

1. **匯率管理**:
   - 本次不包含匯率自動更新功能
   - 匯率需手動維護
   - 報表不支援自動貨幣轉換（未來功能）

2. **歷史資料處理**:
   - 現有資料統一設定為 TWD
   - 使用者需手動檢查和調整（如有需要）

3. **貨幣變更限制**:
   - BudgetPool 貨幣建立後不可修改
   - OMExpense 貨幣可修改但需謹慎
   - Project 貨幣可修改但需警告

---

## 📅 開發排程建議

### Phase 1: 核心財務模組（4-6 小時）
1. **資料庫 Migration** (1 小時)
   - BudgetPool 新增 `currencyId`
   - OMExpense 新增 `currencyId`
   - 現有資料設定 TWD
   - 更新 Currency Model 關聯

2. **BudgetPool 頁面更新** (2 小時)
   - 更新 API Router
   - 更新建立/編輯頁面
   - 更新列表/詳情頁面

3. **BudgetProposal 頁面更新** (1.5 小時)
   - 更新 API Router（載入專案貨幣）
   - 更新建立/編輯頁面
   - 更新列表/詳情/審批頁面

4. **Quote 頁面更新** (0.5 小時)
   - 更新上傳頁面
   - 更新列表頁面

### Phase 2: 採購與費用模組（3-4 小時）
5. **PurchaseOrder 頁面更新** (1.5 小時)
   - 更新 API Router
   - 更新建立/編輯頁面
   - 更新列表/詳情頁面

6. **Expense 頁面更新** (1.5 小時)
   - 更新 API Router
   - 更新建立/編輯頁面
   - 更新列表/詳情/審批頁面

### Phase 3: 營運與轉嫁模組（3-4 小時）
7. **OMExpense 頁面更新** (2 小時)
   - 更新 API Router
   - 更新建立/編輯頁面
   - 更新列表/月度記錄頁面

8. **ChargeOut 頁面更新** (1 小時)
   - 更新 API Router
   - 更新建立/編輯頁面
   - 更新列表/詳情頁面

### Phase 4: I18N 與測試（2 小時）
9. **I18N 翻譯** (0.5 小時)
   - 新增繁中翻譯
   - 新增英文翻譯

10. **完整測試** (1.5 小時)
    - 所有頁面手動測試
    - 貨幣顯示驗證
    - 代碼品質檢查

**總計**: 12-16 小時（1.5-2 工作日）

---

## 🔗 相關文檔

- [FEAT-001 Requirements](../FEAT-001-project-fields-enhancement/01-requirements.md) - 專案貨幣功能實現參考
- [02-architecture.md](./02-architecture.md) - 技術架構設計
- [03-development.md](./03-development.md) - 開發指南
- [04-progress.md](./04-progress.md) - 開發進度追蹤

---

**文檔維護者**: AI Assistant + 開發團隊
**最後更新**: 2025-11-17
**狀態**: 📋 規劃階段
