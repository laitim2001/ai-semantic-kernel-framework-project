# FEAT-001: 專案欄位擴展 - 需求文檔

> **功能編號**: FEAT-001
> **創建日期**: 2025-11-14
> **完成日期**: 2025-11-16
> **狀態**: ✅ 開發完成（Phase 1-3）
> **優先級**: P1 (高優先)
> **預估工時**: 6-8 小時
> **實際工時**: ~4 小時

---

## 📋 需求概述

### 業務背景
當前專案管理系統缺少關鍵的專案識別和分類欄位，導致：
1. 專案無法快速透過編號查找和引用
2. 缺少全域/區域的專案分類機制
3. 無法標示專案優先級，影響資源分配決策
4. 不同貨幣的專案無法正確管理和比較

### 目標
在專案建立/編輯頁面新增 4 個關鍵欄位，完善專案的元數據管理。

---

## 📝 功能需求

### FR-001: 專案編號 (Project ID)
**需求描述**: 為每個專案設定唯一的專案編號，方便引用和查找

**業務規則**:
- 專案編號格式: 自由文字（由使用者自訂，如 "PROJ-2025-001", "ERP-UPGRADE-001"）
- 必填欄位
- 系統內唯一（不可重複）
- 建立後可編輯（考慮到編號規則可能變更）
- 最大長度: 50 字元
- 允許字母、數字、連字號 (-)、底線 (_)

**UI 要求**:
- 輸入框類型: Text Input
- 顯示位置: 專案名稱之前或緊隨其後
- 即時驗證: 檢查唯一性（debounce 500ms）
- 錯誤提示: "此專案編號已存在，請使用其他編號"

**範例**:
```
有效: PROJ-2025-001, ERP_UPGRADE, IT-2025-Q1-001
無效: （空白）, （重複的編號）
```

**用戶決策**:
- ✅ 完全由使用者自訂（自由文字）
- ❌ 不提供自動產生功能（未來可擴展）

---

### FR-002: 全域標誌 (Global Flag - RCL or Region)
**需求描述**: 標示專案是全域性（Regional/Corporate Level，簡稱 RCL）還是區域性專案

**業務規則**:
- 選項: "RCL" (Regional/Corporate Level) 或 "Region" (區域)
- 必填欄位
- 預設值: "Region"（大部分專案為區域性）
- 建立後可編輯

**UI 要求**:
- 輸入框類型: Radio Button 或 Select Dropdown
- 選項:
  - 🌍 RCL (Regional/Corporate Level) - 全域專案
  - 📍 Region - 區域專案
- 顯示位置: 專案編號之後

**影響**:
- 全域專案可能需要更高層級的批准
- 影響報表的分組和統計
- 可能影響預算池的選擇範圍

---

### FR-003: 優先權 (Priority)
**需求描述**: 標示專案的優先級別，協助資源分配和排程決策

**業務規則**:
- 選項: High (高), Medium (中), Low (低)
- 必填欄位
- 預設值: "Medium"
- 建立後可編輯

**UI 要求**:
- 輸入框類型: Select Dropdown
- 選項（帶視覺標示）:
  - 🔴 High (高) - 最高優先
  - 🟡 Medium (中) - 一般優先
  - 🟢 Low (低) - 低優先
- 顯示位置: 全域標誌之後
- 顏色編碼: 在列表頁面用徽章（Badge）顯示

**影響**:
- 影響專案列表的預設排序
- 影響儀表板的專案優先顯示
- 可能觸發不同的通知策略

---

### FR-004: 貨幣 (Currency)
**需求描述**: 指定專案使用的貨幣，支援多幣種專案管理

**業務規則**:
- 資料來源: 從「貨幣管理」獨立頁面選擇
- 必填欄位
- 預設值: 系統預設貨幣（如 "TWD" 或 "USD"）
- 建立後可編輯（但需審慎，可能影響已記錄的金額）

**UI 要求**:
- 輸入框類型: Select Dropdown（可搜尋）
- 選項格式: "貨幣代碼 - 貨幣名稱" (如 "TWD - 新台幣", "USD - 美元")
- 顯示位置: 請求預算金額之前或之後
- 搜尋: 支援搜尋貨幣代碼或名稱

**貨幣管理需求** (FR-004.1):
- **獨立管理頁面**: `/settings/currencies`（系統設定頁面下）
- **功能**: 新增、編輯、刪除、啟用/停用貨幣
- **欄位**:
  - 貨幣代碼 (Code): 3 字母 ISO 4217 代碼（如 TWD, USD, EUR）- 必填、唯一
  - 貨幣名稱 (Name): 完整貨幣名稱（如 "新台幣", "美元"）- 必填
  - 符號 (Symbol): 貨幣符號（如 NT$, $, €）- 必填
  - 匯率 (Exchange Rate): 對基準貨幣的匯率 - 可選
  - 狀態 (Active): 是否啟用 - 預設啟用
- **預設資料**: 系統初始化時包含常見貨幣（TWD, USD, EUR, CNY, JPY, HKD）

**影響**:
- **第一階段**: 只影響專案頁面的顯示和記錄
- **後續階段**: 逐步更新預算、提案、採購單、費用等頁面
- **報表**: 未來需要支援多幣種顯示和匯總（不在本次範圍）

**重要限制** (用戶決策):
- 本次開發只處理專案頁面的貨幣欄位
- 其他頁面（提案、採購單、費用等）在專案頁面驗證無誤後再逐步更新

---

## 🔄 關聯模組影響分析

### 影響的現有功能

#### 1. 專案列表頁 (`/projects`)
**新增顯示**:
- 專案編號列（可排序、可搜尋）
- 全域標誌徽章（RCL/Region）
- 優先權徽章（帶顏色）
- 貨幣代碼顯示

**新增篩選**:
- 全域標誌篩選器
- 優先權篩選器
- 貨幣篩選器

**新增排序**:
- 專案編號排序
- 優先權排序（High > Medium > Low）

#### 2. 專案詳情頁 (`/projects/[id]`)
**新增顯示區塊**:
```
專案基本資訊
├── 專案編號: PROJ-2025-001
├── 專案名稱: ERP 系統升級
├── 全域標誌: 🌍 RCL
├── 優先權: 🔴 High
├── 貨幣: TWD - 新台幣
└── ...（現有欄位）
```

#### 3. 儀表板 (`/dashboard`)
**專案統計卡片**:
- 按優先權分組統計（高/中/低優先專案數量）
- 按全域標誌分組（RCL vs Region）
- 多幣種預算摘要

#### 4. 預算提案 (`/proposals`)
**關聯影響**:
- 顯示專案編號（方便引用）
- 顯示專案貨幣（金額需對齊貨幣）

#### 5. 採購單/費用 (`/purchase-orders`, `/expenses`)
**關聯影響**:
- 顯示專案編號
- 金額需與專案貨幣對齊

---

## 🎯 驗收標準

### AC-001: 專案建立頁面
- [x] 4 個新欄位全部顯示並可輸入 ✅
- [x] 專案編號唯一性即時驗證 ✅ (debounce 500ms)
- [x] 全域標誌預設為 "Region" ✅
- [x] 優先權預設為 "Medium" ✅
- [x] 貨幣為可選欄位（非必填）✅
- [x] 所有必填欄位未填寫時無法提交 ✅
- [x] 提交成功後資料正確儲存到資料庫 ✅

### AC-002: 專案編輯頁面
- [x] 4 個新欄位顯示現有值 ✅
- [x] 專案編號可編輯且驗證唯一性（排除自己）✅
- [x] 其他欄位可正常編輯和更新 ✅
- [x] 更新成功後資料正確儲存 ✅

### AC-003: 專案列表頁面
- [x] 新增專案編號、全域標誌、優先權欄位顯示 ✅
- [x] 全域標誌和優先權使用徽章（Badge）顯示 ✅
- [ ] 專案編號支援搜尋 ⏳（後續優化）
- [ ] 全域標誌、優先權、貨幣支援篩選 ⏳（後續優化）
- [ ] 專案編號和優先權支援排序 ⏳（後續優化）

### AC-004: 專案詳情頁面
- [x] 4 個新欄位在專案資訊區塊正確顯示 ✅

### AC-005: 貨幣管理頁面
- [x] 可以新增、編輯、刪除貨幣 ✅
- [x] 貨幣代碼唯一性驗證 ✅
- [x] 貨幣啟用/停用功能 ✅
- [x] 停用的貨幣不顯示在專案表單中 ✅
- [x] 系統有預設貨幣資料（TWD, USD, EUR, CNY, JPY, HKD）✅

### AC-006: 資料完整性
- [x] 資料庫 Migration 成功執行 ✅
- [x] 現有專案的新欄位有合理的預設值 ✅
- [x] 無資料遺失或損壞 ✅

### AC-007: I18N 支援
- [x] 繁體中文翻譯完整 ✅ (23 個新鍵)
- [x] 英文翻譯完整 ✅ (23 個新鍵)
- [x] 兩種語言切換正常 ✅

### AC-008: TypeScript 類型安全
- [x] 所有新欄位有正確的型別定義 ✅
- [x] tRPC Schema 正確更新 ✅
- [x] Prisma Schema 正確更新 ✅
- [x] API package TypeScript 檢查通過 ✅

---

## 🚨 風險與約束

### 技術風險
1. **資料庫 Migration 風險**:
   - 現有專案沒有新欄位的值
   - 緩解: 設定合理的預設值，或在 Migration 中批量更新

2. **貨幣變更影響**:
   - 專案建立後變更貨幣可能導致已記錄金額的混淆
   - 緩解: 提供警告訊息，或限制已有費用記錄的專案無法變更貨幣

3. **唯一性驗證效能**:
   - 專案編號唯一性檢查可能影響表單體驗
   - 緩解: 使用 debounce (500ms) 和資料庫索引

### 業務約束
1. **貨幣影響範圍限制** (用戶決策):
   - 第一階段只處理專案頁面
   - 其他頁面（提案、採購單、費用）後續逐步更新

2. **貨幣匯率管理**:
   - 本次不包含匯率自動更新功能
   - 匯率需手動維護

3. **現有專案處理** (用戶決策):
   - ✅ Migration 自動設定預設值：
     - `projectCode` = `"LEGACY-{UUID前8碼}"`（如 "LEGACY-ab5bee0a"）
     - `globalFlag` = `"Region"`
     - `priority` = `"Medium"`
     - `currencyId` = 系統預設貨幣（TWD）的 ID
   - 使用者可在專案編輯頁面手動更新這些預設值

---

## 📊 資料模型變更預覽

### Project Model (Prisma Schema)
```prisma
model Project {
  // ... 現有欄位 ...

  // 新增欄位
  projectCode   String  @unique         // FR-001: 專案編號
  globalFlag    String  @default("Region") // FR-002: RCL or Region
  priority      String  @default("Medium")  // FR-003: High/Medium/Low
  currencyId    String?                 // FR-004: 關聯到 Currency 表

  // 關聯
  currency      Currency? @relation(fields: [currencyId], references: [id])

  @@index([projectCode])
  @@index([globalFlag])
  @@index([priority])
  @@index([currencyId])
}

// 新增 Currency Model
model Currency {
  id           String   @id @default(uuid())
  code         String   @unique           // ISO 4217 貨幣代碼
  name         String                     // 貨幣名稱
  symbol       String                     // 貨幣符號
  exchangeRate Float?                     // 匯率（可選）
  active       Boolean  @default(true)    // 是否啟用
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  projects     Project[]

  @@index([code])
  @@index([active])
}
```

---

## 📅 開發排程建議

### Phase 1: 資料庫與後端 (2-3 小時)
1. 創建 Currency Model
2. 更新 Project Model
3. 建立 Migration
4. 建立 Currency API Router (CRUD)
5. 更新 Project API Router (新增欄位驗證)
6. Seed 預設貨幣資料

### Phase 2: 前端表單 (2-3 小時)
1. 更新 ProjectForm 組件（新增 4 個欄位）
2. 實作專案編號唯一性即時驗證
3. 實作貨幣選擇器（Combobox）
4. 更新建立頁面
5. 更新編輯頁面

### Phase 3: 列表與詳情頁 (1-2 小時)
1. 更新專案列表頁（顯示、篩選、排序）
2. 更新專案詳情頁（顯示新欄位）
3. 實作徽章（Badge）組件（全域標誌、優先權）

### Phase 4: 貨幣管理頁面 (2-3 小時)
1. 建立貨幣管理頁面 UI
2. 實作 CRUD 功能
3. 實作啟用/停用功能

### Phase 5: I18N 與測試 (1 小時)
1. 新增繁中/英文翻譯
2. E2E 測試（可選）
3. 驗證所有驗收標準

**總計**: 8-12 小時（1-1.5 工作日）

---

## 🔗 相關文檔

- [02-technical-design.md](./02-technical-design.md) - 技術設計文檔
- [03-implementation-plan.md](./03-implementation-plan.md) - 實施計劃
- [04-progress.md](./04-progress.md) - 開發進度追蹤

---

**文檔維護者**: AI Assistant + 開發團隊
**最後更新**: 2025-11-16
**狀態**: ✅ Phase 1-3 開發完成，驗收標準大部分達成
