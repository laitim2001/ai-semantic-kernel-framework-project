# FEAT-007: OM Expense 表頭-明細架構重構

> **建立日期**: 2025-12-05
> **狀態**: 📋 設計中
> **優先級**: High
> **類型**: 重大架構重構 (Major Refactoring)
> **預估工作量**: 44-61 小時

---

## 1. 功能概述

### 1.1 背景

目前 OM Expense（營運維護費用）系統採用**扁平化資料結構**：

```
OMExpense (單一記錄)
└── OMExpenseMonthly (12 個月度記錄)
```

這種結構無法準確反映實際業務場景。根據同事提供的 Excel 工作表（IT Annual Maintenance Budget for FY26），OM 費用具有明顯的**階層結構**：

```
A) Datalines (大類別)
├── 1) R-WAN (子類別)
│   ├── 1.1 TGT-DC (明細項目)
│   ├── 1.2 RDC2 (明細項目)
│   └── 1.3 X-Connection (明細項目)
├── 2) OU-WAN (子類別)
│   └── ...
└── 3) ...
```

每個明細項目都有獨立的：
- 預算金額 (US$ / HK$)
- 年增長率 (Increment %)
- OpCo 歸屬 (Owned by)
- 費用轉嫁對象 (Charge to)
- 實際金額
- 合約結束日期

### 1.2 目標

將 OM Expense 系統重構為**表頭-明細架構**，使其能夠：

1. **準確建模業務數據** - 支援一個 OM 費用記錄包含多個明細項目
2. **支援 Excel 數據遷移** - 能夠導入現有 Excel 工作表數據
3. **維持現有功能** - 保留月度記錄、預算追蹤、YoY 計算等功能
4. **增強報表能力** - 支援按類別、OpCo、項目等多維度分析

### 1.3 預期成果

重構後的資料結構：

```
OMExpense (表頭)
├── 基本資訊 (名稱、描述、財年、類別)
├── 匯總數據 (總預算、總實際)
└── OMExpenseItem[] (明細項目)
    ├── 項目1
    │   ├── 項目資訊 (名稱、預算、OpCo、結束日期)
    │   └── OMExpenseMonthly[] (12個月度記錄)
    ├── 項目2
    │   └── ...
    └── 項目N
        └── ...
```

---

## 2. 業務需求

### 2.1 用戶故事

| ID | 角色 | 用戶故事 | 優先級 |
|----|------|---------|--------|
| US-01 | 財務人員 | 我希望能在一個 OM 費用記錄中添加多個明細項目，以便準確反映合約或服務的多個組成部分 | High |
| US-02 | 財務人員 | 我希望每個明細項目可以有不同的 OpCo 歸屬，以便準確追蹤費用歸屬 | High |
| US-03 | 財務人員 | 我希望能夠批量導入 Excel 數據到新系統，以便遷移現有記錄 | Medium |
| US-04 | 財務人員 | 我希望能夠調整明細項目的順序，以便按業務邏輯排列 | Low |
| US-05 | 主管 | 我希望 O&M Summary 頁面能夠按明細項目顯示數據，以便更細緻地分析費用 | High |
| US-06 | IT 人員 | 我希望每個明細項目能獨立記錄月度實際支出，以便精確追蹤各項目執行情況 | High |

### 2.2 功能需求

#### FR-01: 表頭管理
- [x] 建立 OM 費用表頭（名稱、描述、財年、類別）
- [x] 編輯表頭基本資訊
- [x] 刪除表頭（級聯刪除所有明細和月度記錄）
- [x] 表頭匯總數據自動計算（總預算、總實際）

#### FR-02: 明細項目管理
- [ ] 在表頭下新增明細項目
- [ ] 編輯明細項目資訊
- [ ] 刪除明細項目（級聯刪除月度記錄）
- [ ] 調整明細項目排序
- [ ] 每個項目獨立設定 OpCo 歸屬
- [ ] 每個項目獨立設定預算金額
- [ ] 每個項目獨立設定合約結束日期

#### FR-03: 月度記錄管理
- [ ] 每個明細項目獨立管理 12 個月度記錄
- [ ] 批量更新月度實際金額
- [ ] 自動計算項目實際支出總額
- [ ] 自動更新表頭匯總數據

#### FR-04: O&M Summary 整合
- [ ] Summary 頁面顯示明細項目層級數據
- [ ] 支援按表頭/明細/OpCo 多層級分組
- [ ] 保持現有 Category → OpCo → Items 結構

#### FR-05: 數據遷移
- [ ] 提供遷移腳本將現有數據轉換為新結構
- [ ] 確保遷移過程不丟失數據
- [ ] 支援回滾機制

### 2.3 非功能需求

| 需求類型 | 描述 | 驗收標準 |
|---------|------|---------|
| **性能** | 頁面載入時間 | Summary 頁面 < 3 秒（100 條記錄） |
| **可用性** | 表單操作 | 新增/編輯明細項目無需刷新頁面 |
| **可維護性** | 代碼品質 | TypeScript 嚴格模式，ESLint 無錯誤 |
| **向後兼容** | API 兼容 | 遷移期間舊 API 仍可用 |

---

## 3. 驗收標準

### 3.1 功能驗收

| 編號 | 驗收項目 | 驗收標準 | 測試方法 |
|------|---------|---------|---------|
| AC-01 | 建立帶明細的 OM 費用 | 用戶可以建立 OM 費用並添加 1-N 個明細項目 | 手動測試 |
| AC-02 | 編輯明細項目 | 用戶可以編輯任意明細項目的資訊 | 手動測試 |
| AC-03 | 刪除明細項目 | 刪除明細項目後，對應月度記錄自動刪除 | 手動測試 |
| AC-04 | 月度記錄管理 | 每個明細項目可獨立管理 12 個月的實際金額 | 手動測試 |
| AC-05 | 匯總計算 | 表頭的總預算和總實際自動計算自明細項目 | 自動測試 |
| AC-06 | Summary 頁面 | O&M Summary 正確顯示明細項目層級數據 | 手動測試 |
| AC-07 | 數據遷移 | 現有數據成功遷移，無數據丟失 | 遷移驗證腳本 |

### 3.2 技術驗收

| 編號 | 驗收項目 | 驗收標準 |
|------|---------|---------|
| TC-01 | Schema 遷移 | Prisma migration 成功執行，無錯誤 |
| TC-02 | API 測試 | 所有 API endpoints 測試通過 |
| TC-03 | TypeScript | `pnpm typecheck` 無錯誤 |
| TC-04 | ESLint | `pnpm lint` 無錯誤 |
| TC-05 | 構建 | `pnpm build` 成功 |

### 3.3 用戶體驗驗收

| 編號 | 驗收項目 | 驗收標準 |
|------|---------|---------|
| UX-01 | 表單體驗 | 添加明細項目無需刷新頁面 |
| UX-02 | 錯誤處理 | 操作失敗時顯示清晰的錯誤訊息 |
| UX-03 | 載入狀態 | 所有異步操作顯示載入指示器 |
| UX-04 | I18N | 所有新 UI 元素支援中英文切換 |

---

## 4. 影響範圍分析

### 4.1 受影響的系統模組

| 模組 | 檔案數 | 影響程度 | 說明 |
|------|--------|---------|------|
| Prisma Schema | 1 | 🔴 重大 | 新增 OMExpenseItem 模型 |
| API Router | 1 | 🔴 重大 | 重構所有 procedures |
| 前端組件 | 12 | 🟡 中等 | 組件邏輯調整 |
| 頁面 | 9 | 🟡 中等 | 頁面結構調整 |
| I18N | 2 | 🟢 輕微 | 新增翻譯鍵值 |
| **總計** | **25** | | |

### 4.2 風險評估

| 風險 | 可能性 | 影響 | 緩解措施 |
|------|--------|------|---------|
| 數據遷移失敗 | 中 | 高 | 完整備份、遷移腳本測試、回滾計劃 |
| API 向後兼容性問題 | 中 | 中 | 漸進式遷移、保留舊 API 一段時間 |
| 前端功能回歸 | 中 | 中 | 完整測試覆蓋、逐步部署 |
| 性能下降 | 低 | 中 | 性能測試、索引優化 |

---

## 5. 相關文檔

### 5.1 本功能文檔
- [02-technical-design.md](./02-technical-design.md) - 技術設計
- [03-implementation-plan.md](./03-implementation-plan.md) - 實施計劃
- [04-progress.md](./04-progress.md) - 進度追蹤

### 5.2 相關現有功能
- [FEAT-003: O&M Summary Page](../FEAT-003-om-summary-page/) - O&M 摘要頁面
- [FEAT-004: Operating Company Management](../FEAT-004-operating-company-management/) - OpCo 管理
- [FEAT-005: OM Expense Category Management](../FEAT-005-om-expense-category-management/) - 費用類別管理

### 5.3 參考資料
- Excel 工作表：`it-budget-project-management-portal-current-omexpense-worksheet-screen-1.png`
- 現有 Schema：`packages/db/prisma/schema.prisma`
- 現有 API Router：`packages/api/src/routers/omExpense.ts`

---

**文檔版本**: 1.0
**最後更新**: 2025-12-05
**作者**: Claude AI Assistant
