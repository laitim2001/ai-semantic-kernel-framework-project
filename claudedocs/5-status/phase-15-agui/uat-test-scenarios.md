# Phase 15 AG-UI UAT 測試場景

## Feature 1: Agentic Chat (P0)

### 場景 1.1: 基本對話發送

| 項目 | 內容 |
|------|------|
| **ID** | TC-1.1 |
| **前置條件** | Demo 頁面已載入，SSE 連接已建立 |
| **步驟** | 1. 在輸入框輸入 "Hello, how are you?"<br>2. 點擊發送按鈕或按 Enter |
| **預期結果** | - 用戶訊息顯示在對話區域右側<br>- 顯示串流指示器<br>- 收到 AI 回應顯示在左側 |
| **驗證點** | `[data-testid="user-message"]`, `[data-testid="assistant-message"]` |

### 場景 1.2: 串流響應顯示

| 項目 | 內容 |
|------|------|
| **ID** | TC-1.2 |
| **前置條件** | 已發送訊息，等待 AI 回應 |
| **步驟** | 1. 觀察 AI 回應區域<br>2. 監控 Network 中的 SSE 事件 |
| **預期結果** | - 文字逐步出現（打字效果）<br>- 收到 `TEXT_MESSAGE_START` → `TEXT_MESSAGE_CONTENT` (多個) → `TEXT_MESSAGE_END` |
| **驗證點** | 串流內容增量更新，無跳躍 |

### 場景 1.3: 工具調用內嵌顯示

| 項目 | 內容 |
|------|------|
| **ID** | TC-1.3 |
| **前置條件** | AI 執行了工具調用 |
| **步驟** | 1. 發送需要工具的訊息 (例如 "Calculate 25 * 4")<br>2. 觀察工具調用卡片 |
| **預期結果** | - 工具調用卡片內嵌在對話中<br>- 顯示工具名稱和參數<br>- 顯示執行結果 |
| **驗證點** | `[data-testid="tool-call-card"]` 可見 |

### 場景 1.4: 連接斷開重連

| 項目 | 內容 |
|------|------|
| **ID** | TC-1.4 |
| **前置條件** | SSE 連接正常 |
| **步驟** | 1. 停止後端服務 3 秒<br>2. 重新啟動後端服務<br>3. 觀察前端行為 |
| **預期結果** | - 顯示連接斷開提示<br>- 自動嘗試重連<br>- 重連成功後恢復正常 |
| **驗證點** | 連接狀態指示器變化 |

### 場景 1.5: 錯誤處理

| 項目 | 內容 |
|------|------|
| **ID** | TC-1.5 |
| **前置條件** | Demo 頁面已載入 |
| **步驟** | 1. 發送會觸發錯誤的訊息<br>2. 觀察錯誤顯示 |
| **預期結果** | - 錯誤訊息以紅色樣式顯示<br>- 不阻塞後續操作 |
| **驗證點** | `[data-testid="error-message"]` 可見 |

---

## Feature 2: Tool Rendering (P0)

### 場景 2.1: 代碼結果渲染

| 項目 | 內容 |
|------|------|
| **ID** | TC-2.1 |
| **前置條件** | 工具返回代碼類型結果 |
| **步驟** | 1. 觸發返回代碼的工具<br>2. 觀察結果渲染 |
| **預期結果** | - 代碼塊有語法高亮<br>- 顯示語言標籤<br>- 有複製按鈕 |
| **驗證點** | `<pre><code class="language-*">` |

### 場景 2.2: JSON 結果渲染

| 項目 | 內容 |
|------|------|
| **ID** | TC-2.2 |
| **前置條件** | 工具返回 JSON 結果 |
| **步驟** | 1. 觸發返回 JSON 的工具<br>2. 觀察結果渲染 |
| **預期結果** | - JSON 格式化顯示<br>- 可展開/收合<br>- Key-Value 有顏色區分 |
| **驗證點** | 格式化的 JSON 樹狀結構 |

### 場景 2.3: 表格結果渲染

| 項目 | 內容 |
|------|------|
| **ID** | TC-2.3 |
| **前置條件** | 工具返回表格數據 |
| **步驟** | 1. 觸發返回表格的工具<br>2. 觀察結果渲染 |
| **預期結果** | - 使用 DynamicTable 組件<br>- 支援排序和分頁 |
| **驗證點** | 表格標題列和數據行 |

### 場景 2.4: 錯誤結果渲染

| 項目 | 內容 |
|------|------|
| **ID** | TC-2.4 |
| **前置條件** | 工具執行失敗 |
| **步驟** | 1. 觸發會失敗的工具<br>2. 觀察錯誤渲染 |
| **預期結果** | - 紅色邊框/背景<br>- 顯示錯誤訊息<br>- 顯示錯誤類型 |
| **驗證點** | 錯誤樣式和訊息可見 |

---

## Feature 3: Human-in-the-Loop (P0)

### 場景 3.1: 審批對話框觸發

| 項目 | 內容 |
|------|------|
| **ID** | TC-3.1 |
| **前置條件** | 配置高風險工具 |
| **步驟** | 1. 觸發高風險工具調用<br>2. 觀察審批對話框 |
| **預期結果** | - 對話框彈出<br>- 顯示工具名稱和參數<br>- 顯示風險等級 (HIGH/CRITICAL) |
| **驗證點** | `[data-testid="approval-dialog"]` |

### 場景 3.2: 批准工具調用

| 項目 | 內容 |
|------|------|
| **ID** | TC-3.2 |
| **前置條件** | 審批對話框已顯示 |
| **步驟** | 1. 點擊「批准」按鈕<br>2. 觀察後續執行 |
| **預期結果** | - 對話框關閉<br>- 工具繼續執行<br>- 顯示執行結果 |
| **驗證點** | `POST /api/v1/ag-ui/approvals/{id}/approve` 成功 |

### 場景 3.3: 拒絕工具調用

| 項目 | 內容 |
|------|------|
| **ID** | TC-3.3 |
| **前置條件** | 審批對話框已顯示 |
| **步驟** | 1. 輸入拒絕原因<br>2. 點擊「拒絕」按鈕 |
| **預期結果** | - 對話框關閉<br>- 工具不執行<br>- 顯示拒絕訊息 |
| **驗證點** | `POST /api/v1/ag-ui/approvals/{id}/reject` 成功 |

### 場景 3.4: 審批超時處理

| 項目 | 內容 |
|------|------|
| **ID** | TC-3.4 |
| **前置條件** | 審批對話框已顯示 |
| **步驟** | 1. 等待超時 (默認 5 分鐘，測試可縮短)<br>2. 觀察超時行為 |
| **預期結果** | - 對話框顯示超時倒計時<br>- 超時後自動關閉<br>- 工具調用被取消 |
| **驗證點** | 超時狀態變化 |

### 場景 3.5: 待審批列表

| 項目 | 內容 |
|------|------|
| **ID** | TC-3.5 |
| **前置條件** | 有多個待審批項目 |
| **步驟** | 1. 查看待審批列表<br>2. 選擇一個項目處理 |
| **預期結果** | - 列表顯示所有待審批<br>- 可以批量操作 |
| **驗證點** | `GET /api/v1/ag-ui/approvals/pending` 返回列表 |

---

## Feature 4: Generative UI (P1)

### 場景 4.1: 進度指示器

| 項目 | 內容 |
|------|------|
| **ID** | TC-4.1 |
| **前置條件** | 執行長時間工作流 |
| **步驟** | 1. 觸發多步驟工作流<br>2. 觀察進度顯示 |
| **預期結果** | - 顯示當前步驟<br>- 顯示進度百分比<br>- 動畫流暢 |
| **驗證點** | `CUSTOM(workflow_progress)` 事件 |

### 場景 4.2: 模式切換動畫

| 項目 | 內容 |
|------|------|
| **ID** | TC-4.2 |
| **前置條件** | 正在執行 Workflow 模式 |
| **步驟** | 1. 觸發模式切換 (Workflow → Chat)<br>2. 觀察切換動畫 |
| **預期結果** | - 顯示切換通知<br>- UI 平滑過渡 |
| **驗證點** | `CUSTOM(mode_switch)` 事件 |

### 場景 4.3: 加載狀態

| 項目 | 內容 |
|------|------|
| **ID** | TC-4.3 |
| **前置條件** | 等待 AI 響應 |
| **步驟** | 1. 發送訊息<br>2. 觀察加載狀態 |
| **預期結果** | - 顯示加載動畫<br>- 禁用輸入框<br>- 顯示取消按鈕 |
| **驗證點** | 加載指示器可見 |

---

## Feature 5: Tool-based UI (P1)

### 場景 5.1: 動態表單渲染

| 項目 | 內容 |
|------|------|
| **ID** | TC-5.1 |
| **前置條件** | 工具返回表單定義 |
| **步驟** | 1. 觸發返回表單的工具<br>2. 填寫表單<br>3. 提交表單 |
| **預期結果** | - 表單正確渲染所有欄位<br>- 驗證規則生效<br>- 提交後觸發事件 |
| **驗證點** | DynamicForm 渲染和 onSubmit 回調 |

### 場景 5.2: 表單驗證

| 項目 | 內容 |
|------|------|
| **ID** | TC-5.2 |
| **前置條件** | 動態表單已渲染 |
| **步驟** | 1. 留空必填欄位<br>2. 輸入無效格式<br>3. 嘗試提交 |
| **預期結果** | - 顯示驗證錯誤<br>- 阻止提交<br>- 錯誤欄位高亮 |
| **驗證點** | 錯誤訊息顯示 |

### 場景 5.3: 圖表渲染

| 項目 | 內容 |
|------|------|
| **ID** | TC-5.3 |
| **前置條件** | 工具返回圖表數據 |
| **步驟** | 1. 觸發返回圖表的工具<br>2. 觀察圖表渲染 |
| **預期結果** | - 正確渲染圖表類型<br>- 數據點正確<br>- 可交互 (hover 提示) |
| **驗證點** | DynamicChart SVG 元素 |

### 場景 5.4: 表格排序和分頁

| 項目 | 內容 |
|------|------|
| **ID** | TC-5.4 |
| **前置條件** | 動態表格已渲染 |
| **步驟** | 1. 點擊列標題排序<br>2. 切換分頁 |
| **預期結果** | - 數據正確排序<br>- 分頁正確切換<br>- 顯示總數 |
| **驗證點** | 排序圖標和分頁控制 |

### 場景 5.5: 卡片渲染

| 項目 | 內容 |
|------|------|
| **ID** | TC-5.5 |
| **前置條件** | 工具返回卡片定義 |
| **步驟** | 1. 觸發返回卡片的工具<br>2. 點擊卡片按鈕 |
| **預期結果** | - 卡片正確渲染<br>- 按鈕可點擊<br>- 觸發正確事件 |
| **驗證點** | DynamicCard 和按鈕回調 |

### 場景 5.6: 自定義組件

| 項目 | 內容 |
|------|------|
| **ID** | TC-5.6 |
| **前置條件** | 工具返回自定義組件定義 |
| **步驟** | 1. 觸發返回自定義組件的工具<br>2. 與組件互動 |
| **預期結果** | - CustomUIRenderer 正確渲染<br>- 事件正確傳遞 |
| **驗證點** | 自定義組件渲染 |

---

## Feature 6: Shared State (P1)

### 場景 6.1: 狀態同步到服務器

| 項目 | 內容 |
|------|------|
| **ID** | TC-6.1 |
| **前置條件** | 前端已連接，有共享狀態 |
| **步驟** | 1. 在前端修改狀態<br>2. 觀察服務器接收 |
| **預期結果** | - 狀態變更發送到服務器<br>- 版本號遞增<br>- 延遲 < 100ms |
| **驗證點** | `PATCH /api/v1/ag-ui/threads/{id}/state` |

### 場景 6.2: 從服務器接收狀態

| 項目 | 內容 |
|------|------|
| **ID** | TC-6.2 |
| **前置條件** | 服務器有狀態更新 |
| **步驟** | 1. 服務器發送狀態更新<br>2. 觀察前端接收 |
| **預期結果** | - 前端收到 `STATE_SNAPSHOT` 或 `STATE_DELTA`<br>- UI 自動更新 |
| **驗證點** | SSE 事件和 UI 更新 |

### 場景 6.3: 增量更新 (Delta)

| 項目 | 內容 |
|------|------|
| **ID** | TC-6.3 |
| **前置條件** | 狀態已初始化 |
| **步驟** | 1. 修改狀態的部分欄位<br>2. 觀察發送的數據 |
| **預期結果** | - 只發送變更部分 (diff)<br>- 路徑正確 |
| **驗證點** | `STATE_DELTA` 事件內容 |

### 場景 6.4: 衝突檢測

| 項目 | 內容 |
|------|------|
| **ID** | TC-6.4 |
| **前置條件** | 兩個客戶端同時修改 |
| **步驟** | 1. 客戶端 A 修改欄位<br>2. 客戶端 B 同時修改同一欄位<br>3. 觀察衝突處理 |
| **預期結果** | - 檢測到衝突<br>- 根據策略解決 (server_wins 默認)<br>- 顯示衝突通知 |
| **驗證點** | 409 Conflict 或衝突事件 |

### 場景 6.5: 離線支持

| 項目 | 內容 |
|------|------|
| **ID** | TC-6.5 |
| **前置條件** | 有本地緩存 |
| **步驟** | 1. 斷開網絡<br>2. 修改狀態<br>3. 恢復網絡 |
| **預期結果** | - 離線時使用本地緩存<br>- 恢復後同步 |
| **驗證點** | localStorage 和重連同步 |

---

## Feature 7: Predictive State (P2)

### 場景 7.1: 樂觀更新顯示

| 項目 | 內容 |
|------|------|
| **ID** | TC-7.1 |
| **前置條件** | 使用 useOptimisticState |
| **步驟** | 1. 觸發樂觀更新<br>2. 觀察 UI 變化 |
| **預期結果** | - UI 立即更新<br>- 顯示待確認指示器 |
| **驗證點** | OptimisticIndicator 顯示 pending |

### 場景 7.2: 確認預測

| 項目 | 內容 |
|------|------|
| **ID** | TC-7.2 |
| **前置條件** | 有待確認的預測 |
| **步驟** | 1. 服務器確認操作成功<br>2. 觀察確認動畫 |
| **預期結果** | - 預測狀態變為 confirmed<br>- UI 保持更新狀態 |
| **驗證點** | 確認回調執行 |

### 場景 7.3: 回滾預測

| 項目 | 內容 |
|------|------|
| **ID** | TC-7.3 |
| **前置條件** | 有待確認的預測 |
| **步驟** | 1. 服務器返回失敗<br>2. 觀察回滾動畫 |
| **預期結果** | - 預測狀態變為 rolled_back<br>- UI 恢復原狀態<br>- 顯示回滾原因 |
| **驗證點** | 回滾動畫和狀態恢復 |

### 場景 7.4: 超時處理

| 項目 | 內容 |
|------|------|
| **ID** | TC-7.4 |
| **前置條件** | 有待確認的預測 |
| **步驟** | 1. 等待預測超時 (默認 5 秒)<br>2. 觀察超時處理 |
| **預期結果** | - 預測狀態變為 expired<br>- 自動回滾 |
| **驗證點** | 超時後狀態變化 |

---

## 整合測試場景

### 場景 INT-1: 完整對話流程

| 項目 | 內容 |
|------|------|
| **ID** | TC-INT-1 |
| **步驟** | 1. 發送訊息<br>2. 收到 AI 回應 (串流)<br>3. 觸發工具調用<br>4. 處理審批 (如需要)<br>5. 收到最終結果 |
| **預期結果** | 完整流程無錯誤 |

### 場景 INT-2: 多功能組合

| 項目 | 內容 |
|------|------|
| **ID** | TC-INT-2 |
| **步驟** | 1. 對話中觸發動態表單<br>2. 填寫表單並提交<br>3. 結果更新共享狀態<br>4. 另一端收到狀態更新 |
| **預期結果** | 功能間協作正常 |

### 場景 INT-3: 錯誤恢復

| 項目 | 內容 |
|------|------|
| **ID** | TC-INT-3 |
| **步驟** | 1. 在對話中途中斷連接<br>2. 重新連接<br>3. 繼續對話 |
| **預期結果** | 對話狀態恢復，可繼續 |
