# 🔄 情況11: 功能修改/更新 - 修改現有功能

> **使用時機**: 需要修改、更新或重構現有功能時
> **目標**: 安全地修改現有代碼，保持系統穩定
> **適用場景**: 功能增強、API 更新、重構、性能優化

---

## 📋 Prompt 模板 (給開發人員)

```markdown
你好！我需要修改現有功能。

**修改範圍**:
- 功能名稱: [要修改的功能]
- 相關文件: [已知的相關文件路徑]

**修改需求**:
- [需求 1]
- [需求 2]

**注意事項** (如有):
- [向後兼容性要求]
- [不能破壞的現有行為]

請幫我：

1. 理解現有實作
   - 閱讀相關代碼
   - 了解現有邏輯和依賴關係

2. 制定修改計劃
   - 評估影響範圍
   - 識別潛在風險

3. 執行修改
   - 按計劃修改代碼
   - 確保向後兼容

4. 驗證修改
   - 運行相關測試
   - 確認沒有破壞現有功能

請用中文回答。
```

---

## 🤖 AI 助手執行步驟

### Step 1: 理解現有實作 (3 分鐘)

```bash
# 1. 定位相關文件
Grep: "[功能關鍵字]" backend/src/
Glob: backend/src/**/*[相關名稱]*.py

# 2. 閱讀核心代碼
Read: [主要實作文件]
Read: [相關的 service/repository 文件]

# 3. 了解依賴關係
Grep: "from.*import.*[功能類名]" backend/src/
Grep: "import.*[功能模組]" backend/src/

# 4. 查看現有測試
Glob: backend/tests/**/*[功能名稱]*.py
Read: [測試文件]
```

### Step 2: 分析影響範圍 (2 分鐘)

```markdown
# 📊 影響範圍分析

## 直接影響的文件
| 文件 | 類型 | 修改內容 |
|------|------|----------|
| `path/to/file.py` | Service | [需要修改的部分] |
| `path/to/api.py` | API | [需要修改的部分] |

## 間接影響的文件
- `other/file.py` - 依賴此功能的文件

## 相關測試
- `tests/unit/test_xxx.py` - 需要更新的測試

## 風險評估
- 🟢 低風險: [安全的修改]
- 🟡 中風險: [需要注意的修改]
- 🔴 高風險: [可能破壞的部分]
```

### Step 3: 制定修改計劃 (2 分鐘)

```markdown
# 📋 修改計劃

## 修改順序
1. [ ] 先修改底層 (domain/infrastructure)
2. [ ] 再修改 API 層
3. [ ] 最後更新測試

## 向後兼容策略
- [如何保持舊 API 可用]
- [是否需要版本標記]

## 回滾計劃
- 保存修改前的版本
- 準備回滾命令
```

### Step 4: 執行修改 (主要時間)

```bash
# 1. 創建備份點
Bash: git status
Bash: git add . && git commit -m "chore: checkpoint before feature update"

# 2. 修改代碼
Edit: [文件路徑] - 按計劃修改

# 3. 更新相關文件
Edit: [其他需要修改的文件]

# 4. 更新測試
Edit: [測試文件] - 添加/修改測試案例
```

### Step 5: 驗證修改 (3 分鐘)

```bash
# 1. 運行相關測試
Bash: cd backend && pytest tests/unit/[相關測試目錄]/ -v --tb=short

# 2. 運行整合測試 (如有)
Bash: cd backend && pytest tests/integration/[相關測試]/ -v --tb=short

# 3. 檢查類型
Bash: cd backend && mypy [修改的文件]

# 4. 檢查代碼風格
Bash: cd backend && flake8 [修改的文件]

# 5. 確認沒有回歸
Bash: cd backend && pytest tests/unit/ -v --tb=short -x
```

### Step 6: 生成修改報告 (1 分鐘)

```markdown
# 🔄 功能修改報告

## 修改摘要
- **功能**: [功能名稱]
- **修改類型**: 增強 / 重構 / 優化 / API 更新
- **影響範圍**: [低/中/高]

## 變更內容
| 文件 | 變更類型 | 說明 |
|------|----------|------|
| `file1.py` | 修改 | [說明] |
| `file2.py` | 新增 | [說明] |

## 測試結果
- 單元測試: ✅ X 個通過
- 整合測試: ✅ X 個通過
- 類型檢查: ✅ 通過
- 代碼風格: ✅ 通過

## 向後兼容性
- [x] 舊 API 仍可使用
- [x] 舊行為保持不變
- [ ] 需要遷移: [遷移說明]

## 注意事項
- [需要關注的點]
- [後續可能的改進]
```

---

## 📋 修改類型指引

### 功能增強 (Enhancement)
- 保持現有 API 不變
- 添加新參數時使用默認值
- 擴展而非修改

### API 更新 (API Update)
- 考慮版本化 (v1 → v2)
- 提供遷移期
- 更新 API 文檔

### 重構 (Refactoring)
- 確保行為不變
- 分小步驟進行
- 每步都運行測試

### 性能優化 (Optimization)
- 先測量，後優化
- 保持接口不變
- 添加性能測試

---

## ⚠️ 常見陷阱

### 避免這些錯誤
1. **不先理解現有代碼就修改**
   - 先 Read，後 Edit

2. **修改範圍過大**
   - 分批次修改
   - 每次修改後運行測試

3. **忽略邊界情況**
   - 檢查現有測試覆蓋的場景
   - 思考新修改對邊界情況的影響

4. **破壞向後兼容**
   - 舊的調用方式應該仍然工作
   - 使用默認參數而非必填參數

---

## ✅ 驗收標準

AI 助手完成修改後應確認：

1. **理解充分**
   - 已閱讀相關代碼
   - 了解依賴關係

2. **計劃完整**
   - 影響範圍已分析
   - 修改順序已規劃

3. **修改安全**
   - 所有測試通過
   - 向後兼容性保持

4. **文檔更新**
   - 修改報告完整
   - 相關文檔已更新 (如需要)

---

## 🔗 相關文檔

### 開發流程指引
- [情況3: Bug 修復](./SITUATION-3-BUG-FIX.md) - 修復錯誤時使用
- [情況4: 功能開發](./SITUATION-4-FEATURE-DEVELOPMENT.md) - 全新功能時使用
- [情況5: 測試執行](./SITUATION-5-TESTING.md) - 運行測試
- [情況8: 代碼審查](./SITUATION-8-CODE-REVIEW.md) - 修改後審查

### 品質規範
- `.claude/rules/code-quality.md` - 代碼品質規則
- `.claude/rules/testing.md` - 測試規則

---

**維護者**: AI 助手 + 開發團隊
**最後更新**: 2025-12-24
**版本**: 1.0
