# 整合場景設計：企業級關鍵系統故障響應

## Enterprise Critical System Outage Response

**建立日期**: 2025-12-20
**版本**: 1.0
**功能編號來源**: `claudedocs/uat/FEATURE-INDEX.md` (權威來源)

---

## 一、場景概述

### 1.1 場景背景

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│       🚨 企業級 SaaS 平台關鍵系統故障響應場景                                │
│          (Enterprise Critical System Outage Response)                       │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  觸發事件：                                                          │   │
│  │  生產環境資料庫主節點故障，導致多個服務中斷，                          │   │
│  │  影響 IT 運維、客戶服務、財務交易、營運流程等多個部門                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  受影響部門：                                                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐                    │
│  │ IT 運維  │  │ 客戶服務 │  │ 財務部門 │  │ 營運團隊 │                    │
│  │ (Primary)│  │ (CS)     │  │ (Finance)│  │ (Ops)    │                    │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 場景價值

| 維度 | 說明 |
|-----|------|
| **真實性** | 企業系統故障是最常見的高複雜度事件，涉及多部門、多系統、緊急決策 |
| **複雜度** | 自然地需要 32 個功能協同工作，而非人為拼湊 |
| **可驗證性** | 每個階段都有明確的輸入輸出，可以驗證功能是否正常運作 |
| **業務價值** | 展示 IPA 平台如何處理企業級緊急事件，對客戶有說服力 |

### 1.3 測試整合來源

此場景整合了以下 4 個測試類別的所有功能：

| 類別 | 來源測試 | 主要功能 |
|-----|---------|---------|
| Category A | IT Ticket Lifecycle | 完整工單生命週期 |
| Category B | Concurrent Batch Processing | 並行執行、分支管理 |
| Category C | Advanced Workflow | 子工作流、遞迴分析 |
| Category D | Planning & Cross-Scenario | 跨場景協作、自主決策 |

---

## 二、完整流程設計 (12 階段)

### 階段 1: 事件觸發與多源工單接收

```
╔═══════════════════════════════════════════════════════════════════════════╗
║ 階段 1: 事件觸發與多源工單接收                                              ║
║ ─────────────────────────────────────────────────────────────────────────  ║
║                                                                            ║
║   [監控系統]        [客服熱線]        [財務系統]        [營運系統]          ║
║       │                 │                 │                 │              ║
║       ▼                 ▼                 ▼                 ▼              ║
║   ┌────────┐       ┌────────┐        ┌────────┐        ┌────────┐         ║
║   │IT-001  │       │CS-001  │        │FIN-001 │        │OPS-001 │         ║
║   │DB故障  │       │客戶投訴│        │交易失敗│        │流程中斷│         ║
║   └────────┘       └────────┘        └────────┘        └────────┘         ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

**使用功能 (FEATURE-INDEX.md 編號)**:
- #1 順序式 Agent 編排 - Workflow API 觸發執行
- #15 Concurrent 並行執行 - 並行接收 4 張工單
- #14 Redis 緩存 - 初始化快取統計基準線

---

### 階段 2: 智慧分類 + 任務分解 + 關聯識別

```
╔═══════════════════════════════════════════════════════════════════════════╗
║ 階段 2: 智慧分類 + 任務分解 + 關聯識別                                      ║
║ ─────────────────────────────────────────────────────────────────────────  ║
║                                                                            ║
║   ┌─────────────────────────────────────────────────────────────────┐     ║
║   │                    🤖 分類 Agent (真實 LLM)                       │     ║
║   │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │     ║
║   │  │ 分類     │  │ 優先級   │  │ 關聯分析 │  │ 任務分解 │        │     ║
║   │  │ IT故障   │  │ P0緊急   │  │ 4票相關  │  │ 5子任務  │        │     ║
║   │  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │     ║
║   └─────────────────────────────────────────────────────────────────┘     ║
║                                                                            ║
║   識別結果: 所有 4 張工單均與同一根因相關 → 建立關聯群組                    ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

**使用功能 (FEATURE-INDEX.md 編號)**:
- #22 Dynamic Planning 動態規劃 - 複雜任務自動分解
- #34 Planning Adapter - 生成執行計劃步驟
- #15 Concurrent 並行執行 - 並行分類 4 張工單
- #14 Redis 緩存 - 快取分類結果避免重複 LLM 呼叫

---

### 階段 3: 跨場景路由 + 建立關聯追蹤鏈

```
╔═══════════════════════════════════════════════════════════════════════════╗
║ 階段 3: 跨場景路由 + 建立關聯追蹤鏈                                         ║
║ ─────────────────────────────────────────────────────────────────────────  ║
║                                                                            ║
║        IT-001 ──────► Routing ──────► IT Operations 場景                   ║
║            ↓           Engine            ↓                                 ║
║        CS-001 ───────────┼──────► Customer Service 場景                    ║
║            ↓             │              ↓                                  ║
║        FIN-001 ──────────┼──────► Finance 場景                             ║
║            ↓             │              ↓                                  ║
║        OPS-001 ──────────┴──────► Operations 場景                          ║
║                                                                            ║
║   建立關聯: IT-001 ⇄ CS-001 ⇄ FIN-001 ⇄ OPS-001 (雙向關聯)                 ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

**使用功能 (FEATURE-INDEX.md 編號)**:
- #4 跨場景協作 (CS↔IT) - 建立跨部門協作通道
- #43 智能路由 - ScenarioRouter 路由決策
- #30 Capability Matcher - 能力匹配選擇最佳處理場景
- #47 Agent 能力匹配器 - 匹配專業 Agent 處理

---

### 階段 4: 並行分支處理 (Fan-out)

```
╔═══════════════════════════════════════════════════════════════════════════╗
║ 階段 4: 並行分支處理 (Fan-out)                                              ║
║ ─────────────────────────────────────────────────────────────────────────  ║
║                                                                            ║
║                          ┌──────────────────┐                              ║
║                          │   Master Ticket  │                              ║
║                          │     IT-001       │                              ║
║                          └────────┬─────────┘                              ║
║                                   │                                        ║
║              ┌────────────────────┼────────────────────┐                   ║
║              │                    │                    │                   ║
║              ▼                    ▼                    ▼                   ║
║       ┌────────────┐      ┌────────────┐      ┌────────────┐              ║
║       │ 分支 1     │      │ 分支 2     │      │ 分支 3     │              ║
║       │ 技術診斷   │      │ 客戶通知   │      │ 業務補救   │              ║
║       │ (IT Team)  │      │ (CS Team)  │      │ (Ops Team) │              ║
║       └────────────┘      └────────────┘      └────────────┘              ║
║            ↓                   ↓                    ↓                      ║
║       [並行執行中...]     [並行執行中...]      [並行執行中...]              ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

**使用功能 (FEATURE-INDEX.md 編號)**:
- #15 Concurrent 並行執行 - 三分支同時處理
- #25 Nested Workflows 嵌套工作流 - 分支作為子工作流
- #31 Context Transfer - 上下文在分支間傳遞
- Category B: B-2 Parallel branch management - 分支管理
- Category B: B-3 Fan-out/Fan-in pattern - 扇出模式
- Category B: B-6 Nested workflow context - 嵌套上下文

---

### 階段 5: 遞迴根因分析 (5 Whys)

```
╔═══════════════════════════════════════════════════════════════════════════╗
║ 階段 5: 遞迴根因分析 (5 Whys)                                               ║
║ ─────────────────────────────────────────────────────────────────────────  ║
║                                                                            ║
║   問題: 資料庫主節點無響應                                                  ║
║   │                                                                        ║
║   └─► Why 1: 為什麼無響應？                                                ║
║        → 連接池耗盡                                                        ║
║        │                                                                   ║
║        └─► Why 2: 為什麼連接池耗盡？                                       ║
║             → 大量慢查詢佔用連接                                           ║
║             │                                                              ║
║             └─► Why 3: 為什麼有大量慢查詢？                                ║
║                  → 索引失效                                                ║
║                  │                                                         ║
║                  └─► Why 4: 為什麼索引失效？                               ║
║                       → 昨晚資料遷移後未重建                               ║
║                       │                                                    ║
║                       └─► Why 5: 為什麼未重建？ 🎯 ROOT CAUSE              ║
║                            → 遷移腳本缺少重建步驟                          ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

**使用功能 (FEATURE-INDEX.md 編號)**:
- #27 Recursive Patterns - 遞迴執行 5 Whys 分析
- #20 Multi-turn 多輪對話 - 多輪收集診斷資訊
- #21 Conversation Memory - 保持對話上下文
- 真實 LLM 呼叫 - Azure OpenAI 進行智慧分析

---

### 階段 6: 自主決策 + 試錯修復

```
╔═══════════════════════════════════════════════════════════════════════════╗
║ 階段 6: 自主決策 + 試錯修復                                                 ║
║ ─────────────────────────────────────────────────────────────────────────  ║
║                                                                            ║
║   ┌──────────────────────────────────────────────────────────────────┐    ║
║   │                      🤖 Decision Agent                            │    ║
║   │  ┌───────────────────────────────────────────────────────────┐   │    ║
║   │  │ 自主決策: 嘗試重建索引                                      │   │    ║
║   │  │ 風險評估: 中等 (生產環境，但有監控)                         │   │    ║
║   │  │ 決定: 自動執行 (符合自主決策閾值)                           │   │    ║
║   │  └───────────────────────────────────────────────────────────┘   │    ║
║   └──────────────────────────────────────────────────────────────────┘    ║
║                                                                            ║
║   Trial 1: REINDEX CONCURRENTLY → 失敗 (鎖競爭)                            ║
║   Trial 2: 切換到備用節點 + REINDEX → 成功 ✅                              ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

**使用功能 (FEATURE-INDEX.md 編號)**:
- #23 Autonomous Decision - 自主決策引擎評估風險並決定
- #24 Trial-and-Error 試錯 - 嘗試多種修復方案
- Category B: B-4 Branch timeout handling - 執行超時處理
- Category B: B-5 Error isolation in branches - 錯誤隔離防擴散

---

### 階段 7: Agent 交接 (A2A Handoff)

```
╔═══════════════════════════════════════════════════════════════════════════╗
║ 階段 7: Agent 交接 (A2A Handoff)                                           ║
║ ─────────────────────────────────────────────────────────────────────────  ║
║                                                                            ║
║   ┌────────────────┐            ┌────────────────┐                        ║
║   │ Triage Agent   │ ────A2A──► │ Specialist     │                        ║
║   │ (分流 Agent)   │   Handoff  │ Agent          │                        ║
║   │                │            │ (專家 Agent)   │                        ║
║   └────────────────┘            └────────────────┘                        ║
║                                        │                                   ║
║                                        ▼                                   ║
║                               ┌────────────────┐                          ║
║                               │ Collaboration  │                          ║
║                               │ Protocol       │                          ║
║                               │ 建立協作通道   │                          ║
║                               └────────────────┘                          ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

**使用功能 (FEATURE-INDEX.md 編號)**:
- #39 Agent to Agent (A2A) - Agent 間直接通訊
- #17 Collaboration Protocol - 建立協作協議
- #19 Agent Handoff 交接 - 觸發交接流程
- #31 Context Transfer - 上下文完整傳遞
- #32 Handoff Service - 交接服務執行

---

### 階段 8: 多部門子工作流審批

```
╔═══════════════════════════════════════════════════════════════════════════╗
║ 階段 8: 多部門子工作流審批                                                  ║
║ ─────────────────────────────────────────────────────────────────────────  ║
║                                                                            ║
║                    ┌─────────────────────────────┐                        ║
║                    │   Composed Approval Flow    │                        ║
║                    │   (子工作流組合)            │                        ║
║                    └──────────────┬──────────────┘                        ║
║           ┌───────────────────────┼───────────────────────┐               ║
║           │                       │                       │               ║
║           ▼                       ▼                       ▼               ║
║   ┌───────────────┐      ┌───────────────┐      ┌───────────────┐        ║
║   │ Sub-workflow 1│      │ Sub-workflow 2│      │ Sub-workflow 3│        ║
║   │ IT Manager    │      │ CTO Approval  │      │ Ops Manager   │        ║
║   │ 審批變更      │      │ (緊急通道)    │      │ 確認影響     │        ║
║   └───────────────┘      └───────────────┘      └───────────────┘        ║
║         ↓                       ↓                       ↓                 ║
║      [⏸️ 等待]              [⏸️ 等待]              [⏸️ 等待]              ║
║         ↓                       ↓                       ↓                 ║
║      [✅ 同意]              [✅ 同意]              [✅ 同意]              ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

**使用功能 (FEATURE-INDEX.md 編號)**:
- #26 Sub-workflow Execution - 子工作流組合執行
- #2 人機協作檢查點 - 建立審批 Checkpoint
- #29 HITL Manage - 人機協作審批管理
- #49 HITL 功能擴展 - 升級機制 (超時/複雜問題)
- #35 Redis/Postgres Checkpoint - 審批狀態持久化

---

### 階段 9: GroupChat 專家會診 + 投票決策

```
╔═══════════════════════════════════════════════════════════════════════════╗
║ 階段 9: GroupChat 專家會診 + 投票決策                                       ║
║ ─────────────────────────────────────────────────────────────────────────  ║
║                                                                            ║
║   ┌─────────────────────────────────────────────────────────────────────┐ ║
║   │                        GroupChat Session                             │ ║
║   │  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐        │ ║
║   │  │ DBA    │  │ DevOps │  │ SRE    │  │ App    │  │Security│        │ ║
║   │  │ Expert │  │ Expert │  │ Expert │  │ Expert │  │ Expert │        │ ║
║   │  └────────┘  └────────┘  └────────┘  └────────┘  └────────┘        │ ║
║   │                                                                      │ ║
║   │  議題: 確認修復方案是否安全上線？                                    │ ║
║   │                                                                      │ ║
║   │  💬 多輪對話:                                                        │ ║
║   │  DBA: "索引已重建，效能恢復正常"                                     │ ║
║   │  SRE: "監控顯示所有指標綠燈"                                         │ ║
║   │  Security: "無安全漏洞引入"                                          │ ║
║   │                                                                      │ ║
║   │  🗳️ 投票結果:                                                        │ ║
║   │  DBA: 同意 | DevOps: 同意 | SRE: 同意 | App: 同意 | Security: 同意  │ ║
║   │                                                                      │ ║
║   │  結果: 5/5 同意 → 通過 ✅                                            │ ║
║   └─────────────────────────────────────────────────────────────────────┘ ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

**使用功能 (FEATURE-INDEX.md 編號)**:
- #18 GroupChat 群組聊天 - 多專家同時參與討論
- #33 GroupChat Orchestrator - 協調專家發言順序
- #20 Multi-turn 多輪對話 - 專家間多輪交流
- #21 Conversation Memory - 保持討論上下文
- #28 GroupChat 投票系統 - 發起專家投票
- #48 投票系統 - 計票與結果判定
- #50 Termination 條件 - 投票通過即終止討論

---

### 階段 10: 外部系統同步 (Fan-in 匯聚)

```
╔═══════════════════════════════════════════════════════════════════════════╗
║ 階段 10: 外部系統同步 (Fan-in 匯聚)                                         ║
║ ─────────────────────────────────────────────────────────────────────────  ║
║                                                                            ║
║   ┌────────────────────────────────────────────────────────────────────┐  ║
║   │                     External System Integration                     │  ║
║   └────────────────────────────────────────────────────────────────────┘  ║
║                                                                            ║
║       ┌──────────────┐    ┌──────────────┐    ┌──────────────┐            ║
║       │ ServiceNow   │    │ Prometheus   │    │ PagerDuty    │            ║
║       │ ↳ 更新工單   │    │ ↳ 清除告警   │    │ ↳ 結束事件   │            ║
║       │   狀態       │    │   狀態       │    │   通知       │            ║
║       └──────────────┘    └──────────────┘    └──────────────┘            ║
║              │                   │                   │                    ║
║              └───────────────────┼───────────────────┘                    ║
║                                  │                                        ║
║                                  ▼                                        ║
║                         ┌───────────────┐                                 ║
║                         │   Fan-in      │                                 ║
║                         │   匯聚所有結果 │                                 ║
║                         │   優先處理緊急 │                                 ║
║                         └───────────────┘                                 ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

**使用功能 (FEATURE-INDEX.md 編號)**:
- #3 跨系統連接器 - ServiceNow、Prometheus、PagerDuty 整合
- Category B: B-3 Fan-out/Fan-in pattern - 扇入匯聚結果
- Category C: C-4 Message prioritization - 緊急訊息優先處理

---

### 階段 11: 完成與記錄 + 快取驗證

```
╔═══════════════════════════════════════════════════════════════════════════╗
║ 階段 11: 完成與記錄 + 快取驗證                                              ║
║ ─────────────────────────────────────────────────────────────────────────  ║
║                                                                            ║
║   ┌────────────────────────────────────────────────────────────────────┐  ║
║   │                         關閉所有工單                                │  ║
║   │                                                                     │  ║
║   │   IT-001  ──► COMPLETED ✅                                         │  ║
║   │   CS-001  ──► COMPLETED ✅                                         │  ║
║   │   FIN-001 ──► COMPLETED ✅                                         │  ║
║   │   OPS-001 ──► COMPLETED ✅                                         │  ║
║   │                                                                     │  ║
║   │   📊 統計:                                                          │  ║
║   │   • 總處理時間: 45 分鐘                                             │  ║
║   │   • LLM 呼叫次數: 23                                                │  ║
║   │   • Token 使用: 15,234                                              │  ║
║   │   • 快取命中率: 67%                                                  │  ║
║   │   • 成本: $0.24                                                     │  ║
║   │                                                                     │  ║
║   │   🗑️ 快取失效測試: 清除過期快取項目                                  │  ║
║   └────────────────────────────────────────────────────────────────────┘  ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

**使用功能 (FEATURE-INDEX.md 編號)**:
- #10 審計追蹤 - 記錄完整事件處理過程
- #14 Redis 緩存 - 完整快取統計驗證

---

### 階段 12: 優雅關閉 + 事後分析

```
╔═══════════════════════════════════════════════════════════════════════════╗
║ 階段 12: 優雅關閉 + 事後分析                                                ║
║ ─────────────────────────────────────────────────────────────────────────  ║
║                                                                            ║
║   ┌────────────────────────────────────────────────────────────────────┐  ║
║   │                      Post-Incident Analysis                         │  ║
║   │                                                                     │  ║
║   │   📋 事後報告:                                                      │  ║
║   │   1. 根因: 遷移腳本缺少索引重建步驟                                 │  ║
║   │   2. 影響: 4 個部門，約 200 客戶                                    │  ║
║   │   3. 解決方案: 新增自動化索引檢查                                   │  ║
║   │   4. 預防措施: 更新遷移腳本標準                                     │  ║
║   │                                                                     │  ║
║   │   🛑 優雅關閉所有資源                                               │  ║
║   │   • 釋放所有 Agent 連接                                             │  ║
║   │   • 清理暫存資料                                                    │  ║
║   │   • 保存最終狀態到 Checkpoint                                       │  ║
║   │   • 確保無資料遺失                                                  │  ║
║   └────────────────────────────────────────────────────────────────────┘  ║
╚═══════════════════════════════════════════════════════════════════════════╝
```

**使用功能 (FEATURE-INDEX.md 編號)**:
- #35 Redis/Postgres Checkpoint - 最終狀態持久化
- #10 審計追蹤 - 事後報告記錄

---

## 三、功能對照矩陣

| 階段 | 主列表功能 (FEATURE-INDEX.md) | Category 特有功能 |
|-----|------------------------------|-------------------|
| 1. 事件觸發 | #1, #14, #15 | - |
| 2. 智慧分類 | #14, #15, #22, #34 | - |
| 3. 跨場景路由 | #4, #30, #43, #47 | - |
| 4. 並行分支 | #15, #25, #31 | B-2, B-3, B-6 |
| 5. 遞迴分析 | #20, #21, #27 | - |
| 6. 自主決策 | #23, #24 | B-4, B-5 |
| 7. Agent 交接 | #17, #19, #31, #32, #39 | - |
| 8. 審批流程 | #2, #26, #29, #35, #49 | - |
| 9. 專家會診 | #18, #20, #21, #28, #33, #48, #50 | - |
| 10. 外部同步 | #3 | B-3, C-4 |
| 11. 完成記錄 | #10, #14 | - |
| 12. 優雅關閉 | #10, #35 | - |

---

## 四、功能覆蓋統計

### 主列表已覆蓋功能 (26 個)

| 分類 | 覆蓋數 | 功能編號 |
|-----|-------|---------|
| 核心編排 | 5/7 | #1, #15, #25, #26, #27, #50 |
| 協作 | 10/10 | #17, #18, #19, #28, #31, #32, #33, #39, #48 |
| HITL | 3/3 | #2, #29, #49 |
| 規劃 | 4/4 | #22, #23, #24, #34 |
| 對話 | 2/2 | #20, #21 |
| 整合 | 2/4 | #3, #4 |
| 智能路由 | 3/3 | #30, #43, #47 |
| 效能 | 2/2 | #14, #35 |
| 監控 | 1/3 | #10 |

### Category 特有功能 (6 個)

- B-2 Parallel branch management
- B-3 Fan-out/Fan-in pattern
- B-4 Branch timeout handling
- B-5 Error isolation in branches
- B-6 Nested workflow context
- C-4 Message prioritization

### 總計

- **主列表**: 26/50 功能 (52%)
- **Category 特有**: 6/6 功能 (100%)
- **整合測試總計**: 32 個功能

---

## 五、相關文件

| 文件 | 路徑 | 用途 |
|-----|------|------|
| 功能索引 | `claudedocs/uat/FEATURE-INDEX.md` | 功能編號權威來源 |
| 功能對照 | `claudedocs/uat/UAT-FEATURE-MAPPING-V2.md` | 測試覆蓋對照 |
| 測試腳本 | `scripts/uat/integrated_scenario/` | 整合測試執行 |
| 執行提示 | `claudedocs/prompts/PROMPT-UAT-INTEGRATED-SCENARIO.md` | UAT 執行指引 |

---

**文件建立者**: Claude Code
**最後更新**: 2025-12-20
