# AlertManager Configuration for IPA Platform
# Sprint 2 - Story S2-6: Alert Manager Integration

global:
  resolve_timeout: 5m

# Route tree for alert routing
route:
  # Default receiver
  receiver: 'default-receiver'
  # Group alerts by alertname and severity
  group_by: ['alertname', 'severity']
  # Wait before sending first notification
  group_wait: 10s
  # Wait before sending updated notification
  group_interval: 10s
  # Wait before re-sending notification
  repeat_interval: 12h

  # Child routes for severity-based routing
  routes:
    # Critical alerts go to critical receiver
    - match:
        severity: critical
      receiver: 'critical-receiver'
      continue: true

    # Warning alerts go to warning receiver
    - match:
        severity: warning
      receiver: 'warning-receiver'

    # Info alerts go to default receiver
    - match:
        severity: info
      receiver: 'default-receiver'

# Receivers define where to send notifications
receivers:
  # Default receiver - webhook to IPA Platform
  - name: 'default-receiver'
    webhook_configs:
      - url: 'http://backend:8000/api/v1/alerts/webhook'
        send_resolved: true
        http_config:
          bearer_token: '${ALERTMANAGER_BEARER_TOKEN}'

  # Critical alerts receiver
  - name: 'critical-receiver'
    webhook_configs:
      - url: 'http://backend:8000/api/v1/alerts/webhook?severity=critical'
        send_resolved: true
        http_config:
          bearer_token: '${ALERTMANAGER_BEARER_TOKEN}'

  # Warning alerts receiver
  - name: 'warning-receiver'
    webhook_configs:
      - url: 'http://backend:8000/api/v1/alerts/webhook?severity=warning'
        send_resolved: true
        http_config:
          bearer_token: '${ALERTMANAGER_BEARER_TOKEN}'

# Inhibition rules to suppress certain alerts
inhibit_rules:
  # If ServiceDown is firing, suppress HighLatency for same instance
  - source_match:
      alertname: 'ServiceDown'
    target_match:
      alertname: 'HighLatency'
    equal: ['instance']

  # If critical alert is firing, suppress warning for same alertname
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']
