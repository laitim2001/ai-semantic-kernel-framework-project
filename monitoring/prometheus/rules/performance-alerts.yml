# Performance Alert Rules for IPA Platform
# Sprint 3 - Story S3-8: Performance Dashboard
#
# These rules define alerts for:
# - API latency thresholds
# - Error rate thresholds
# - Resource utilization thresholds
# - Database connection pool issues

groups:
  - name: performance_alerts
    rules:
      # ========================================
      # API Latency Alerts
      # ========================================

      - alert: HighAPILatencyP95
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 0.5
        for: 5m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "High API P95 latency detected"
          description: "API P95 latency is {{ $value | humanizeDuration }} (threshold: 500ms)"
          runbook_url: "https://docs.ipa-platform.io/runbooks/high-latency"

      - alert: CriticalAPILatencyP95
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 1
        for: 2m
        labels:
          severity: critical
          category: performance
        annotations:
          summary: "Critical API P95 latency detected"
          description: "API P95 latency is {{ $value | humanizeDuration }} (threshold: 1s)"
          runbook_url: "https://docs.ipa-platform.io/runbooks/critical-latency"

      - alert: HighAPILatencyP99
        expr: histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 2
        for: 5m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "High API P99 latency detected"
          description: "API P99 latency is {{ $value | humanizeDuration }} (threshold: 2s)"

      # ========================================
      # Error Rate Alerts
      # ========================================

      - alert: HighErrorRate
        expr: |
          (sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m]))) * 100 > 1
        for: 5m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | printf \"%.2f\" }}% (threshold: 1%)"
          runbook_url: "https://docs.ipa-platform.io/runbooks/high-error-rate"

      - alert: CriticalErrorRate
        expr: |
          (sum(rate(http_requests_total{status=~"5.."}[5m])) / sum(rate(http_requests_total[5m]))) * 100 > 5
        for: 2m
        labels:
          severity: critical
          category: performance
        annotations:
          summary: "Critical error rate detected"
          description: "Error rate is {{ $value | printf \"%.2f\" }}% (threshold: 5%)"
          runbook_url: "https://docs.ipa-platform.io/runbooks/critical-error-rate"

      - alert: NoRequests
        expr: sum(rate(http_requests_total[5m])) == 0
        for: 10m
        labels:
          severity: warning
          category: availability
        annotations:
          summary: "No requests received"
          description: "No HTTP requests have been received in the last 10 minutes"

      # ========================================
      # Throughput Alerts
      # ========================================

      - alert: LowThroughput
        expr: sum(rate(http_requests_total[5m])) < 0.1
        for: 10m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "Low throughput detected"
          description: "Request rate is {{ $value | printf \"%.2f\" }} req/s (threshold: 0.1 req/s)"

      - alert: HighThroughput
        expr: sum(rate(http_requests_total[1m])) > 1000
        for: 5m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "High throughput detected"
          description: "Request rate is {{ $value | printf \"%.0f\" }} req/s - consider scaling"

      # ========================================
      # Resource Utilization Alerts
      # ========================================

      - alert: HighCPUUsage
        expr: process_cpu_seconds_total > 0.8
        for: 10m
        labels:
          severity: warning
          category: resources
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage is {{ $value | printf \"%.0f\" }}% (threshold: 80%)"
          runbook_url: "https://docs.ipa-platform.io/runbooks/high-cpu"

      - alert: CriticalCPUUsage
        expr: process_cpu_seconds_total > 0.95
        for: 5m
        labels:
          severity: critical
          category: resources
        annotations:
          summary: "Critical CPU usage detected"
          description: "CPU usage is {{ $value | printf \"%.0f\" }}% (threshold: 95%)"

      - alert: HighMemoryUsage
        expr: process_resident_memory_bytes / 1024 / 1024 / 1024 > 3
        for: 10m
        labels:
          severity: warning
          category: resources
        annotations:
          summary: "High memory usage detected"
          description: "Memory usage is {{ $value | humanize1024 }}B (threshold: 3GB)"
          runbook_url: "https://docs.ipa-platform.io/runbooks/high-memory"

      - alert: CriticalMemoryUsage
        expr: process_resident_memory_bytes / 1024 / 1024 / 1024 > 3.5
        for: 5m
        labels:
          severity: critical
          category: resources
        annotations:
          summary: "Critical memory usage detected"
          description: "Memory usage is {{ $value | humanize1024 }}B (threshold: 3.5GB)"

      # ========================================
      # Database Connection Pool Alerts
      # ========================================

      - alert: DBConnectionPoolExhausted
        expr: db_pool_connections_available == 0
        for: 1m
        labels:
          severity: critical
          category: database
        annotations:
          summary: "Database connection pool exhausted"
          description: "No available database connections in the pool"
          runbook_url: "https://docs.ipa-platform.io/runbooks/db-pool-exhausted"

      - alert: DBConnectionPoolLow
        expr: db_pool_connections_available < 5
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "Database connection pool running low"
          description: "Only {{ $value }} connections available (threshold: 5)"

      - alert: HighDBQueryLatency
        expr: histogram_quantile(0.95, sum(rate(db_query_duration_seconds_bucket[5m])) by (le)) > 0.1
        for: 5m
        labels:
          severity: warning
          category: database
        annotations:
          summary: "High database query latency"
          description: "DB query P95 latency is {{ $value | humanizeDuration }} (threshold: 100ms)"

      # ========================================
      # Workflow Execution Alerts
      # ========================================

      - alert: HighWorkflowExecutionLatency
        expr: histogram_quantile(0.95, sum(rate(workflow_execution_duration_seconds_bucket[5m])) by (le)) > 60
        for: 5m
        labels:
          severity: warning
          category: workflow
        annotations:
          summary: "High workflow execution latency"
          description: "Workflow P95 execution time is {{ $value | humanizeDuration }} (threshold: 60s)"

      - alert: HighWorkflowFailureRate
        expr: |
          (sum(rate(workflow_executions_total{status="failed"}[1h])) / sum(rate(workflow_executions_total[1h]))) * 100 > 10
        for: 15m
        labels:
          severity: warning
          category: workflow
        annotations:
          summary: "High workflow failure rate"
          description: "Workflow failure rate is {{ $value | printf \"%.2f\" }}% (threshold: 10%)"

      # ========================================
      # LLM Performance Alerts
      # ========================================

      - alert: HighLLMLatency
        expr: histogram_quantile(0.95, sum(rate(llm_request_duration_seconds_bucket[5m])) by (le, model)) > 30
        for: 5m
        labels:
          severity: warning
          category: llm
        annotations:
          summary: "High LLM request latency"
          description: "LLM P95 latency is {{ $value | humanizeDuration }} (threshold: 30s)"

      - alert: HighLLMCost
        expr: sum(increase(llm_cost_total[1h])) > 10
        for: 1h
        labels:
          severity: warning
          category: llm
        annotations:
          summary: "High LLM cost detected"
          description: "LLM cost in the last hour is ${{ $value | printf \"%.2f\" }} (threshold: $10)"

      - alert: LLMAPIErrors
        expr: sum(rate(llm_api_calls_total{status="error"}[5m])) > 0.1
        for: 5m
        labels:
          severity: warning
          category: llm
        annotations:
          summary: "LLM API errors detected"
          description: "LLM API error rate is {{ $value | printf \"%.2f\" }} errors/s"
