---
paths: backend/src/integrations/**/*
---

# Azure OpenAI API Rules

> Rules for working with Azure OpenAI APIs, especially Responses API.

## Responses API vs Assistants API

Azure OpenAI has two API paradigms:

| Feature | Assistants API (舊) | Responses API (新) |
|---------|-------------------|-------------------|
| API Version | 2024-05-01-preview | 2025-03-01-preview |
| File ID Prefix | `assistant-` | `cfile_` |
| File Download | `/openai/files/{id}/content` | `/openai/v1/containers/{container_id}/files/{file_id}/content` |

## Code Interpreter File Download

### MUST Use Container Files API

When downloading files generated by Code Interpreter in Responses API:

```python
# CORRECT - Container Files API
download_url = f"{endpoint}/openai/v1/containers/{container_id}/files/{file_id}/content"
response = client.get(
    download_url,
    headers={"api-key": api_key},
    params={"api-version": "preview"}  # Use "preview", NOT date versions
)

# WRONG - Old Files API (won't work with Responses API)
download_url = f"{endpoint}/openai/files/{file_id}/content"
```

### API Version for Container Files

```python
# CORRECT
params={"api-version": "preview"}

# WRONG - These may return "API version not supported"
params={"api-version": "2025-03-01-preview"}
params={"api-version": "2024-10-01-preview"}
```

### Authentication Header

```python
# CORRECT for Azure OpenAI
headers={"api-key": api_key}

# WRONG - Bearer token is for OpenAI, not Azure OpenAI
headers={"Authorization": f"Bearer {api_key}"}
```

## Container ID Extraction

Container ID must be extracted from `code_interpreter_call` response:

```python
for item in response.output:
    if item.type == "code_interpreter_call":
        for result in item.code_interpreter_call.results:
            if hasattr(result, "container_id"):
                container_id = result.container_id
```

## Reference Documentation

- Microsoft Q&A: https://learn.microsoft.com/en-us/answers/questions/5534977
- Implementation: `backend/src/integrations/agent_framework/builders/code_interpreter.py`

## Quick Checklist

- [ ] Use `/openai/v1/containers/{container_id}/files/{file_id}/content` endpoint
- [ ] Use `api-version=preview` (not date-specific versions)
- [ ] Use `api-key` header (not Bearer token)
- [ ] Extract `container_id` from `code_interpreter_call` response
- [ ] Handle 404 errors (container may expire)
