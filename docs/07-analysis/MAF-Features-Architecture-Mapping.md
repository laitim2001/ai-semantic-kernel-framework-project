# MAF 50 功能與混合架構整合指南

> **文件版本**: 1.0  
> **最後更新**: 2026-01-10  
> **目的**: 將 MAF 50 個功能映射到 IT 事件智能處理平台架構

---

## 執行摘要

本文件詳細說明如何將 MAF 的 50 個功能整合到「MAF Orchestrator + Claude Worker + 統一 MCP」混合架構中。每個功能都有明確的架構層級歸屬、實現方式和應用場景。

---

## 1. 架構層級與功能映射總覽

### 1.1 架構層級定義

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              完整架構層級                                            │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  Layer 1: 入口層 (Gateway Layer)                                                    │
│  ════════════════════════════════                                                   │
│  • Event Ingestion API                                                              │
│  • 多渠道接入 (ServiceNow, Teams, Prometheus, Defender)                            │
│  • n8n 觸發整合                                                                     │
│                                                                                      │
│  Layer 2: 前端展示層 (Presentation Layer)                                           │
│  ════════════════════════════════════════                                           │
│  • 現代 Web UI                                                                      │
│  • DevUI 開發者介面                                                                 │
│  • 監控儀表板                                                                       │
│  • 待審批管理頁面                                                                   │
│                                                                                      │
│  Layer 3: MAF 編排層 (Orchestration Layer)                                          │
│  ═════════════════════════════════════════                                          │
│  • Orchestrator Agent (Claude Sonnet LLM)                                           │
│  • Workflow Engine (Sequential, Concurrent, GroupChat, Handoff, Magentic)          │
│  • HITL Manager                                                                     │
│  • Planning & Routing                                                               │
│  • Checkpoint Manager                                                               │
│                                                                                      │
│  Layer 4: Claude Worker 執行層 (Execution Layer)                                    │
│  ═══════════════════════════════════════════════                                    │
│  • Worker Pool (Kubernetes)                                                         │
│  • Claude Agent SDK Runtime                                                         │
│  • 子 Agent 系統                                                                    │
│                                                                                      │
│  Layer 5: 統一 MCP 工具層 (Tool Layer)                                              │
│  ═════════════════════════════════════                                              │
│  • MCP Gateway Service                                                              │
│  • 企業連接器 (ServiceNow, D365, SAP, SharePoint)                                  │
│  • 系統工具 (Database, K8s, SSH, Azure CLI)                                        │
│                                                                                      │
│  Layer 6: 基礎設施層 (Infrastructure Layer)                                         │
│  ═══════════════════════════════════════════                                        │
│  • Redis Cache                                                                      │
│  • Postgres/Cosmos DB                                                               │
│  • 外部記憶系統 (mem0)                                                              │
│  • 可觀測性 (Azure Monitor, Log Analytics, Grafana)                                │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 功能分類總覽

| 類別 | 功能數量 | 主要架構層級 |
|------|----------|-------------|
| 編排模式 | 12 | Layer 3 (MAF 編排層) |
| 人機協作 | 6 | Layer 2 + Layer 3 |
| 狀態管理 | 5 | Layer 3 + Layer 6 |
| 前端介面 | 8 | Layer 2 |
| 連接與整合 | 8 | Layer 1 + Layer 5 |
| 智能決策 | 6 | Layer 3 + Layer 4 |
| 可觀測性 | 5 | Layer 2 + Layer 6 |

---

## 2. 功能詳細映射

### 2.1 編排模式功能 (12 個)

#### #1 順序式 Agent 編排 (Sequential)

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  功能 #1: 順序式 Agent 編排                                                         │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  架構層級: Layer 3 (MAF 編排層)                                                     │
│                                                                                      │
│  實現位置:                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                     MAF Orchestrator Service                                │    │
│  │                                                                             │    │
│  │   ┌─────────────────────────────────────────────────────────────────────┐   │    │
│  │   │                    Workflow Engine                                  │   │    │
│  │   │                                                                     │   │    │
│  │   │   SequentialBuilder ──▶ Diagnostic ──▶ Remediation ──▶ Verification │   │    │
│  │   │                                                                     │   │    │
│  │   └─────────────────────────────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  應用場景:                                                                          │
│  • 密碼重設流程：驗證身份 → 重設密碼 → 發送通知                                    │
│  • 權限申請流程：接收請求 → 審批 → 配置權限 → 驗證                                 │
│                                                                                      │
│  代碼示例:                                                                          │
│  ```python                                                                          │
│  workflow = (SequentialBuilder()                                                    │
│      .add_step(diagnostic_worker)                                                   │
│      .add_step(remediation_worker)                                                  │
│      .add_step(verification_worker)                                                 │
│      .with_checkpointing(checkpoint_storage)                                        │
│      .build())                                                                      │
│  ```                                                                                │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

#### #15 Concurrent 並行執行

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  功能 #15: Concurrent 並行執行                                                      │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  架構層級: Layer 3 (MAF 編排層) + Layer 4 (Worker 執行層)                           │
│                                                                                      │
│  實現位置:                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                     MAF Orchestrator Service                                │    │
│  │                                                                             │    │
│  │   ConcurrentBuilder                                                         │    │
│  │        │                                                                    │    │
│  │        ├──▶ Worker A (Log Analysis)      ──┐                               │    │
│  │        ├──▶ Worker B (Metric Check)      ──┼──▶ Aggregator ──▶ Result      │    │
│  │        └──▶ Worker C (Config Validation) ──┘                               │    │
│  │                                                                             │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  應用場景:                                                                          │
│  • 多系統並行診斷：同時檢查 ADF、SQL、K8s 狀態                                     │
│  • 並行安全掃描：同時掃描多個服務器                                                │
│  • 批量驗證：同時驗證多個修復結果                                                  │
│                                                                                      │
│  與 Claude Worker 整合:                                                             │
│  • MAF 負責並行調度多個 Worker 容器                                                │
│  • 每個 Worker 內的 Claude Agent SDK 可再使用子 Agent 並行                         │
│  • 雙層並行：MAF 層 + Claude 子 Agent 層                                           │
│                                                                                      │
│  代碼示例:                                                                          │
│  ```python                                                                          │
│  workflow = (ConcurrentBuilder()                                                    │
│      .add_branch(log_analyzer_worker)                                               │
│      .add_branch(metric_checker_worker)                                             │
│      .add_branch(config_validator_worker)                                           │
│      .with_aggregator(result_aggregator)                                            │
│      .with_timeout(seconds=300)                                                     │
│      .build())                                                                      │
│  ```                                                                                │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

#### #18 GroupChat 群組聊天

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  功能 #18: GroupChat 群組聊天                                                       │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  架構層級: Layer 3 (MAF 編排層)                                                     │
│                                                                                      │
│  實現位置:                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                     MAF Orchestrator Service                                │    │
│  │                                                                             │    │
│  │   ┌─────────────────────────────────────────────────────────────────────┐   │    │
│  │   │                    GroupChat Orchestrator (#33)                     │   │    │
│  │   │                                                                     │   │    │
│  │   │              ┌─────────────────────────┐                            │   │    │
│  │   │              │   GroupChat Manager     │                            │   │    │
│  │   │              │   (Speaker Selection)   │                            │   │    │
│  │   │              └───────────┬─────────────┘                            │   │    │
│  │   │                          │                                          │   │    │
│  │   │       ┌──────────────────┼──────────────────┐                       │   │    │
│  │   │       ▼                  ▼                  ▼                       │   │    │
│  │   │  ┌─────────┐       ┌─────────┐       ┌─────────┐                    │   │    │
│  │   │  │Researcher│◀────▶│  Coder  │◀────▶│ Reviewer │                    │   │    │
│  │   │  │ Worker  │       │ Worker  │       │ Worker  │                    │   │    │
│  │   │  └─────────┘       └─────────┘       └─────────┘                    │   │    │
│  │   │                                                                     │   │    │
│  │   └─────────────────────────────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  應用場景:                                                                          │
│  • 複雜問題協作診斷：多個專家 Worker 討論並達成共識                                │
│  • 程式碼審查流程：開發者、審查者、安全專家協作                                    │
│  • 變更評審會議：模擬 CAB (Change Advisory Board) 討論                             │
│                                                                                      │
│  與投票系統整合 (#28, #48):                                                         │
│  • 當 Worker 意見分歧時，啟動投票機制                                              │
│  • 支持多數決、加權投票、一票否決                                                  │
│                                                                                      │
│  代碼示例:                                                                          │
│  ```python                                                                          │
│  workflow = (GroupChatBuilder()                                                     │
│      .with_manager(manager_agent)                                                   │
│      .select_speakers(speaker_selection_strategy)                                   │
│      .participants([researcher, coder, reviewer])                                   │
│      .with_voting(VotingConfig(method="majority", quorum=0.6))                      │
│      .with_max_rounds(10)                                                           │
│      .with_termination(TerminationConfig(                                           │
│          conditions=["consensus_reached", "max_rounds", "timeout"]                  │
│      ))                                                                             │
│      .build())                                                                      │
│  ```                                                                                │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

#### #19 Agent Handoff 交接

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  功能 #19: Agent Handoff 交接                                                       │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  架構層級: Layer 3 (MAF 編排層)                                                     │
│                                                                                      │
│  實現位置:                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                     MAF Orchestrator Service                                │    │
│  │                                                                             │    │
│  │   ┌─────────────────────────────────────────────────────────────────────┐   │    │
│  │   │                    Handoff Service (#32)                            │   │    │
│  │   │                                                                     │   │    │
│  │   │                      ┌─────────────┐                                │   │    │
│  │   │                      │   Triage    │                                │   │    │
│  │   │                      │   Worker    │                                │   │    │
│  │   │                      └──────┬──────┘                                │   │    │
│  │   │               ┌─────────────┼─────────────┐                         │   │    │
│  │   │               ▼             ▼             ▼                         │   │    │
│  │   │        ┌──────────┐  ┌──────────┐  ┌──────────┐                     │   │    │
│  │   │        │ Network  │  │ Database │  │ Security │                     │   │    │
│  │   │        │ Specialist│  │Specialist│  │Specialist│                     │   │    │
│  │   │        └────┬─────┘  └────┬─────┘  └────┬─────┘                     │   │    │
│  │   │             │             │             │                           │   │    │
│  │   │             └─────────────┴─────────────┘                           │   │    │
│  │   │                           │                                         │   │    │
│  │   │                           ▼                                         │   │    │
│  │   │                    Return to Triage                                 │   │    │
│  │   │                                                                     │   │    │
│  │   └─────────────────────────────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  Context Transfer (#31) 整合:                                                       │
│  • 交接時自動傳遞完整上下文                                                        │
│  • 包含診斷結果、嘗試過的方案、相關日誌                                            │
│                                                                                      │
│  應用場景:                                                                          │
│  • IT 事件分類和專家路由                                                           │
│  • 問題升級流程                                                                    │
│  • 跨團隊協作（CS↔IT, #4）                                                         │
│                                                                                      │
│  代碼示例:                                                                          │
│  ```python                                                                          │
│  workflow = (HandoffBuilder()                                                       │
│      .start_with(triage_worker)                                                     │
│      .with_handoffs(triage_worker, [                                                │
│          HandoffTarget(network_specialist, condition="network_issue"),              │
│          HandoffTarget(database_specialist, condition="database_issue"),            │
│          HandoffTarget(security_specialist, condition="security_issue")             │
│      ])                                                                             │
│      .with_context_transfer(ContextTransferConfig(                                  │
│          include=["diagnosis", "attempted_solutions", "relevant_logs"]              │
│      ))                                                                             │
│      .with_return_path(to=triage_worker)                                            │
│      .build())                                                                      │
│  ```                                                                                │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

#### #22 Dynamic Planning 動態規劃 + #23 Autonomous Decision

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  功能 #22: Dynamic Planning + #23: Autonomous Decision                              │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  架構層級: Layer 3 (MAF 編排層) + Layer 4 (Claude Worker)                           │
│                                                                                      │
│  職責分工:                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                                                                             │    │
│  │   MAF 編排層 (高層規劃)              Claude Worker (執行層規劃)             │    │
│  │   ═════════════════════              ════════════════════════              │    │
│  │                                                                             │    │
│  │   Planning Adapter (#34)              Claude Agent SDK                      │    │
│  │   • 決定使用哪種 Workflow             • 延伸思考規劃執行步驟               │    │
│  │   • 決定分派給哪些 Worker             • 自主決定工具調用順序               │    │
│  │   • 決定並行還是順序                  • 動態調整策略（試錯 #24）           │    │
│  │   • 風險驅動的決策                    • 委派子 Agent                        │    │
│  │                                                                             │    │
│  │         ┌─────────────┐                    ┌─────────────┐                  │    │
│  │         │   MAF       │                    │   Claude    │                  │    │
│  │         │  Magentic   │ ──────────────────▶│  Extended   │                  │    │
│  │         │  Pattern    │   分派高層任務      │  Thinking   │                  │    │
│  │         └─────────────┘                    └─────────────┘                  │    │
│  │               │                                  │                          │    │
│  │               ▼                                  ▼                          │    │
│  │         監控進度                            自主執行                        │    │
│  │         調整計劃                            反饋結果                        │    │
│  │                                                                             │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  Magentic 模式整合:                                                                 │
│  • MAF 使用 Magentic 進行高層動態規劃                                              │
│  • Claude 在 Worker 內進行細節規劃和執行                                           │
│  • 雙層規劃：戰略層 (MAF) + 戰術層 (Claude)                                        │
│                                                                                      │
│  代碼示例:                                                                          │
│  ```python                                                                          │
│  # MAF 層：高層動態規劃                                                             │
│  workflow = (MagenticBuilder()                                                      │
│      .participants(                                                                 │
│          diagnostician=diagnostic_worker,                                           │
│          remediator=remediation_worker,                                             │
│          verifier=verification_worker                                               │
│      )                                                                              │
│      .with_planning_adapter(PlanningAdapter(                                        │
│          strategy="dynamic",                                                        │
│          allow_replanning=True,                                                     │
│          max_replan_count=3                                                         │
│      ))                                                                             │
│      .with_standard_manager(                                                        │
│          agent=orchestrator_agent,                                                  │
│          max_round_count=20,                                                        │
│          max_stall_count=3                                                          │
│      )                                                                              │
│      .build())                                                                      │
│                                                                                      │
│  # Claude Worker 層：細節自主規劃                                                   │
│  options = ClaudeAgentOptions(                                                      │
│      model="sonnet",                                                                │
│      max_thinking_tokens=10000,  # 延伸思考                                         │
│      permission_mode="acceptEdits"                                                  │
│  )                                                                                  │
│  ```                                                                                │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

#### #24 Trial-and-Error 試錯

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  功能 #24: Trial-and-Error 試錯                                                     │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  架構層級: Layer 4 (Claude Worker 執行層) - 主要在 Claude Agent SDK 實現            │
│                                                                                      │
│  實現機制:                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                     Claude Worker (容器)                                    │    │
│  │                                                                             │    │
│  │   ┌─────────────────────────────────────────────────────────────────────┐   │    │
│  │   │                    Claude Agent SDK                                 │   │    │
│  │   │                                                                     │   │    │
│  │   │   Agentic Loop with Trial-and-Error:                               │   │    │
│  │   │                                                                     │   │    │
│  │   │   ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐         │   │    │
│  │   │   │ 嘗試    │───▶│ 驗證    │───▶│ 失敗?   │───▶│ 調整    │──┐      │   │    │
│  │   │   │ 方案 A  │    │ 結果    │    │         │    │ 策略    │  │      │   │    │
│  │   │   └─────────┘    └─────────┘    └────┬────┘    └─────────┘  │      │   │    │
│  │   │                                      │ 成功                  │      │   │    │
│  │   │                                      ▼                       │      │   │    │
│  │   │                               ┌─────────┐                    │      │   │    │
│  │   │                               │ 完成    │◀───────────────────┘      │   │    │
│  │   │                               └─────────┘                           │   │    │
│  │   │                                                                     │   │    │
│  │   └─────────────────────────────────────────────────────────────────────┘   │    │
│  │                                                                             │    │
│  │   安全機制（通過 MCP Gateway 權限控制）:                                    │    │
│  │   • 每次嘗試都有審計記錄                                                    │    │
│  │   • 危險操作需要審批                                                        │    │
│  │   • 最大嘗試次數限制                                                        │    │
│  │   • 回滾機制（Checkpoint）                                                  │    │
│  │                                                                             │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  應用場景:                                                                          │
│  • 配置修復：嘗試不同的配置參數組合                                                │
│  • 連接故障排查：依次嘗試不同的連接方式                                            │
│  • 腳本修復：修改腳本後測試，失敗則調整                                            │
│                                                                                      │
│  MAF 層的監控:                                                                      │
│  • 監控試錯次數                                                                    │
│  • 達到閾值時請求人工介入 (HITL)                                                   │
│  • 記錄所有嘗試到審計日誌                                                          │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

#### #25-27 Nested Workflows, Sub-workflow, Recursive Patterns

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  功能 #25-27: 巢狀工作流程模式                                                      │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  架構層級: Layer 3 (MAF) + Layer 4 (Claude Worker)                                  │
│                                                                                      │
│  雙層嵌套架構:                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                                                                             │    │
│  │  MAF 層 (Nested Workflows #25)         Claude 層 (Sub-agents)              │    │
│  │  ═══════════════════════════════       ══════════════════════              │    │
│  │                                                                             │    │
│  │  ┌─────────────────────────┐          ┌─────────────────────────┐          │    │
│  │  │    Main Workflow        │          │   Main Agent (Sonnet)   │          │    │
│  │  │                         │          │                         │          │    │
│  │  │  ┌─────────────────┐   │          │  ┌─────────────────┐   │          │    │
│  │  │  │ Sub-workflow A  │   │   ──▶    │  │ Sub-agent A     │   │          │    │
│  │  │  │ (Sequential)    │   │          │  │ (Log Analyzer)  │   │          │    │
│  │  │  └─────────────────┘   │          │  └─────────────────┘   │          │    │
│  │  │                         │          │                         │          │    │
│  │  │  ┌─────────────────┐   │          │  ┌─────────────────┐   │          │    │
│  │  │  │ Sub-workflow B  │   │   ──▶    │  │ Sub-agent B     │   │          │    │
│  │  │  │ (GroupChat)     │   │          │  │ (Config Checker)│   │          │    │
│  │  │  └─────────────────┘   │          │  └─────────────────┘   │          │    │
│  │  │                         │          │                         │          │    │
│  │  └─────────────────────────┘          └─────────────────────────┘          │    │
│  │                                                                             │    │
│  │  Recursive Patterns (#27):                                                  │    │
│  │  • MAF: 工作流程可調用自己（帶終止條件 #50）                                │    │
│  │  • Claude: 子 Agent 無法再產生子 Agent（單層限制）                          │    │
│  │  • 遞歸深度由 MAF 層控制                                                    │    │
│  │                                                                             │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  應用場景:                                                                          │
│  • 多層審批流程：主流程調用審批子流程                                              │
│  • 遞歸故障排查：排查發現新問題，遞歸處理                                          │
│  • 批量處理：主流程為每個項目調用子流程                                            │
│                                                                                      │
│  代碼示例:                                                                          │
│  ```python                                                                          │
│  # MAF 層嵌套                                                                       │
│  approval_subworkflow = (SequentialBuilder()                                        │
│      .add_step(approval_request_agent)                                              │
│      .add_step(approval_wait_agent)                                                 │
│      .build())                                                                      │
│                                                                                      │
│  main_workflow = (SequentialBuilder()                                               │
│      .add_step(diagnostic_worker)                                                   │
│      .add_step(WorkflowExecutor(approval_subworkflow))  # 嵌套子流程               │
│      .add_step(remediation_worker)                                                  │
│      .add_step(verification_worker)                                                 │
│      .with_recursive_limit(max_depth=3)                                             │
│      .build())                                                                      │
│  ```                                                                                │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

#### #39 Agent to Agent (A2A)

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  功能 #39: Agent to Agent (A2A)                                                     │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  架構層級: Layer 3 (MAF) + Layer 4 (Claude Worker)                                  │
│                                                                                      │
│  實現機制:                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                                                                             │    │
│  │   MAF A2A Protocol                      Claude A2A (via Task Tool)         │    │
│  │   ═════════════════                     ═══════════════════════════         │    │
│  │                                                                             │    │
│  │   ┌─────────────┐                       ┌─────────────┐                    │    │
│  │   │   Agent A   │                       │ Main Agent  │                    │    │
│  │   │ (Diagnostic)│                       │ (Claude)    │                    │    │
│  │   └──────┬──────┘                       └──────┬──────┘                    │    │
│  │          │                                     │                           │    │
│  │          │ MAF Handoff Protocol                │ Task Tool                 │    │
│  │          │                                     │                           │    │
│  │          ▼                                     ▼                           │    │
│  │   ┌─────────────┐                       ┌─────────────┐                    │    │
│  │   │   Agent B   │                       │ Sub-Agent   │                    │    │
│  │   │(Remediation)│                       │ (Haiku)     │                    │    │
│  │   └─────────────┘                       └─────────────┘                    │    │
│  │                                                                             │    │
│  │   特點:                                  特點:                              │    │
│  │   • 可跨容器通訊                         • 同一容器內                       │    │
│  │   • MAF 管理生命週期                     • Claude 管理生命週期              │    │
│  │   • 完整上下文傳遞                       • 隔離上下文                       │    │
│  │   • 支持雙向通訊                         • 單向委派（返回結果）             │    │
│  │                                                                             │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  Collaboration Protocol (#17) 整合:                                                 │
│  • 標準化的 Agent 間通訊協議                                                       │
│  • 包含：握手、能力發現、任務委派、結果回傳                                        │
│                                                                                      │
│  應用場景:                                                                          │
│  • IT-CS 跨部門協作：IT Agent 請求 CS Agent 協助用戶通知                           │
│  • 專家諮詢：普通 Agent 諮詢專家 Agent                                             │
│  • 資源共享：Agent 間共享分析結果                                                  │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

#### #50 Termination 條件

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  功能 #50: Termination 條件                                                         │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  架構層級: Layer 3 (MAF 編排層) - 統一終止管理                                      │
│                                                                                      │
│  終止條件類型:                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                                                                             │    │
│  │   ┌─────────────────────────────────────────────────────────────────────┐   │    │
│  │   │                    Termination Manager                              │   │    │
│  │   │                                                                     │   │    │
│  │   │   條件類型          │  說明                    │  檢查層級          │   │    │
│  │   │   ═══════════       │  ════════════════        │  ═══════════       │   │    │
│  │   │                     │                          │                    │   │    │
│  │   │   max_rounds        │  最大輪次達到            │  MAF Workflow      │   │    │
│  │   │   max_time          │  最大時間達到            │  MAF Workflow      │   │    │
│  │   │   goal_achieved     │  目標達成                │  Claude + MAF      │   │    │
│  │   │   consensus_reached │  共識達成 (GroupChat)    │  MAF GroupChat     │   │    │
│  │   │   error_threshold   │  錯誤次數超限            │  MAF + MCP Gateway │   │    │
│  │   │   human_intervention│  人工終止               │  HITL Manager      │   │    │
│  │   │   stall_detected    │  卡住檢測               │  MAF Magentic      │   │    │
│  │   │   resource_exhausted│  資源耗盡               │  Worker Container  │   │    │
│  │   │                                                                     │   │    │
│  │   └─────────────────────────────────────────────────────────────────────┘   │    │
│  │                                                                             │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  代碼示例:                                                                          │
│  ```python                                                                          │
│  termination_config = TerminationConfig(                                            │
│      conditions=[                                                                   │
│          MaxRoundsCondition(max_rounds=20),                                         │
│          MaxTimeCondition(max_seconds=3600),                                        │
│          GoalAchievedCondition(goal_checker=verify_task_complete),                  │
│          ConsensusCondition(threshold=0.8),                                         │
│          ErrorThresholdCondition(max_errors=5),                                     │
│          StallCondition(max_stall_rounds=3),                                        │
│      ],                                                                             │
│      on_termination=handle_termination,                                             │
│      allow_human_override=True                                                      │
│  )                                                                                  │
│                                                                                      │
│  workflow = (MagenticBuilder()                                                      │
│      ...                                                                            │
│      .with_termination(termination_config)                                          │
│      .build())                                                                      │
│  ```                                                                                │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

### 2.2 人機協作功能 (6 個)

#### #2 人機協作檢查點 + #29 HITL Manager + #49 HITL 功能擴展

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  功能 #2, #29, #49: 人機協作完整系統                                                │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  架構層級: Layer 2 (前端) + Layer 3 (MAF 編排層)                                    │
│                                                                                      │
│  完整 HITL 架構:                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                                                                             │    │
│  │   ┌───────────────────────────────────────────────────────────────────┐     │    │
│  │   │                      HITL Manager (#29)                           │     │    │
│  │   │                                                                   │     │    │
│  │   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │     │    │
│  │   │   │ Approval    │  │ Intervention│  │ Escalation  │              │     │    │
│  │   │   │ Workflow    │  │ Handler     │  │ Manager     │              │     │    │
│  │   │   └──────┬──────┘  └──────┬──────┘  └──────┬──────┘              │     │    │
│  │   │          │                │                │                      │     │    │
│  │   └──────────┴────────────────┴────────────────┴──────────────────────┘     │    │
│  │                               │                                              │    │
│  │                               ▼                                              │    │
│  │   ┌───────────────────────────────────────────────────────────────────┐     │    │
│  │   │              通知渠道 (Teams #11, Email, SMS)                     │     │    │
│  │   └───────────────────────────────────────────────────────────────────┘     │    │
│  │                               │                                              │    │
│  │                               ▼                                              │    │
│  │   ┌───────────────────────────────────────────────────────────────────┐     │    │
│  │   │              待審批管理頁面 (#45)                                 │     │    │
│  │   │                                                                   │     │    │
│  │   │   • 審批請求列表                                                  │     │    │
│  │   │   • 風險等級標示                                                  │     │    │
│  │   │   • 上下文詳情                                                    │     │    │
│  │   │   • 一鍵審批/拒絕                                                 │     │    │
│  │   │   • 審計軌跡                                                      │     │    │
│  │   │                                                                   │     │    │
│  │   └───────────────────────────────────────────────────────────────────┘     │    │
│  │                                                                             │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  HITL 功能擴展 (#49):                                                               │
│  • 多級審批：根據風險等級要求不同審批人                                            │
│  • 超時升級：審批超時自動升級到上級                                                │
│  • 批量審批：同類請求可批量處理                                                    │
│  • 條件審批：附加條件的審批（如「限於工作時間執行」）                              │
│  • 委託審批：審批人可委託給其他人                                                  │
│                                                                                      │
│  人機協作檢查點 (#2):                                                               │
│  • 關鍵步驟前自動創建 Checkpoint                                                   │
│  • 人工可回滾到任意檢查點                                                          │
│  • 支持「暫停-審查-繼續」模式                                                      │
│                                                                                      │
│  代碼示例:                                                                          │
│  ```python                                                                          │
│  hitl_manager = HITLManager(                                                        │
│      approval_config=ApprovalConfig(                                                │
│          levels={                                                                   │
│              RiskLevel.HIGH: ["IT Manager"],                                        │
│              RiskLevel.CRITICAL: ["IT Manager", "CAB"]                              │
│          },                                                                         │
│          timeout_minutes=30,                                                        │
│          escalation_path=["IT Director", "CIO"]                                     │
│      ),                                                                             │
│      notification_channels=[                                                        │
│          TeamsChannel(webhook_url="..."),                                           │
│          EmailChannel(smtp_config=...)                                              │
│      ],                                                                             │
│      checkpoint_config=CheckpointConfig(                                            │
│          auto_checkpoint=True,                                                      │
│          checkpoint_before_approval=True                                            │
│      )                                                                              │
│  )                                                                                  │
│  ```                                                                                │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

#### #45 待審批管理頁面 + #11 Teams 通知

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  功能 #45: 待審批管理頁面 + #11: Teams 通知                                           │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  架構層級: Layer 2 (前端展示層)                                                       │
│                                                                                     │
│  待審批管理頁面:                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                                                                             │    │
│  │  ┌─────────────────────────────────────────────────────────────────────┐   │    │
│  │  │  待審批管理                                              🔔 3 待處理 │   │    │
│  │  ├─────────────────────────────────────────────────────────────────────┤   │    │
│  │  │                                                                     │   │    │
│  │  │  ┌───────────────────────────────────────────────────────────────┐  │   │    │
│  │  │  │ ⚠️ HIGH | EVT-001 | ETL Pipeline 修復                         │  │   │    │
│  │  │  │ 請求者: IT Ops | 等待: 15 分鐘 | 審批人: IT Manager             │  │   │    │
│  │  │  │ [查看詳情] [✅ 批准] [❌ 拒絕]                                 │  │   │    │
│  │  │  └───────────────────────────────────────────────────────────────┘  │   │    │
│  │  │                                                                     │   │    │
│  │  │  ┌───────────────────────────────────────────────────────────────┐  │   │    │
│  │  │  │ 🔴 CRITICAL | EVT-002 | 生產資料庫變更                         │  │   │    │
│  │  │  │ 請求者: DBA Team | 等待: 5 分鐘 | 審批人: CAB                   │  │   │    │
│  │  │  │ [查看詳情] [✅ 批准] [❌ 拒絕] [⏸️ 延後]                       │  │   │    │
│  │  │  └───────────────────────────────────────────────────────────────┘  │   │    │
│  │  │                                                                     │   │    │
│  │  │  ┌───────────────────────────────────────────────────────────────┐  │   │    │
│  │  │  │ 🟡 MEDIUM | EVT-003 | 權限變更請求                             │  │   │    │
│  │  │  │ 請求者: HR | 等待: 30 分鐘 | 審批人: Security Team              │  │   │    │
│  │  │  │ [查看詳情] [✅ 批准] [❌ 拒絕]                                 │  │   │    │
│  │  │  └───────────────────────────────────────────────────────────────┘  │   │    │
│  │  │                                                                     │   │    │
│  │  └─────────────────────────────────────────────────────────────────────┘   │    │
│  │                                                                             │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  Teams 通知整合:                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                                                                             │    │
│  │   Teams Adaptive Card:                                                      │    │
│  │   ┌─────────────────────────────────────────────────────────────────────┐   │    │
│  │   │  🤖 IT 自動化平台 - 需要您的審批                                    │   │    │
│  │   │  ─────────────────────────────────────────────────────────          │   │    │
│  │   │  **事件**: ETL Pipeline 修復                                        │   │    │
│  │   │  **風險等級**: ⚠️ HIGH                                              │   │    │
│  │   │  **操作**: 更新 ADF 連接配置                                        │   │    │
│  │   │  **影響系統**: apac-glider, azure-data-factory                      │   │    │
│  │   │                                                                     │   │    │
│  │   │  [✅ 批准]  [❌ 拒絕]  [📋 查看詳情]                                │   │    │
│  │   └─────────────────────────────────────────────────────────────────────┘   │    │
│  │                                                                             │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  通過 MCP Gateway 實現:                                                             │
│  ```python                                                                          │
│  # Teams 通知通過統一 MCP 工具層發送                                                │
│  await mcp_gateway.execute_tool(                                                    │
│      tool_name="teams",                                                             │
│      operation="send_adaptive_card",                                                │
│      parameters={                                                                   │
│          "channel": "IT-Approvals",                                                 │
│          "card": approval_card,                                                     │
│          "actions": ["approve", "reject", "view_details"]                           │
│      }                                                                              │
│  )                                                                                  │
│  ```                                                                                │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

### 2.3 狀態管理功能 (5 個)

#### #35 Redis/Postgres Checkpoint + #21 Conversation Memory + #40 mem0

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  功能 #35, #21, #40: 狀態與記憶管理系統                                             │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  架構層級: Layer 3 (MAF) + Layer 6 (基礎設施)                                       │
│                                                                                      │
│  三層記憶架構:                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                                                                             │    │
│  │   ┌─────────────────────────────────────────────────────────────────────┐   │    │
│  │   │                    記憶層級架構                                     │   │    │
│  │   │                                                                     │   │    │
│  │   │   Layer 1: 工作記憶 (Redis Cache #14)                              │   │    │
│  │   │   ═══════════════════════════════════                              │   │    │
│  │   │   • 當前會話上下文                                                  │   │    │
│  │   │   • 最近 N 輪對話                                                   │   │    │
│  │   │   • 臨時計算結果                                                    │   │    │
│  │   │   • TTL: 24 小時                                                    │   │    │
│  │   │                                                                     │   │    │
│  │   │   Layer 2: 會話記憶 (Conversation Memory #21)                       │   │    │
│  │   │   ═══════════════════════════════════════════                       │   │    │
│  │   │   • MAF Thread State                                                │   │    │
│  │   │   • Claude Session Context                                          │   │    │
│  │   │   • Checkpoint 快照 (Postgres #35)                                  │   │    │
│  │   │   • TTL: 30 天                                                      │   │    │
│  │   │                                                                     │   │    │
│  │   │   Layer 3: 長期記憶 (mem0 #40)                                      │   │    │
│  │   │   ═══════════════════════════════                                   │   │    │
│  │   │   • 歷史事件模式                                                    │   │    │
│  │   │   • 用戶偏好                                                        │   │    │
│  │   │   • 系統知識庫                                                      │   │    │
│  │   │   • 永久存儲                                                        │   │    │
│  │   │                                                                     │   │    │
│  │   └─────────────────────────────────────────────────────────────────────┘   │    │
│  │                                                                             │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  與架構層的整合:                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                                                                             │    │
│  │   MAF Orchestrator                      Claude Worker                       │    │
│  │        │                                     │                              │    │
│  │        ▼                                     ▼                              │    │
│  │   ┌─────────────┐                     ┌─────────────┐                      │    │
│  │   │ MAF Thread  │                     │ Claude      │                      │    │
│  │   │ Manager     │◀────────同步───────▶│ Session     │                      │    │
│  │   └──────┬──────┘                     └──────┬──────┘                      │    │
│  │          │                                   │                              │    │
│  │          ▼                                   ▼                              │    │
│  │   ┌─────────────────────────────────────────────────────────────────────┐   │    │
│  │   │              統一狀態存儲層                                         │   │    │
│  │   │                                                                     │   │    │
│  │   │   Redis ──────────▶ Postgres ──────────▶ mem0                       │   │    │
│  │   │   (熱數據)           (溫數據)             (冷數據)                   │   │    │
│  │   │                                                                     │   │    │
│  │   └─────────────────────────────────────────────────────────────────────┘   │    │
│  │                                                                             │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  mem0 應用場景:                                                                     │
│  • 學習歷史事件處理模式                                                            │
│  • 記住用戶偏好（某用戶總是需要詳細報告）                                          │
│  • 累積系統知識（某系統容易出現的問題類型）                                        │
│  • 輔助 Few-shot 學習 (#5)                                                         │
│                                                                                      │
│  代碼示例:                                                                          │
│  ```python                                                                          │
│  memory_manager = MemoryManager(                                                    │
│      working_memory=RedisCache(url="redis://..."),                                  │
│      session_memory=PostgresCheckpoint(url="postgres://..."),                       │
│      long_term_memory=Mem0Client(api_key="...")                                     │
│  )                                                                                  │
│                                                                                      │
│  # 查詢長期記憶獲取相似歷史事件                                                     │
│  similar_events = await memory_manager.search_long_term(                            │
│      query="ETL pipeline failure",                                                  │
│      limit=5                                                                        │
│  )                                                                                  │
│  ```                                                                                │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

#### #31 Context Transfer

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  功能 #31: Context Transfer                                                         │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  架構層級: Layer 3 (MAF 編排層)                                                     │
│                                                                                      │
│  上下文傳遞場景:                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                                                                             │    │
│  │   場景 1: Worker 間傳遞 (Handoff)                                          │    │
│  │   ═════════════════════════════════                                        │    │
│  │                                                                             │    │
│  │   Diagnostic Worker ─────────────────────▶ Remediation Worker              │    │
│  │         │                                        │                          │    │
│  │         │                                        │                          │    │
│  │         ▼                                        ▼                          │    │
│  │   ┌───────────────────────────────────────────────────────┐                 │    │
│  │   │              Context Package                          │                 │    │
│  │   │                                                       │                 │    │
│  │   │   • diagnosis_result: "SQL 連接配置錯誤"              │                 │    │
│  │   │   • attempted_solutions: [...]                        │                 │    │
│  │   │   • relevant_logs: [...]                              │                 │    │
│  │   │   • affected_systems: ["adf", "sql"]                  │                 │    │
│  │   │   • tool_call_history: [...]                          │                 │    │
│  │   │                                                       │                 │    │
│  │   └───────────────────────────────────────────────────────┘                 │    │
│  │                                                                             │    │
│  │   場景 2: MAF → Claude Worker 傳遞                                          │    │
│  │   ═════════════════════════════════                                         │    │
│  │                                                                             │    │
│  │   MAF Orchestrator ─────────────────────▶ Claude Worker                     │    │
│  │         │                                        │                          │    │
│  │         │                                        │                          │    │
│  │         ▼                                        ▼                          │    │
│  │   ┌───────────────────────────────────────────────────────┐                 │    │
│  │   │              Task Context                             │                 │    │
│  │   │                                                       │                 │    │
│  │   │   • event: ITEvent 物件                               │                 │    │
│  │   │   • approval_status: "approved"                       │                 │    │
│  │   │   • risk_level: "high"                                │                 │    │
│  │   │   • workflow_position: "step_2"                       │                 │    │
│  │   │   • previous_step_result: {...}                       │                 │    │
│  │   │   • allowed_tools: [...]                              │                 │    │
│  │   │                                                       │                 │    │
│  │   └───────────────────────────────────────────────────────┘                 │    │
│  │                                                                             │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  代碼示例:                                                                          │
│  ```python                                                                          │
│  context_transfer = ContextTransferConfig(                                          │
│      include_fields=[                                                               │
│          "diagnosis_result",                                                        │
│          "attempted_solutions",                                                     │
│          "relevant_logs",                                                           │
│          "tool_call_history"                                                        │
│      ],                                                                             │
│      max_context_size=50000,  # tokens                                              │
│      compression_strategy="summarize_old",                                          │
│      sensitive_fields_handling="redact"                                             │
│  )                                                                                  │
│  ```                                                                                │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

### 2.4 前端介面功能 (8 個)

#### #7 DevUI 整合 + #41 devui + #38 WorkflowViz

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  功能 #7, #41, #38: 開發者 UI 與視覺化                                              │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  架構層級: Layer 2 (前端展示層)                                                     │
│                                                                                      │
│  DevUI 功能:                                                                        │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                                                                             │    │
│  │  ┌─────────────────────────────────────────────────────────────────────┐   │    │
│  │  │  DevUI - 開發者控制台                                      v1.0.0   │   │    │
│  │  ├─────────────────────────────────────────────────────────────────────┤   │    │
│  │  │                                                                     │   │    │
│  │  │  ┌─ Workflow Designer ─────────────────────────────────────────┐   │   │    │
│  │  │  │                                                             │   │   │    │
│  │  │  │   ┌─────┐     ┌─────┐     ┌─────┐     ┌─────┐               │   │   │    │
│  │  │  │   │Start│───▶│Diag │───▶│Remed│───▶│Verify│               │   │   │    │
│  │  │  │   └─────┘     └─────┘     └─────┘     └─────┘               │   │   │    │
│  │  │  │                  │                                          │   │   │    │
│  │  │  │                  ▼                                          │   │   │    │
│  │  │  │              ┌─────┐                                        │   │   │    │
│  │  │  │              │HITL │ (人工審批節點)                         │   │   │    │
│  │  │  │              └─────┘                                        │   │   │    │
│  │  │  │                                                             │   │   │    │
│  │  │  └─────────────────────────────────────────────────────────────┘   │   │    │
│  │  │                                                                     │   │    │
│  │  │  ┌─ Agent Inspector ───────────────────────────────────────────┐   │   │    │
│  │  │  │                                                             │   │   │    │
│  │  │  │  Selected: Diagnostic Worker                                │   │   │    │
│  │  │  │  ├─ Model: claude-sonnet-4-5                                │   │   │    │
│  │  │  │  ├─ Tools: Read, Grep, Glob, mcp__servicenow               │   │   │    │
│  │  │  │  ├─ Extended Thinking: Enabled (10000 tokens)              │   │   │    │
│  │  │  │  └─ Sub-agents: log-analyzer, metrics-checker              │   │   │    │
│  │  │  │                                                             │   │   │    │
│  │  │  └─────────────────────────────────────────────────────────────┘   │   │    │
│  │  │                                                                     │   │    │
│  │  │  ┌─ Execution Trace ───────────────────────────────────────────┐   │   │    │
│  │  │  │                                                             │   │   │    │
│  │  │  │  09:15:01 [Orchestrator] Intent classified: etl_failure    │   │   │    │
│  │  │  │  09:15:02 [Orchestrator] Risk assessed: HIGH               │   │   │    │
│  │  │  │  09:15:03 [HITL] Approval requested → IT Manager           │   │   │    │
│  │  │  │  09:15:18 [HITL] Approved by it.manager@ricoh.com          │   │   │    │
│  │  │  │  09:15:19 [Diagnostic] Started                             │   │   │    │
│  │  │  │  09:15:20 [Diagnostic] Tool: mcp__servicenow.query         │   │   │    │
│  │  │  │  09:15:25 [Diagnostic] Tool: mcp__azure_cli.execute        │   │   │    │
│  │  │  │  09:15:40 [Diagnostic] Extended thinking (2000 tokens)     │   │   │    │
│  │  │  │  09:16:00 [Diagnostic] Completed: root cause identified    │   │   │    │
│  │  │  │                                                             │   │   │    │
│  │  │  └─────────────────────────────────────────────────────────────┘   │   │    │
│  │  │                                                                     │   │    │
│  │  └─────────────────────────────────────────────────────────────────────┘   │    │
│  │                                                                             │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  WorkflowViz (#38) 功能:                                                            │
│  • 即時工作流程執行視覺化                                                          │
│  • 節點狀態顏色標示（運行中、完成、失敗、等待）                                    │
│  • 點擊節點查看詳細日誌                                                            │
│  • 支持放大/縮小/拖曳                                                              │
│  • 匯出工作流程定義                                                                │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

#### #12 監控儀表板 + #44 Dashboard 統計卡片 + #46 效能監控頁面

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  功能 #12, #44, #46: 監控與儀表板系統                                               │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  架構層級: Layer 2 (前端) + Layer 6 (可觀測性)                                      │
│                                                                                      │
│  Dashboard 設計:                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                                                                             │    │
│  │  ┌─────────────────────────────────────────────────────────────────────┐   │    │
│  │  │  IT 事件智能處理平台 - 監控儀表板                          ⚙️ 設定   │   │    │
│  │  ├─────────────────────────────────────────────────────────────────────┤   │    │
│  │  │                                                                     │   │    │
│  │  │  ┌─ 統計卡片 (#44) ─────────────────────────────────────────────┐  │   │    │
│  │  │  │                                                               │  │   │    │
│  │  │  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐  │  │   │    │
│  │  │  │  │  今日事件  │  │  自動化率  │  │ 平均處理  │  │  待審批   │  │  │   │    │
│  │  │  │  │    127    │  │   78.3%   │  │  15 分鐘  │  │     3     │  │  │   │    │
│  │  │  │  │  ↑15%     │  │  ↑2.1%    │  │  ↓20%     │  │  ⚠️ 緊急   │  │  │   │    │
│  │  │  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘  │  │   │    │
│  │  │  │                                                               │  │   │    │
│  │  │  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐  │  │   │    │
│  │  │  │  │  Worker   │  │  MCP 調用 │  │  Checkpoint│  │  錯誤率   │  │  │   │    │
│  │  │  │  │ 利用率 65% │   │  2,341    │  │     89    │  │   1.2%    │  │  │   │    │
│  │  │  │  └───────────┘  └───────────┘  └───────────┘  └───────────┘  │  │   │    │
│  │  │  │                                                               │  │   │    │
│  │  │  └───────────────────────────────────────────────────────────────┘  │   │    │
│  │  │                                                                     │   │    │
│  │  │  ┌─ 效能監控 (#46) ─────────────────────────────────────────────┐  │   │    │
│  │  │  │                                                             │  │   │    │
│  │  │  │   處理時間趨勢                    Worker 負載分布             │  │   │    │
│  │  │  │   ┌────────────────────┐         ┌────────────────────┐     │  │   │    │
│  │  │  │   │     ╱╲             │         │ ████████ Diag 45%  │     │  │   │    │
│  │  │  │   │    ╱  ╲   ╱╲       │         │ ██████   Remed 35% │     │  │   │    │
│  │  │  │   │   ╱    ╲_╱  ╲      │         │ ████     Verify 20%│     │  │   │    │
│  │  │  │   │  ╱           ╲     │         │                    │     │  │   │    │
│  │  │  │   └────────────────────┘         └────────────────────┘     │  │   │    │
│  │  │  │                                                             │  │   │    │
│  │  │  │   MCP Gateway 延遲                事件類型分布               │  │   │    │
│  │  │  │   ┌────────────────────┐         ┌────────────────────┐     │  │   │    │
│  │  │  │   │ ServiceNow: 45ms   │         │  ● ETL 故障 35%    │     │  │   │    │
│  │  │  │   │ Azure CLI:  120ms  │         │  ● 權限申請 25%    │     │  │   │    │
│  │  │  │   │ Database:   25ms   │         │  ● 密碼重設 20%    │     │  │   │    │
│  │  │  │   │ Teams:      30ms   │         │  ● 其他 20%        │     │  │   │    │
│  │  │  │   └────────────────────┘         └────────────────────┘     │  │   │    │
│  │  │  │                                                              │  │   │    │
│  │  │  └───────────────────────────────────────────────────────────────┘  │   │    │
│  │  │                                                                     │   │    │
│  │  └─────────────────────────────────────────────────────────────────────┘   │    │
│  │                                                                             │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  數據來源:                                                                          │
│  • Azure Monitor / Application Insights（指標和追蹤）                              │
│  • Log Analytics（日誌）                                                           │
│  • Prometheus（容器指標）                                                          │
│  • MCP Gateway 審計日誌（工具調用統計）                                            │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

#### #13 現代 Web UI + #42 通知系統

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  功能 #13: 現代 Web UI + #42: 通知系統                                              │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  架構層級: Layer 2 (前端展示層)                                                     │
│                                                                                      │
│  技術棧:                                                                            │
│  • React 18 + TypeScript                                                            │
│  • Tailwind CSS + shadcn/ui                                                         │
│  • AG-UI Protocol 客戶端                                                            │
│  • SSE 即時更新                                                                     │
│                                                                                      │
│  主要頁面:                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                                                                             │    │
│  │   ┌─ 側邊導航 ─┐  ┌─ 主內容區 ─────────────────────────────────────────┐   │    │
│  │   │            │  │                                                    │   │    │
│  │   │  🏠 首頁   │  │  當前頁面內容                                      │   │    │
│  │   │  📊 儀表板 │  │                                                    │   │    │
│  │   │  📝 事件   │  │  ┌─ 即時通知 ─────────────────────────────────┐   │   │    │
│  │   │  ⏳ 待審批 │  │  │ 🔔 新事件 EVT-127 已分派到 Diagnostic Worker│   │   │    │
│  │   │  🔧 工作流 │  │  │ ✅ EVT-125 處理完成，耗時 12 分鐘          │   │   │    │
│  │   │  🤖 Agent  │  │  │ ⚠️ EVT-126 需要人工審批                    │   │   │    │
│  │   │  📈 效能   │  │  └─────────────────────────────────────────────┘   │   │    │
│  │   │  ⚙️ 設定   │  │                                                    │   │    │
│  │   │            │  │                                                    │   │    │
│  │   └────────────┘  └────────────────────────────────────────────────────┘   │    │
│  │                                                                             │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  通知系統 (#42):                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                                                                             │    │
│  │   通知渠道:                         通知類型:                              │    │
│  │   • Web UI 即時通知（SSE）          • 事件狀態變更                         │    │
│  │   • Teams 推送                       • 審批請求                            │    │
│  │   • Email                            • 錯誤告警                            │    │
│  │   • SMS（緊急情況）                  • 處理完成                            │    │
│  │                                                                             │    │
│  │   通知偏好設定:                                                             │    │
│  │   ┌─────────────────────────────────────────────────────────────────────┐   │    │
│  │   │  用戶: chris.lai@ricoh.com                                         │   │    │
│  │   │                                                                     │   │    │
│  │   │  ☑️ Web UI 即時通知                                                 │   │    │
│  │   │  ☑️ Teams 推送（僅審批請求）                                        │   │    │
│  │   │  ☐ Email 摘要（每日）                                               │   │    │
│  │   │  ☐ SMS（僅緊急情況）                                                │   │    │
│  │   │                                                                     │   │    │
│  │   └─────────────────────────────────────────────────────────────────────┘   │    │
│  │                                                                             │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

### 2.5 連接與整合功能 (8 個)

#### #3 跨系統連接器 + #16 Enhanced Gateway

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  功能 #3, #16: 跨系統連接與增強網關                                                 │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  架構層級: Layer 5 (統一 MCP 工具層)                                                │
│                                                                                      │
│  Enhanced Gateway (#16) 完整架構:                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                                                                             │    │
│  │   ┌─────────────────────────────────────────────────────────────────────┐   │    │
│  │   │                    MCP Gateway Service                              │   │    │
│  │   │                                                                     │   │    │
│  │   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │   │    │
│  │   │   │ Rate        │  │ Circuit     │  │ Retry       │                │   │    │
│  │   │   │ Limiter     │  │ Breaker     │  │ Handler     │                │   │    │
│  │   │   └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                │   │    │
│  │   │          │                │                │                        │   │    │
│  │   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │   │    │
│  │   │   │ Permission  │  │ Audit       │  │ Cache       │                │   │    │
│  │   │   │ Manager     │  │ Logger      │  │ Manager     │                │   │    │
│  │   │   └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                │   │    │
│  │   │          │                │                │                        │   │    │
│  │   │          └────────────────┴────────────────┘                        │   │    │
│  │   │                           │                                         │   │    │
│  │   └───────────────────────────┴─────────────────────────────────────────┘   │    │
│  │                               │                                              │    │
│  │   ┌───────────────────────────┴───────────────────────────┐                 │    │
│  │   │                                                        │                 │    │
│  │   ▼                          ▼                            ▼                 │    │
│  │                                                                             │    │
│  │   企業連接器 (#3)            系統連接器                   外部連接器        │    │
│  │   ════════════════           ════════════                 ════════════      │    │
│  │                                                                             │    │
│  │   ┌─────────────┐           ┌─────────────┐           ┌─────────────┐      │    │
│  │   │ ServiceNow  │           │ Database    │           │ Web Search  │      │    │
│  │   │ • 事件管理  │           │ • SQL Server│           │ • Bing API  │      │    │
│  │   │ • 變更管理  │           │ • Postgres  │           │ • Google    │      │    │
│  │   │ • CMDB      │           │ • Cosmos DB │           │             │      │    │
│  │   └─────────────┘           └─────────────┘           └─────────────┘      │    │
│  │                                                                             │    │
│  │   ┌─────────────┐           ┌─────────────┐           ┌─────────────┐      │    │
│  │   │ Dynamics365 │           │ Kubernetes  │           │ GitHub      │      │    │
│  │   │ • CRM       │           │ • Pod 管理  │           │ • 倉庫      │      │    │
│  │   │ • ERP       │           │ • Deployment│           │ • Issues    │      │    │
│  │   │             │           │ • Logs      │           │ • Actions   │      │    │
│  │   └─────────────┘           └─────────────┘           └─────────────┘      │    │
│  │                                                                             │    │
│  │   ┌─────────────┐           ┌─────────────┐           ┌─────────────┐      │    │
│  │   │ SharePoint  │           │ Azure CLI   │           │ Stack       │      │    │
│  │   │ • 文件      │           │ • 資源管理  │           │ Overflow    │      │    │
│  │   │ • 權限      │           │ • ADF       │           │ • 知識搜尋  │      │    │
│  │   │             │           │ • Storage   │           │             │      │    │
│  │   └─────────────┘           └─────────────┘           └─────────────┘      │    │
│  │                                                                             │    │
│  │   ┌─────────────┐           ┌─────────────┐                                │    │
│  │   │ Teams       │           │ SSH         │                                │    │
│  │   │ • 通知      │           │ • 遠端執行  │                                │    │
│  │   │ • 審批      │           │ • 日誌收集  │                                │    │
│  │   │ • 聊天      │           │             │                                │    │
│  │   └─────────────┘           └─────────────┘                                │    │
│  │                                                                             │    │
│  │   ┌─────────────┐                                                          │    │
│  │   │ SAP         │                                                          │    │
│  │   │ • RFC 調用  │                                                          │    │
│  │   │ • BAPI      │                                                          │    │
│  │   │             │                                                          │    │
│  │   └─────────────┘                                                          │    │
│  │                                                                             │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  Enhanced Gateway 特性:                                                             │
│  • 統一 API 入口：所有工具通過相同的 RESTful/SSE 介面                              │
│  • 智能重試：根據錯誤類型自動重試                                                  │
│  • 結果快取：相同查詢在 TTL 內返回快取                                             │
│  • 健康檢查：自動檢測後端服務狀態                                                  │
│  • 負載均衡：多實例後端的自動分發                                                  │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

#### #8 n8n 觸發 + #4 跨場景協作 (CS↔IT)

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  功能 #8: n8n 觸發 + #4: 跨場景協作                                                 │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  架構層級: Layer 1 (入口層) + Layer 3 (MAF 編排層)                                  │
│                                                                                      │
│  n8n 整合架構:                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                                                                             │    │
│  │   ┌─────────────────────────────────────────────────────────────────────┐   │    │
│  │   │                         n8n Workflow                                │   │    │
│  │   │                                                                     │   │    │
│  │   │   ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐         │   │    │
│  │   │   │ Trigger │───▶│ Filter  │───▶│Transform│───▶│ HTTP    │         │   │    │
│  │   │   │(Webhook)│    │ (條件)  │    │ (格式) │    │ Request │         │   │    │
│  │   │   └─────────┘    └─────────┘    └─────────┘    └────┬────┘         │   │    │
│  │   │                                                      │              │   │    │
│  │   └──────────────────────────────────────────────────────┼──────────────┘   │    │
│  │                                                          │                   │    │
│  │                                                          ▼                   │    │
│  │   ┌─────────────────────────────────────────────────────────────────────┐   │    │
│  │   │                    Event Ingestion API                              │   │    │
│  │   │                                                                     │   │    │
│  │   │   POST /api/events                                                  │   │    │
│  │   │   {                                                                 │   │    │
│  │   │     "source": "n8n",                                                │   │    │
│  │   │     "workflow_id": "password_reset_flow",                           │   │    │
│  │   │     "trigger": "servicenow_webhook",                                │   │    │
│  │   │     "payload": {...}                                                │   │    │
│  │   │   }                                                                 │   │    │
│  │   │                                                                     │   │    │
│  │   └─────────────────────────────────────────────────────────────────────┘   │    │
│  │                                                                             │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  跨場景協作 (CS↔IT) (#4):                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                                                                             │    │
│  │   場景: 客戶報告問題，需要 CS 和 IT 協作                                    │    │
│  │                                                                             │    │
│  │   ┌───────────────────────────────────────────────────────────────────┐     │    │
│  │   │                    MAF Orchestrator                               │     │    │
│  │   │                                                                   │     │    │
│  │   │   ┌─────────────────────────────────────────────────────────┐     │     │    │
│  │   │   │              Handoff Workflow (跨部門)                  │     │     │    │
│  │   │   │                                                         │     │     │    │
│  │   │   │   ┌─────────────┐                                       │     │     │    │
│  │   │   │   │ CS Triage   │ ──▶ 判斷需要 IT 協助                  │     │     │    │
│  │   │   │   │ Agent       │                                       │     │     │    │
│  │   │   │   └──────┬──────┘                                       │     │     │    │
│  │   │   │          │                                              │     │     │    │
│  │   │   │          ▼ Handoff (Context Transfer)                   │     │     │    │
│  │   │   │                                                         │     │     │    │
│  │   │   │   ┌─────────────┐                                       │     │     │    │
│  │   │   │   │ IT Diagnostic│ ──▶ 技術診斷                         │     │     │    │
│  │   │   │   │ Agent       │                                       │     │     │    │
│  │   │   │   └──────┬──────┘                                       │     │     │    │
│  │   │   │          │                                              │     │     │    │
│  │   │   │          ▼ Handoff (結果回傳)                           │     │     │    │
│  │   │   │                                                         │     │     │    │
│  │   │   │   ┌─────────────┐                                       │     │     │    │
│  │   │   │   │ CS Response │ ──▶ 客戶通知                          │     │     │    │
│  │   │   │   │ Agent       │                                       │     │     │    │
│  │   │   │   └─────────────┘                                       │     │     │    │
│  │   │   │                                                         │     │     │    │
│  │   │   └─────────────────────────────────────────────────────────┘     │     │    │
│  │   │                                                                   │     │    │
│  │   └───────────────────────────────────────────────────────────────────┘     │    │
│  │                                                                             │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  n8n 觸發場景:                                                                      │
│  • ServiceNow 新工單 → n8n → IT 事件平台                                           │
│  • Prometheus 告警 → n8n (過濾和聚合) → IT 事件平台                                │
│  • 定時任務 → n8n → 主動巡檢 (#37)                                                 │
│  • Email 接收 → n8n (解析) → IT 事件平台                                           │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

#### #36 跨系統智能關聯

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  功能 #36: 跨系統智能關聯                                                           │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  架構層級: Layer 3 (MAF 編排層) + Layer 4 (Claude Worker)                           │
│                                                                                      │
│  智能關聯實現:                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                                                                             │    │
│  │   ┌─────────────────────────────────────────────────────────────────────┐   │    │
│  │   │              Cross-System Correlation Engine                        │   │    │
│  │   │                                                                     │   │    │
│  │   │   輸入事件:                                                         │   │    │
│  │   │   • ServiceNow 工單: "報表無法生成"                                 │   │    │
│  │   │   • Prometheus 告警: "ADF Pipeline Failed"                          │   │    │
│  │   │   • SQL 監控: "Connection Timeout"                                  │   │    │
│  │   │                                                                     │   │    │
│  │   │                        ▼                                            │   │    │
│  │   │                                                                     │   │    │
│  │   │   ┌─────────────────────────────────────────────────────────────┐   │   │    │
│  │   │   │              Claude Correlation Agent                       │   │   │    │
│  │   │   │                                                             │   │   │    │
│  │   │   │   <thinking>                                                │   │   │    │
│  │   │   │   分析這三個事件的關聯性...                                 │   │   │    │
│  │   │   │                                                             │   │   │    │
│  │   │   │   1. 時間相關性: 都在 09:00 左右發生                        │   │   │    │
│  │   │   │   2. 系統依賴: 報表 → ADF → SQL Server                     │   │   │    │
│  │   │   │   3. 根因推測: SQL 連接問題導致 ADF 失敗，進而報表失敗     │   │   │    │
│  │   │   │   </thinking>                                               │   │   │    │
│  │   │   │                                                             │   │   │    │
│  │   │   └─────────────────────────────────────────────────────────────┘   │   │    │
│  │   │                                                                     │   │    │
│  │   │                        ▼                                            │   │    │
│  │   │                                                                     │   │    │
│  │   │   輸出: 關聯事件群組                                                │   │    │
│  │   │   ┌─────────────────────────────────────────────────────────────┐   │   │    │
│  │   │   │  Incident Cluster: INC-CLUSTER-001                          │   │   │    │
│  │   │   │                                                             │   │   │    │
│  │   │   │  Root Event: SQL Connection Timeout                         │   │   │    │
│  │   │   │  Related Events:                                            │   │   │    │
│  │   │   │    - ADF Pipeline Failed (downstream)                       │   │   │    │
│  │   │   │    - 報表無法生成 (user-reported symptom)                   │   │   │    │
│  │   │   │                                                             │   │   │    │
│  │   │   │  Suggested Action: 統一處理，只需修復 SQL 連接              │   │   │    │
│  │   │   │                                                             │   │   │    │
│  │   │   └─────────────────────────────────────────────────────────────┘   │   │    │
│  │   │                                                                     │   │    │
│  │   └─────────────────────────────────────────────────────────────────────┘   │    │
│  │                                                                             │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  關聯維度:                                                                          │
│  • 時間關聯: 事件發生時間相近                                                      │
│  • 系統關聯: 基於 CMDB 依賴關係                                                    │
│  • 語義關聯: 描述中的相似術語                                                      │
│  • 歷史關聯: 過去類似事件的模式 (使用 mem0 #40)                                    │
│                                                                                      │
│  應用價值:                                                                          │
│  • 減少重複處理                                                                    │
│  • 快速定位根因                                                                    │
│  • 提高處理效率                                                                    │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

### 2.6 智能決策功能 (6 個)

#### #5 Few-shot 學習 + #43 智能路由 + #30 Capability Matcher + #47 Agent 能力匹配器

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  功能 #5, #43, #30, #47: 智能學習與路由系統                                         │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  架構層級: Layer 3 (MAF 編排層)                                                     │
│                                                                                      │
│  智能路由與能力匹配:                                                                │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                                                                             │    │
│  │   ┌─────────────────────────────────────────────────────────────────────┐   │    │
│  │   │                    Intent Router (#43)                              │   │    │
│  │   │                                                                     │   │    │
│  │   │   輸入: ITEvent                                                     │   │    │
│  │   │            │                                                        │   │    │
│  │   │            ▼                                                        │   │    │
│  │   │   ┌─────────────────────────────────────────────────────────────┐   │   │    │
│  │   │   │              Few-shot Learning (#5)                         │   │   │    │
│  │   │   │                                                             │   │   │    │
│  │   │   │   從 mem0 長期記憶中檢索相似歷史案例:                       │   │   │    │
│  │   │   │                                                             │   │   │    │
│  │   │   │   Example 1: "ADF 失敗" → Diagnostic → Remediation (成功)   │   │   │    │
│  │   │   │   Example 2: "報表錯誤" → Diagnostic → Handoff to DBA       │   │   │    │
│  │   │   │   Example 3: "權限問題" → Direct → Security Team            │   │   │    │
│  │   │   │                                                             │   │   │    │
│  │   │   │   基於相似案例預測最佳處理路徑                              │   │   │    │
│  │   │   │                                                             │   │   │    │
│  │   │   └─────────────────────────────────────────────────────────────┘   │   │    │
│  │   │            │                                                        │   │    │
│  │   │            ▼                                                        │   │    │
│  │   │   ┌─────────────────────────────────────────────────────────────┐   │   │    │
│  │   │   │              Capability Matcher (#30, #47)                  │   │   │    │
│  │   │   │                                                             │   │   │    │
│  │   │   │   任務需求:                 Agent 能力:                     │   │   │    │
│  │   │   │   ┌─────────────────┐      ┌─────────────────┐              │   │   │    │
│  │   │   │   │ • ADF 知識      │      │ Diagnostic:     │              │   │   │    │
│  │   │   │   │ • SQL 診斷      │ ───▶ │ • ADF ✓         │              │   │   │    │
│  │   │   │   │ • 日誌分析      │      │ • SQL ✓         │              │   │   │    │
│  │   │   │   │ • 延伸思考需求  │      │ • Log ✓         │              │   │   │    │
│  │   │   │   └─────────────────┘      │ • Thinking ✓    │              │   │   │    │
│  │   │   │                            │ Match: 95%      │              │   │   │    │
│  │   │   │                            └─────────────────┘              │   │   │    │
│  │   │   │                                                             │   │   │    │
│  │   │   └─────────────────────────────────────────────────────────────┘   │   │    │
│  │   │            │                                                        │   │    │
│  │   │            ▼                                                        │   │    │
│  │   │   輸出: 路由決策                                                    │   │    │
│  │   │   {                                                                 │   │    │
│  │   │     "workflow": "magentic",                                         │   │    │
│  │   │     "primary_worker": "diagnostic",                                 │   │    │
│  │   │     "backup_workers": ["database_specialist"],                      │   │    │
│  │   │     "confidence": 0.92                                              │   │    │
│  │   │   }                                                                 │   │    │
│  │   │                                                                     │   │    │
│  │   └─────────────────────────────────────────────────────────────────────┘   │    │
│  │                                                                             │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  Agent 能力註冊:                                                                    │
│  ```python                                                                          │
│  agent_registry = AgentRegistry()                                                   │
│                                                                                      │
│  agent_registry.register(                                                           │
│      name="diagnostic_worker",                                                      │
│      capabilities={                                                                 │
│          "domains": ["adf", "sql", "kubernetes", "networking"],                     │
│          "tools": ["Read", "Grep", "Bash", "mcp__azure_cli"],                       │
│          "languages": ["en", "zh"],                                                 │
│          "complexity_level": "high",                                                │
│          "thinking_enabled": True                                                   │
│      },                                                                             │
│      performance_metrics={                                                          │
│          "success_rate": 0.87,                                                      │
│          "avg_time": 180  # seconds                                                 │
│      }                                                                              │
│  )                                                                                  │
│  ```                                                                                │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

#### #37 主動巡檢模式

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  功能 #37: 主動巡檢模式                                                             │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  架構層級: Layer 1 (入口) + Layer 3 (MAF) + Layer 4 (Claude Worker)                 │
│                                                                                      │
│  主動巡檢架構:                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                                                                             │    │
│  │   ┌─────────────────────────────────────────────────────────────────────┐   │    │
│  │   │                    Proactive Inspection Scheduler                   │   │    │
│  │   │                                                                     │   │    │
│  │   │   排程配置:                                                         │   │    │
│  │   │   ┌─────────────────────────────────────────────────────────────┐   │   │    │
│  │   │   │  • Daily 08:00: 系統健康檢查                                │   │   │    │
│  │   │   │  • Weekly Mon 09:00: 完整安全掃描                           │   │   │    │
│  │   │   │  • Monthly 1st: 容量規劃分析                                │   │   │    │
│  │   │   │  • On-demand: 變更後驗證                                    │   │   │    │
│  │   │   └─────────────────────────────────────────────────────────────┘   │   │    │
│  │   │                                                                     │   │    │
│  │   └─────────────────────────────────────────────────────────────────────┘   │    │
│  │                               │                                              │    │
│  │                               ▼                                              │    │
│  │   ┌─────────────────────────────────────────────────────────────────────┐   │    │
│  │   │                    MAF Orchestrator                                 │   │    │
│  │   │                                                                     │   │    │
│  │   │   創建巡檢事件:                                                     │   │    │
│  │   │   {                                                                 │   │    │
│  │   │     "type": "proactive_inspection",                                 │   │    │
│  │   │     "scope": ["adf_pipelines", "sql_health", "k8s_pods"],          │   │    │
│  │   │     "priority": "low"                                               │   │    │
│  │   │   }                                                                 │   │    │
│  │   │                                                                     │   │    │
│  │   └─────────────────────────────────────────────────────────────────────┘   │    │
│  │                               │                                              │    │
│  │                               ▼                                              │    │
│  │   ┌─────────────────────────────────────────────────────────────────────┐   │    │
│  │   │                    Inspection Worker (Claude)                       │   │    │
│  │   │                                                                     │   │    │
│  │   │   巡檢任務:                                                         │   │    │
│  │   │                                                                     │   │    │
│  │   │   1. 檢查所有 ADF Pipeline 狀態                                    │   │    │
│  │   │      → 調用 mcp__azure_cli 獲取 pipeline 列表和狀態                │   │    │
│  │   │                                                                     │   │    │
│  │   │   2. 分析 SQL Server 健康指標                                      │   │    │
│  │   │      → 調用 mcp__database 查詢效能指標                             │   │    │
│  │   │                                                                     │   │    │
│  │   │   3. 檢查 K8s Pod 異常                                             │   │    │
│  │   │      → 調用 mcp__kubernetes 獲取 pod 狀態                          │   │    │
│  │   │                                                                     │   │    │
│  │   │   4. 使用延伸思考分析潛在風險                                      │   │    │
│  │   │                                                                     │   │    │
│  │   └─────────────────────────────────────────────────────────────────────┘   │    │
│  │                               │                                              │    │
│  │                               ▼                                              │    │
│  │   ┌─────────────────────────────────────────────────────────────────────┐   │    │
│  │   │                    巡檢報告                                         │   │    │
│  │   │                                                                     │   │    │
│  │   │   📊 日常巡檢報告 - 2026-01-10                                     │   │    │
│  │   │                                                                     │   │    │
│  │   │   ✅ ADF Pipelines: 15/15 正常                                     │   │    │
│  │   │   ⚠️ SQL Server: 磁盤使用率 85% (建議擴容)                         │   │    │
│  │   │   ✅ K8s Pods: 全部運行正常                                        │   │    │
│  │   │                                                                     │   │    │
│  │   │   建議事項:                                                         │   │    │
│  │   │   1. 計劃 SQL Server 磁盤擴容                                      │   │    │
│  │   │                                                                     │   │    │
│  │   └─────────────────────────────────────────────────────────────────────┘   │    │
│  │                                                                             │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  與 n8n 整合 (#8):                                                                  │
│  • n8n 定時觸發巡檢                                                                │
│  • 巡檢結果通過 n8n 發送報告                                                       │
│  • 發現問題自動創建事件                                                            │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

### 2.7 可觀測性功能 (5 個)

#### #10 審計追蹤 + #20 Multi-turn 多輪對話

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│  功能 #10: 審計追蹤 + #20: Multi-turn 多輪對話                                      │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  架構層級: Layer 3 (MAF) + Layer 5 (MCP Gateway) + Layer 6 (可觀測性)               │
│                                                                                      │
│  審計追蹤架構:                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                                                                             │    │
│  │   ┌─────────────────────────────────────────────────────────────────────┐   │    │
│  │   │                    Audit Trail System                               │   │    │
│  │   │                                                                     │   │    │
│  │   │   審計層級:                                                         │   │    │
│  │   │                                                                     │   │    │
│  │   │   Level 1: 事件審計 (MAF Orchestrator)                             │   │    │
│  │   │   ═════════════════════════════════════                             │   │    │
│  │   │   • 事件接收時間                                                    │   │    │
│  │   │   • 意圖識別結果                                                    │   │    │
│  │   │   • 風險評估                                                        │   │    │
│  │   │   • 工作流程選擇                                                    │   │    │
│  │   │   • 審批請求和結果                                                  │   │    │
│  │   │                                                                     │   │    │
│  │   │   Level 2: 執行審計 (Claude Worker)                                │   │    │
│  │   │   ═════════════════════════════════════                             │   │    │
│  │   │   • Worker 任務開始/結束                                            │   │    │
│  │   │   • 思考過程（可選記錄 Extended Thinking）                          │   │    │
│  │   │   • 子 Agent 委派                                                   │   │    │
│  │   │   • 決策點和選擇                                                    │   │    │
│  │   │                                                                     │   │    │
│  │   │   Level 3: 工具審計 (MCP Gateway)                                  │   │    │
│  │   │   ═════════════════════════════════════                             │   │    │
│  │   │   • 每次工具調用                                                    │   │    │
│  │   │   • 參數和結果                                                      │   │    │
│  │   │   • 權限檢查結果                                                    │   │    │
│  │   │   • 錯誤和重試                                                      │   │    │
│  │   │                                                                     │   │    │
│  │   └─────────────────────────────────────────────────────────────────────┘   │    │
│  │                                                                             │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  Multi-turn 對話記錄:                                                               │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                                                                             │    │
│  │   事件: EVT-2026-01-10-001                                                  │    │
│  │                                                                             │    │
│  │   Turn 1: [Orchestrator → Diagnostic Worker]                               │    │
│  │   ────────────────────────────────────────                                  │    │
│  │   Prompt: "診斷 ETL Pipeline 失敗原因..."                                  │    │
│  │   Response: "發現 SQL 連接超時..."                                         │    │
│  │   Tools: [servicenow.query, azure_cli.execute]                             │    │
│  │                                                                             │    │
│  │   Turn 2: [Diagnostic → Orchestrator (報告)]                               │    │
│  │   ────────────────────────────────────────                                  │    │
│  │   Content: "根因分析完成: SQL 連接配置錯誤"                                │    │
│  │                                                                             │    │
│  │   Turn 3: [Orchestrator → Remediation Worker]                              │    │
│  │   ────────────────────────────────────────                                  │    │
│  │   Prompt: "修復 SQL 連接配置..."                                           │    │
│  │   Context: [診斷結果, 審批資訊]                                            │    │
│  │                                                                             │    │
│  │   ...                                                                       │    │
│  │                                                                             │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  審計報告範例:                                                                      │
│  ```json                                                                            │
│  {                                                                                  │
│    "event_id": "EVT-2026-01-10-001",                                                │
│    "timeline": [                                                                    │
│      {"time": "09:00:01", "actor": "system", "action": "event_received"},           │
│      {"time": "09:00:02", "actor": "orchestrator", "action": "intent_classified"},  │
│      {"time": "09:00:03", "actor": "orchestrator", "action": "risk_assessed"},      │
│      {"time": "09:00:05", "actor": "hitl", "action": "approval_requested"},         │
│      {"time": "09:15:18", "actor": "it.manager", "action": "approved"},             │
│      {"time": "09:15:20", "actor": "diagnostic", "action": "tool_call",             │
│       "tool": "mcp__servicenow.query", "params": {...}, "result": {...}},          │
│      ...                                                                            │
│    ],                                                                               │
│    "total_duration": "45m",                                                         │
│    "tool_calls": 12,                                                                │
│    "approvals": 1                                                                   │
│  }                                                                                  │
│  ```                                                                                │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 功能整合總覽

### 3.1 功能與架構層級映射表

| # | 功能 | Layer 1 | Layer 2 | Layer 3 | Layer 4 | Layer 5 | Layer 6 |
|---|------|---------|---------|---------|---------|---------|---------|
| 1 | 順序式 Agent 編排 | | | ✅ | | | |
| 2 | 人機協作檢查點 | | ✅ | ✅ | | | ✅ |
| 3 | 跨系統連接器 | | | | | ✅ | |
| 4 | 跨場景協作 (CS↔IT) | | | ✅ | | | |
| 5 | Few-shot 學習 | | | ✅ | | | ✅ |
| 6 | Agent 模板市場 | | ✅ | ✅ | | | |
| 7 | DevUI 整合 | | ✅ | | | | |
| 8 | n8n 觸發 | ✅ | | | | | |
| 9 | Prompt 管理 | | | ✅ | ✅ | | |
| 10 | 審計追蹤 | | | ✅ | ✅ | ✅ | ✅ |
| 11 | Teams 通知 | | ✅ | | | ✅ | |
| 12 | 監控儀表板 | | ✅ | | | | ✅ |
| 13 | 現代 Web UI | | ✅ | | | | |
| 14 | Redis 緩存 | | | | | | ✅ |
| 15 | Concurrent 並行執行 | | | ✅ | ✅ | | |
| 16 | Enhanced Gateway | | | | | ✅ | |
| 17 | Collaboration Protocol | | | ✅ | ✅ | | |
| 18 | GroupChat 群組聊天 | | | ✅ | | | |
| 19 | Agent Handoff 交接 | | | ✅ | | | |
| 20 | Multi-turn 多輪對話 | | | ✅ | ✅ | | ✅ |
| 21 | Conversation Memory | | | ✅ | | | ✅ |
| 22 | Dynamic Planning | | | ✅ | ✅ | | |
| 23 | Autonomous Decision | | | | ✅ | | |
| 24 | Trial-and-Error | | | | ✅ | | |
| 25 | Nested Workflows | | | ✅ | | | |
| 26 | Sub-workflow Execution | | | ✅ | | | |
| 27 | Recursive Patterns | | | ✅ | | | |
| 28 | GroupChat 投票系統 | | | ✅ | | | |
| 29 | HITL Manager | | ✅ | ✅ | | | |
| 30 | Capability Matcher | | | ✅ | | | |
| 31 | Context Transfer | | | ✅ | | | |
| 32 | Handoff Service | | | ✅ | | | |
| 33 | GroupChat Orchestrator | | | ✅ | | | |
| 34 | Planning Adapter | | | ✅ | | | |
| 35 | Redis/Postgres Checkpoint | | | ✅ | | | ✅ |
| 36 | 跨系統智能關聯 | | | ✅ | ✅ | | |
| 37 | 主動巡檢模式 | ✅ | | ✅ | ✅ | | |
| 38 | WorkflowViz | | ✅ | | | | |
| 39 | Agent to Agent (A2A) | | | ✅ | ✅ | | |
| 40 | mem0 (外部記憶) | | | | | | ✅ |
| 41 | devui (開發者 UI) | | ✅ | | | | |
| 42 | 通知系統 | | ✅ | | | ✅ | |
| 43 | 智能路由 | | | ✅ | | | |
| 44 | Dashboard 統計卡片 | | ✅ | | | | |
| 45 | 待審批管理頁面 | | ✅ | | | | |
| 46 | 效能監控頁面 | | ✅ | | | | ✅ |
| 47 | Agent 能力匹配器 | | | ✅ | | | |
| 48 | 投票系統 | | | ✅ | | | |
| 49 | HITL 功能擴展 | | ✅ | ✅ | | | |
| 50 | Termination 條件 | | | ✅ | | | |

### 3.2 架構層級功能分布統計

| 架構層級 | 功能數量 | 主要功能類別 |
|---------|---------|-------------|
| Layer 1 (入口層) | 3 | n8n 觸發、主動巡檢 |
| Layer 2 (前端展示層) | 15 | UI、儀表板、通知、HITL 介面 |
| Layer 3 (MAF 編排層) | 38 | 編排模式、智能決策、狀態管理 |
| Layer 4 (Claude Worker) | 11 | 自主執行、試錯、思考 |
| Layer 5 (MCP 工具層) | 6 | 連接器、網關、審計 |
| Layer 6 (基礎設施層) | 10 | 快取、持久化、記憶、可觀測性 |

---

## 4. 結論

這 50 個 MAF 功能完整覆蓋了混合架構的各個層級：

1. **MAF 編排層是核心**：承載了最多功能（38 個），負責編排、決策、狀態管理
2. **Claude Worker 專注執行**：11 個功能，專注於自主執行和試錯
3. **統一工具層保障治理**：6 個功能，確保權限控制和審計
4. **前端提供可視化**：15 個功能，讓整個系統可觀測、可操作
5. **基礎設施支撐全局**：10 個功能，提供快取、持久化、記憶支援

這種分層設計確保了「可控、可觀測、可治理」的目標實現。

---

**文件結束**
