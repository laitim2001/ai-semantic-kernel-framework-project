# 執行工作流

本文檔介紹如何執行、監控和管理工作流執行。

---

## 目錄

1. [執行方式](#執行方式)
2. [執行狀態](#執行狀態)
3. [監控執行](#監控執行)
4. [檢查點審批](#檢查點審批)
5. [錯誤處理](#錯誤處理)
6. [執行歷史](#執行歷史)

---

## 執行方式

### 手動執行

1. 進入 **工作流** 頁面
2. 找到目標工作流
3. 點擊 **執行** 按鈕 (▶)
4. 填寫必要參數（如有）
5. 點擊 **確認執行**

```
┌─────────────────────────────────────┐
│ 執行工作流: IT-Ticket-Classification │
├─────────────────────────────────────┤
│                                     │
│ ticket_id: [INC001234        ]      │
│ priority:  [high          ▼]       │
│                                     │
│     [取消]         [確認執行]       │
└─────────────────────────────────────┘
```

### API 執行

透過 REST API 觸發執行：

```bash
curl -X POST https://api.ipa-platform.com/api/v1/workflows/{workflow_id}/execute \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "parameters": {
      "ticket_id": "INC001234",
      "priority": "high"
    }
  }'
```

**回應範例**:
```json
{
  "execution_id": "exec-abc123",
  "workflow_id": "wf-xyz789",
  "status": "PENDING",
  "created_at": "2025-11-26T10:30:00Z"
}
```

### Webhook 執行

配置 Webhook 觸發：

```bash
# Webhook URL 格式
POST https://api.ipa-platform.com/webhooks/{webhook_path}

# 範例
curl -X POST https://api.ipa-platform.com/webhooks/it-ticket \
  -H "X-Webhook-Secret: YOUR_SECRET" \
  -H "Content-Type: application/json" \
  -d '{
    "ticket_id": "INC001234",
    "title": "無法連接 VPN",
    "description": "...",
    "reporter": "user@example.com"
  }'
```

### 排程執行

排程工作流會自動按設定時間執行：

| Cron 設定 | 執行時間 |
|-----------|----------|
| `0 9 * * 1-5` | 週一至週五 09:00 |
| `0 */2 * * *` | 每 2 小時 |
| `0 0 1 * *` | 每月 1 日 00:00 |

查看排程狀態：
- 下次執行時間
- 上次執行結果
- 執行歷史記錄

---

## 執行狀態

### 狀態定義

| 狀態 | 圖示 | 說明 |
|------|------|------|
| `PENDING` | ⏳ | 等待執行資源 |
| `RUNNING` | 🔄 | 正在執行中 |
| `WAITING_APPROVAL` | ✋ | 等待人工審批 |
| `COMPLETED` | ✅ | 執行成功完成 |
| `FAILED` | ❌ | 執行失敗 |
| `CANCELLED` | 🚫 | 已被取消 |
| `TIMEOUT` | ⏰ | 執行超時 |

### 狀態轉換圖

```
           ┌─────────┐
           │ PENDING │
           └────┬────┘
                │
           ┌────▼────┐
      ┌────┤ RUNNING ├────┐
      │    └────┬────┘    │
      │         │         │
      │    ┌────▼────┐    │
      │    │WAITING_ │    │
      │    │APPROVAL │    │
      │    └────┬────┘    │
      │         │         │
┌─────▼───┐┌────▼────┐┌───▼─────┐
│ TIMEOUT ││COMPLETED││ FAILED  │
└─────────┘└─────────┘└─────────┘
```

---

## 監控執行

### 即時監控視圖

執行開始後，系統顯示即時監控視圖：

```
┌─────────────────────────────────────────────────────────────┐
│ 執行: exec-abc123                          狀態: 🔄 執行中  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ⚪ 開始 ─✅─▶ 驗證 ─✅─▶ AI分析 ─🔄─▶ 更新 ─⏳─▶ 通知 ─⏳─▶ ⬛ │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│ 當前節點: AI 分析                                           │
│ 開始時間: 10:30:00                                          │
│ 已執行: 45 秒                                               │
│                                                             │
│ 節點日誌:                                                   │
│ [10:30:45] 開始呼叫 Azure OpenAI API...                    │
│ [10:30:46] 發送分類請求...                                  │
└─────────────────────────────────────────────────────────────┘
```

### 節點詳情

點擊任意節點查看詳細資訊：

```yaml
節點: AI 分類
狀態: 完成
開始時間: 2025-11-26 10:30:45
結束時間: 2025-11-26 10:30:48
耗時: 3.2 秒

輸入:
  title: "無法連接 VPN"
  description: "從今天早上開始，VPN 客戶端顯示..."

輸出:
  category: "network"
  priority: "high"
  team: "network-ops"
  confidence: 0.95

日誌:
  - [INFO] 接收到分類請求
  - [INFO] 呼叫 GPT-4 模型
  - [INFO] 分類結果: network (信心度: 95%)
```

### 執行指標

| 指標 | 說明 |
|------|------|
| **總耗時** | 從開始到完成的總時間 |
| **節點耗時** | 每個節點的執行時間 |
| **API 呼叫** | 外部 API 呼叫次數和耗時 |
| **Token 使用** | LLM 呼叫的 Token 消耗 |

---

## 檢查點審批

### 什麼是檢查點？

檢查點是工作流中需要人工介入的暫停點，用於：

- 重要決策確認
- 敏感操作審批
- 數據驗證
- 合規審查

### 審批流程

1. **工作流執行到檢查點**
   - 狀態變為 `WAITING_APPROVAL`
   - 系統發送通知給審批人

2. **審批人收到通知**
   - Email 通知
   - Teams 訊息
   - 平台內通知

3. **審批人處理**
   - 查看執行詳情
   - 審核相關數據
   - 選擇 **批准** 或 **拒絕**

4. **工作流繼續或終止**

### 審批操作

```
┌─────────────────────────────────────────────────────────────┐
│ 檢查點審批                                                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 工作流: 大額訂單處理                                         │
│ 執行 ID: exec-abc123                                        │
│ 檢查點: 金額審批                                            │
│                                                             │
│ 待審批內容:                                                 │
│ ┌─────────────────────────────────────────────────────┐    │
│ │ 訂單金額: $15,000                                    │    │
│ │ 客戶: ABC Corporation                               │    │
│ │ 風險評估: 低                                        │    │
│ │ AI 建議: 批准                                       │    │
│ └─────────────────────────────────────────────────────┘    │
│                                                             │
│ 備註: [________________________________]                    │
│                                                             │
│           [拒絕]              [批准]                        │
└─────────────────────────────────────────────────────────────┘
```

### 審批超時

檢查點可設置超時時間：

```yaml
checkpoint:
  name: 金額審批
  timeout: 24h
  on_timeout: escalate  # 或 auto_approve, auto_reject
  escalation:
    notify: manager@example.com
```

---

## 錯誤處理

### 查看錯誤詳情

執行失敗時，點擊失敗的節點查看：

```yaml
錯誤類型: HTTPError
錯誤代碼: 503
錯誤訊息: Service Unavailable
堆棧追蹤:
  - requests.exceptions.HTTPError: 503 Server Error
  - at node: update_ticket (line 45)
  - at workflow: IT-Ticket-Classification

重試次數: 3/3
上次重試: 2025-11-26 10:31:00
```

### 重試執行

對於失敗的執行：

1. **完整重試**: 從頭開始重新執行
2. **從失敗點重試**: 從失敗的節點繼續
3. **跳過失敗節點**: 標記為成功並繼續

```
[從頭重試] [從失敗點重試] [跳過並繼續]
```

### 取消執行

取消正在進行的執行：

1. 進入執行詳情頁
2. 點擊 **取消執行**
3. 確認取消

> **注意**: 取消操作不可逆，已完成的節點不會回滾。

---

## 執行歷史

### 查看歷史記錄

導航到 **執行** 頁面查看所有執行記錄：

| 執行 ID | 工作流 | 狀態 | 開始時間 | 耗時 | 觸發方式 |
|---------|--------|------|----------|------|----------|
| exec-001 | IT票據分類 | ✅ 完成 | 10:30 | 15s | Webhook |
| exec-002 | 報表生成 | ❌ 失敗 | 10:28 | 45s | 排程 |
| exec-003 | 客戶通知 | ✅ 完成 | 10:15 | 8s | 手動 |

### 篩選和搜索

可用的篩選條件：

- **時間範圍**: 今天、本週、本月、自定義
- **狀態**: 全部、成功、失敗、進行中
- **工作流**: 選擇特定工作流
- **觸發方式**: 手動、排程、Webhook

### 匯出執行日誌

```bash
# 匯出為 JSON
GET /api/v1/executions/{execution_id}/logs?format=json

# 匯出為 CSV
GET /api/v1/executions/{execution_id}/logs?format=csv
```

---

## 效能優化建議

### 1. 並行執行

對於獨立的任務，使用並行節點：

```yaml
# 串行執行 (慢)
A → B → C → D

# 並行執行 (快)
    ┌→ B ─┐
A ─┤      ├→ D
    └→ C ─┘
```

### 2. 合理設置超時

```yaml
node:
  timeout: 30s  # 設置合理的超時時間
```

### 3. 使用緩存

```yaml
http_request:
  cache:
    enabled: true
    ttl: 300  # 5 分鐘緩存
```

### 4. 批量處理

```yaml
# 批量處理 vs 逐一處理
batch_process:
  items: "{{ input.tickets }}"
  batch_size: 10
```

---

## 下一步

- [監控與告警](monitoring.md) - 設置系統監控
- [API 文檔](/api/openapi.yaml) - API 參考
- [故障排除](../admin-guide/troubleshooting.md) - 常見問題解決

---

*最後更新: 2025-11-26*
