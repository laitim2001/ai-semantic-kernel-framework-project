# Phase 29: Agent Swarm 可視化介面

## 概述

Phase 29 專注於實現 **Agent Swarm 可視化介面**，參考 Kimi AI 的多 Worker 並行執行風格，讓用戶能夠直觀地觀察多個 Agent Worker 的協作執行過程。

本 Phase 是 IPA Platform 編排功能的視覺化增強，將複雜的多 Agent 協作過程以清晰、直觀的方式呈現給用戶。

## 目標

1. **Swarm 數據模型** - 定義 Worker、Swarm 的核心數據結構
2. **事件系統整合** - 與 AG-UI SSE 整合，實現實時狀態推送
3. **核心 UI 組件** - AgentSwarmPanel、WorkerCard、WorkerDetailDrawer
4. **Extended Thinking** - 可視化 Claude 的擴展思考過程
5. **狀態管理整合** - 與現有 OrchestrationPanel 整合
6. **E2E 測試與文檔** - 完整的測試覆蓋和開發文檔

## 前置條件

- ✅ Phase 28 完成 (三層意圖路由系統)
- ✅ AG-UI Protocol SSE 基礎設施就緒
- ✅ HybridEventBridge 就緒
- ✅ Claude SDK Extended Thinking 支援
- ✅ Shadcn UI 組件庫就緒

## Sprint 規劃

| Sprint | 名稱 | Story Points | 狀態 |
|--------|------|--------------|------|
| [Sprint 100](./sprint-100-plan.md) | Swarm 數據模型 + 後端 API | 28 點 | 📋 計劃中 |
| [Sprint 101](./sprint-101-plan.md) | Swarm 事件系統 + SSE 整合 | 25 點 | 📋 計劃中 |
| [Sprint 102](./sprint-102-plan.md) | AgentSwarmPanel + WorkerCard | 30 點 | 📋 計劃中 |
| [Sprint 103](./sprint-103-plan.md) | WorkerDetailDrawer 詳情面板 | 32 點 | 📋 計劃中 |
| [Sprint 104](./sprint-104-plan.md) | ExtendedThinking + 工具調用展示優化 | 28 點 | 📋 計劃中 |
| [Sprint 105](./sprint-105-plan.md) | OrchestrationPanel 整合 + 狀態管理 | 25 點 | 📋 計劃中 |
| [Sprint 106](./sprint-106-plan.md) | E2E 測試 + 性能優化 + 文檔 | 22 點 | 📋 計劃中 |

**總計**: 190 Story Points (7 Sprints)
**預估時程**: 5 週 + 1 週緩衝 = 6 週

## 架構概覽

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                    Phase 29: Agent Swarm 可視化架構                                   │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                           Frontend (React 18)                                │    │
│  │                                                                              │    │
│  │   ┌──────────────────────────────────────────────────────────────────────┐  │    │
│  │   │                       OrchestrationPanel                              │  │    │
│  │   │  ┌────────────────────────┐  ┌────────────────────────┐             │  │    │
│  │   │  │   AgentSwarmPanel      │  │   WorkerDetailDrawer   │             │  │    │
│  │   │  │  ┌──────────────────┐  │  │  ┌──────────────────┐  │             │  │    │
│  │   │  │  │   SwarmHeader    │  │  │  │  WorkerHeader    │  │             │  │    │
│  │   │  │  │   (模式/狀態)     │  │  │  │  (名稱/進度)     │  │             │  │    │
│  │   │  │  ├──────────────────┤  │  │  ├──────────────────┤  │             │  │    │
│  │   │  │  │  OverallProgress │  │  │  │  CurrentTask     │  │             │  │    │
│  │   │  │  │   (整體進度條)    │  │  │  │  (當前任務)      │  │             │  │    │
│  │   │  │  ├──────────────────┤  │  │  ├──────────────────┤  │             │  │    │
│  │   │  │  │  WorkerCardList  │  │  │  │ ExtendedThinking │  │             │  │    │
│  │   │  │  │  ┌────┐ ┌────┐   │  │  │  │  (擴展思考)      │  │             │  │    │
│  │   │  │  │  │W1  │ │W2  │   │──┼──▶│  ├──────────────────┤  │             │  │    │
│  │   │  │  │  └────┘ └────┘   │  │  │  │  ToolCallsPanel  │  │             │  │    │
│  │   │  │  │  ┌────┐ ┌────┐   │  │  │  │  (工具調用)      │  │             │  │    │
│  │   │  │  │  │W3  │ │W4  │   │  │  │  ├──────────────────┤  │             │  │    │
│  │   │  │  │  └────┘ └────┘   │  │  │  │  MessageHistory  │  │             │  │    │
│  │   │  │  └──────────────────┘  │  │  │  (對話歷史)      │  │             │  │    │
│  │   │  └────────────────────────┘  │  └──────────────────────┘             │  │    │
│  │   └──────────────────────────────────────────────────────────────────────┘  │    │
│  │                                                                              │    │
│  │   ┌──────────────────────────────────────────────────────────────────────┐  │    │
│  │   │                    useSwarmEvents (SSE Hook)                          │  │    │
│  │   │   • swarm:created → 初始化面板                                        │  │    │
│  │   │   • worker:started → 新增 WorkerCard                                  │  │    │
│  │   │   • worker:progress → 更新進度條                                      │  │    │
│  │   │   • worker:thinking → 追加思考內容                                    │  │    │
│  │   │   • worker:tool_call → 更新工具調用                                   │  │    │
│  │   │   • worker:completed → 標記完成                                       │  │    │
│  │   │   • swarm:completed → 顯示最終結果                                    │  │    │
│  │   └──────────────────────────────────────────────────────────────────────┘  │    │
│  │                                                                              │    │
│  │   ┌──────────────────────────────────────────────────────────────────────┐  │    │
│  │   │                    useSwarmStore (Zustand)                            │  │    │
│  │   │   • swarmStatus: AgentSwarmStatus                                     │  │    │
│  │   │   • selectedWorkerId: string | null                                   │  │    │
│  │   │   • workerDetail: WorkerDetail | null                                 │  │    │
│  │   │   • isDrawerOpen: boolean                                             │  │    │
│  │   └──────────────────────────────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                          │ SSE                                      │
│                                          ↓                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                           Backend (FastAPI)                                  │    │
│  │                                                                              │    │
│  │   ┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐     │    │
│  │   │   SwarmTracker   │    │ SwarmEventEmitter│    │ HybridEventBridge│     │    │
│  │   │                  │    │                  │    │                  │     │    │
│  │   │ • create_swarm() │───▶│ • emit_swarm_*() │───▶│ • emit_custom()  │     │    │
│  │   │ • start_worker() │    │ • emit_worker_*()│    │                  │     │    │
│  │   │ • add_thinking() │    │ • 事件節流       │    │                  │     │    │
│  │   │ • add_tool_call()│    │ • 批量發送       │    │                  │     │    │
│  │   └──────────────────┘    └──────────────────┘    └──────────────────┘     │    │
│  │           ↑                                                                  │    │
│  │   ┌──────────────────────────────────────────────────────────────────────┐  │    │
│  │   │                    SwarmIntegration                                   │  │    │
│  │   │   • on_coordination_started() → SwarmTracker.create_swarm()          │  │    │
│  │   │   • on_subtask_started() → SwarmTracker.start_worker()               │  │    │
│  │   │   • on_thinking() → SwarmTracker.add_worker_thinking()               │  │    │
│  │   │   • on_tool_call() → SwarmTracker.add_worker_tool_call()             │  │    │
│  │   │   • on_subtask_completed() → SwarmTracker.complete_worker()          │  │    │
│  │   └──────────────────────────────────────────────────────────────────────┘  │    │
│  │           ↑                                                                  │    │
│  │   ┌──────────────────────────────────────────────────────────────────────┐  │    │
│  │   │                    ClaudeCoordinator                                  │  │    │
│  │   │   • 多 Agent 協調執行                                                  │  │    │
│  │   │   • Extended Thinking 支援                                            │  │    │
│  │   │   • 工具調用追蹤                                                       │  │    │
│  │   └──────────────────────────────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                      Swarm API Endpoints (🆕 新增)                          │    │
│  │                                                                              │    │
│  │   GET    /api/v1/swarm/{swarm_id}                    # 取得 Swarm 狀態      │    │
│  │   GET    /api/v1/swarm/{swarm_id}/workers            # 列出所有 Workers     │    │
│  │   GET    /api/v1/swarm/{swarm_id}/workers/{id}       # 取得 Worker 詳情     │    │
│  │                                                                              │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

## UI 設計參考 (Kimi AI 風格)

### AgentSwarmPanel 主面板

```
┌─────────────────────────────────────────────────────────────────┐
│  🐝 Agent Swarm                    [Sequential]  🟢 Running     │
├─────────────────────────────────────────────────────────────────┤
│  Overall Progress  ████████████░░░░░░░░░  60%                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────────────┐  ┌────────────────────────┐        │
│  │ 🔍 Research Agent      │  │ 📝 Writer Agent        │        │
│  │ ████████████████░░░ 80%│  │ ████████░░░░░░░░░░ 40%│        │
│  │ 🔧 web_search          │  │ 🤔 Thinking...         │        │
│  │ ✓ 3 tools completed    │  │ ⏳ Waiting for data    │        │
│  └────────────────────────┘  └────────────────────────┘        │
│                                                                  │
│  ┌────────────────────────┐  ┌────────────────────────┐        │
│  │ 🎨 Designer Agent      │  │ ✅ Reviewer Agent      │        │
│  │ ░░░░░░░░░░░░░░░░░░░ 0% │  │ ████████████████████ ✓│        │
│  │ ⏳ Pending             │  │ ✓ Completed 2:34       │        │
│  └────────────────────────┘  └────────────────────────┘        │
│                                                                  │
├─────────────────────────────────────────────────────────────────┤
│  4 Workers  •  3 Tool Calls  •  Started 2:30 ago                │
└─────────────────────────────────────────────────────────────────┘
```

### WorkerDetailDrawer 詳情面板

```
┌─────────────────────────────────────────────────────────────────┐
│  ← Back                                                          │
├─────────────────────────────────────────────────────────────────┤
│  🔍 Research Agent                               [Research]     │
│  ████████████████████ 80%                        🟢 Running     │
├─────────────────────────────────────────────────────────────────┤
│  Current Task                                                    │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ Searching for latest AI developments in 2024...          │  │
│  └───────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│  💭 Extended Thinking                              [Collapse]   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 14:32:05 - Analyzing search results from 3 sources...    │  │
│  │ The data shows a clear trend in LLM capabilities...      │  │
│  │ 14:32:08 - Cross-referencing with academic papers...     │  │
│  │ Found 5 relevant papers discussing agent architectures..  │  │
│  └───────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│  🔧 Tool Calls (3)                                              │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ ✅ web_search           "AI developments 2024"   1.2s    │  │
│  │ ✅ read_url             "arxiv.org/..."          0.8s    │  │
│  │ 🔄 analyze_content      [Running...]             ...     │  │
│  └───────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────┤
│  💬 Messages (2)                                                │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ 14:32:00 [Assistant] Starting research on AI trends...   │  │
│  │ 14:32:10 [Assistant] Found 12 relevant sources...        │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 技術棧

| 技術 | 版本 | 用途 |
|------|------|------|
| React | 18.2+ | 前端框架 |
| TypeScript | 5.0+ | 類型安全 |
| Zustand | 4.0+ | 狀態管理 |
| Shadcn UI | latest | UI 組件庫 |
| Tailwind CSS | 3.0+ | 樣式框架 |
| FastAPI | 0.100+ | 後端框架 |
| Pydantic | 2.0+ | 數據驗證 |

## 風險與緩解

| 風險 | 影響 | 緩解措施 |
|------|------|----------|
| SSE 連接不穩定 | 事件丟失 | 重連機制、事件緩存 |
| 大量 Worker 性能問題 | UI 卡頓 | 虛擬化列表、事件節流 |
| Extended Thinking 過長 | 顯示混亂 | 摺疊、分頁、搜索 |
| 狀態同步問題 | 數據不一致 | Zustand 單一數據源 |

## 成功標準

- [ ] Swarm 數據模型完整定義
- [ ] SSE 事件系統正常運作
- [ ] AgentSwarmPanel 正確顯示多 Worker
- [ ] WorkerDetailDrawer 顯示完整詳情
- [ ] Extended Thinking 實時更新
- [ ] 與 OrchestrationPanel 整合成功
- [ ] E2E 測試覆蓋率 > 80%
- [ ] 事件延遲 < 100ms (P95)
- [ ] 文檔完整

---

**Phase 29 開始時間**: 2026-01-30
**預估完成時間**: 6 週
**總 Story Points**: 190 pts
