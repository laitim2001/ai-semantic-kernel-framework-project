# Sprint 77 Progress: SandboxOrchestrator + SandboxWorker

**Sprint ç›®æ¨™**: å»ºç«‹é€²ç¨‹éš”é›¢çš„å®‰å…¨åŸ·è¡Œç’°å¢ƒï¼Œå¯¦ç¾ SandboxOrchestrator å’Œ SandboxWorker
**é–‹å§‹æ—¥æœŸ**: 2026-01-12
**å®Œæˆæ—¥æœŸ**: 2026-01-12
**ç¸½é»æ•¸**: 21 é»
**ç‹€æ…‹**: âœ… å®Œæˆ
**å‰ç½®æ¢ä»¶**: Phase 20 å®Œæˆ âœ…

---

## Sprint æ¦‚è¦½

Sprint 77 æ˜¯ Phase 21 æ²™ç®±å®‰å…¨æ¶æ§‹çš„é¦–å€‹ Sprintï¼Œä¸»è¦ç›®æ¨™ï¼š
1. è¨­è¨ˆä¸¦å¯¦ç¾ SandboxOrchestrator - ç®¡ç†æ²™ç®±å­é€²ç¨‹çš„ç”Ÿå‘½é€±æœŸ
2. å¯¦ç¾ SandboxWorker - åœ¨éš”é›¢å­é€²ç¨‹ä¸­é‹è¡Œ Claude Agent
3. å»ºç«‹é€²ç¨‹éš”é›¢çš„å®‰å…¨é‚Šç•Œ

---

## æ¯æ—¥é€²åº¦

### Day 1 (2026-01-12)

**å®Œæˆé …ç›®**:
- [x] å‰µå»º Sprint 77 åŸ·è¡Œç›®éŒ„çµæ§‹
- [x] å‰µå»º progress.md å’Œ decisions.md
- [x] **S77-1: æ²™ç®±æ¶æ§‹è¨­è¨ˆèˆ‡ Orchestrator (13 pts)** âœ… å®Œæˆ
  - [x] å‰µå»º `backend/src/core/sandbox/` ç›®éŒ„çµæ§‹
  - [x] å‰µå»º `__init__.py` - Package åˆå§‹åŒ–
  - [x] å‰µå»º `config.py` - ProcessSandboxConfig dataclass
  - [x] å‰µå»º `orchestrator.py` - SandboxOrchestrator é¡
  - [x] å¯¦ç¾ `execute()` æ–¹æ³• - åŸ·è¡Œè«‹æ±‚
  - [x] å¯¦ç¾ `execute_stream()` æ–¹æ³• - ä¸²æµåŸ·è¡Œ
  - [x] å¯¦ç¾ `_get_or_create_worker()` - Worker ç®¡ç†èˆ‡ç”¨æˆ¶è¦ªå’Œæ€§
  - [x] å¯¦ç¾ `_cleanup_idle_workers()` - ç©ºé–’å›æ”¶
  - [x] å¯¦ç¾ `_cleanup_loop()` - èƒŒæ™¯æ¸…ç†ä»»å‹™
  - [x] å¯¦ç¾ `shutdown()` - å„ªé›…é—œé–‰
  - [x] æ·»åŠ é€²ç¨‹æ± å¤§å°é™åˆ¶ (max_workers)
  - [x] æ·»åŠ  Worker è¶…æ™‚è™•ç† (worker_timeout)
  - [x] å¯¦ç¾ `get_pool_stats()` - é€²ç¨‹æ± çµ±è¨ˆ
- [x] **S77-2: SandboxWorker å¯¦ç¾ (8 pts)** âœ… å®Œæˆ
  - [x] å‰µå»º `worker.py` - SandboxWorker é¡
  - [x] å¯¦ç¾ `start()` æ–¹æ³• - å•Ÿå‹•å­é€²ç¨‹
  - [x] å¯¦ç¾ `execute()` æ–¹æ³• - åŸ·è¡Œè«‹æ±‚
  - [x] å¯¦ç¾ `execute_stream()` æ–¹æ³• - ä¸²æµåŸ·è¡Œ
  - [x] å¯¦ç¾ `stop()` æ–¹æ³• - åœæ­¢å­é€²ç¨‹
  - [x] å¯¦ç¾ `_send_request()` / `_read_response()` - IPC é€šä¿¡
  - [x] å‰µå»º `worker_main.py` - å­é€²ç¨‹å…¥å£é»
  - [x] å¯¦ç¾ SandboxExecutor é¡ - æ²™ç®±å…§åŸ·è¡Œå™¨
  - [x] å¯¦ç¾ IPCHandler é¡ - JSON-RPC è™•ç†
  - [x] å¯¦ç¾è«‹æ±‚è™•ç†å¾ªç’°
- [x] èªæ³•é©—è­‰å…¨éƒ¨é€šé (5 files)

**é˜»ç¤™/å•é¡Œ**:
- (ç„¡)

**æ±ºç­–è¨˜éŒ„**:
- D77-001: æ²™ç®±æ¶æ§‹è¨­è¨ˆç­–ç•¥ - é¸æ“‡å­é€²ç¨‹éš”é›¢ + é€²ç¨‹æ± è¤‡ç”¨
- D77-002: IPC å”è­°é¸æ“‡ - JSON-RPC 2.0 over stdin/stdout
- D77-003: ç’°å¢ƒè®Šé‡éš”é›¢ç­–ç•¥ - é¡¯å¼å…è¨±åˆ—è¡¨
- D77-004: é€²ç¨‹æ± é…ç½®ç­–ç•¥ - é…ç½®åŒ–åƒæ•¸

---

## Story é€²åº¦è¿½è¹¤

| Story | é»æ•¸ | ç‹€æ…‹ | é–‹å§‹æ—¥æœŸ | å®Œæˆæ—¥æœŸ | å‚™è¨» |
|-------|------|------|----------|----------|------|
| S77-1: æ²™ç®±æ¶æ§‹è¨­è¨ˆèˆ‡ Orchestrator | 13 | âœ… å®Œæˆ | 2026-01-12 | 2026-01-12 | å« ProcessSandboxConfig |
| S77-2: SandboxWorker å¯¦ç¾ | 8 | âœ… å®Œæˆ | 2026-01-12 | 2026-01-12 | å« worker_main.py |

**åœ–ä¾‹**: âœ… å®Œæˆ | ğŸ”„ é€²è¡Œä¸­ | â³ å¾…é–‹å§‹ | âŒ é˜»ç¤™

---

## é—œéµæŒ‡æ¨™

| æŒ‡æ¨™ | ç›®æ¨™ | ç•¶å‰ | ç‹€æ…‹ |
|------|------|------|------|
| Orchestrator å¯¦ç¾ | 100% | 100% | âœ… |
| Worker å¯¦ç¾ | 100% | 100% | âœ… |
| èªæ³•é©—è­‰ | é€šé | é€šé | âœ… |
| ç’°å¢ƒéš”é›¢æ¸¬è©¦ | é€šé | å¾… Sprint 78 | â³ |
| æ€§èƒ½æ¸¬è©¦ (å•Ÿå‹•å»¶é² < 500ms) | é€šé | å¾… Sprint 78 | â³ |

---

## å‰µå»ºçš„æ–‡ä»¶

### æ–°å»ºæ–‡ä»¶ (5 å€‹)

| æ–‡ä»¶ | Story | æè¿° | è¡Œæ•¸ |
|------|-------|------|------|
| `backend/src/core/sandbox/__init__.py` | S77-1 | Package åˆå§‹åŒ–èˆ‡å°å‡º | ~40 |
| `backend/src/core/sandbox/config.py` | S77-1 | ProcessSandboxConfig é…ç½®é¡ | ~220 |
| `backend/src/core/sandbox/orchestrator.py` | S77-1 | SandboxOrchestrator é€²ç¨‹èª¿åº¦ | ~380 |
| `backend/src/core/sandbox/worker.py` | S77-2 | SandboxWorker å­é€²ç¨‹ç®¡ç† | ~280 |
| `backend/src/core/sandbox/worker_main.py` | S77-2 | å­é€²ç¨‹å…¥å£é»èˆ‡ IPC è™•ç† | ~260 |

**ç¸½ä»£ç¢¼é‡**: ~1,180 è¡Œ

### ä¿®æ”¹æ–‡ä»¶

- Sprint 77 ä¸éœ€è¦ä¿®æ”¹ç¾æœ‰æ–‡ä»¶ (ç´”æ–°å¢)

---

## Sprint ç¸½è¦½

**ç´¯è¨ˆå®Œæˆ**: 21/21 é» (100%)

```
é€²åº¦æ¢: [####################] 100%
```

### Sprint 77 æˆæœæ‘˜è¦

- âœ… **S77-1**: æ²™ç®±æ¶æ§‹è¨­è¨ˆèˆ‡ Orchestrator (13 pts)
  - `ProcessSandboxConfig`: ç’°å¢ƒè®Šé‡éæ¿¾ã€è³‡æºé™åˆ¶ã€è¶…æ™‚é…ç½®
  - `SandboxOrchestrator`: é€²ç¨‹æ± ç®¡ç†ã€ç”¨æˆ¶è¦ªå’Œæ€§ã€ç©ºé–’å›æ”¶
  - æ”¯æŒåŒæ­¥åŸ·è¡Œ `execute()` å’Œä¸²æµåŸ·è¡Œ `execute_stream()`
  - èƒŒæ™¯æ¸…ç†ä»»å‹™è‡ªå‹•å›æ”¶ç©ºé–’ Worker
  - å„ªé›…é—œé–‰æ©Ÿåˆ¶

- âœ… **S77-2**: SandboxWorker å¯¦ç¾ (8 pts)
  - `SandboxWorker`: å­é€²ç¨‹ç”Ÿå‘½é€±æœŸç®¡ç†
  - JSON-RPC 2.0 IPC å”è­°
  - `worker_main.py`: éš”é›¢é€²ç¨‹å…¥å£é»
  - `SandboxExecutor`: æ²™ç®±å…§åŸ·è¡Œå™¨ (Sprint 78 å°‡æ•´åˆ Claude SDK)
  - `IPCHandler`: è«‹æ±‚è™•ç†èˆ‡äº‹ä»¶è½‰ç™¼

### æ¶æ§‹è¨­è¨ˆ

```
ä¸»é€²ç¨‹ (FastAPI)                    æ²™ç®±å­é€²ç¨‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SandboxOrchestrator     â”‚        â”‚ worker_main.py          â”‚
â”‚   â”œâ”€â”€ Worker Pool       â”‚        â”‚   â”œâ”€â”€ SandboxExecutor   â”‚
â”‚   â”‚   â”œâ”€â”€ Worker 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   â””â”€â”€ IPCHandler      â”‚
â”‚   â”‚   â”œâ”€â”€ Worker 2      â”‚  IPC   â”‚                         â”‚
â”‚   â”‚   â””â”€â”€ Worker N      â”‚ JSON-RPCâ”‚ å—é™ç’°å¢ƒ:              â”‚
â”‚   â”œâ”€â”€ User Affinity     â”‚        â”‚   - ANTHROPIC_API_KEY   â”‚
â”‚   â””â”€â”€ Cleanup Task      â”‚        â”‚   - SANDBOX_DIR         â”‚
â”‚                         â”‚        â”‚   - ç„¡ DB/Redis è¨ªå•    â”‚
â”‚ æ•æ„Ÿè³‡æº:               â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚   - DB Connection       â”‚
â”‚   - Redis Connection    â”‚
â”‚   - å®Œæ•´ ENV            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‹ä¸€æ­¥ (Sprint 78)

Sprint 78 å°‡å®Œæˆ IPC é€šä¿¡æ•´åˆèˆ‡ç¾æœ‰ä»£ç¢¼é©é…ï¼š

1. **S78-1**: IPC é€šä¿¡èˆ‡äº‹ä»¶è½‰ç™¼
   - SSE äº‹ä»¶å¾æ²™ç®±è½‰ç™¼åˆ°ä¸»é€²ç¨‹
   - éŒ¯èª¤è™•ç†å’Œè¶…æ™‚æ©Ÿåˆ¶
   - é€²ç¨‹å´©æ½°æ¢å¾©ç­–ç•¥

2. **S78-2**: ç¾æœ‰ä»£ç¢¼é©é…
   - chat.py é©é… Orchestrator
   - claude_sdk routes é©é…
   - bridge.py å§”æ´¾åŸ·è¡Œ

3. **S78-3**: å®‰å…¨æ¸¬è©¦èˆ‡é©—è­‰
   - é©—è­‰é€²ç¨‹éš”é›¢æœ‰æ•ˆæ€§
   - æ¸¬è©¦ç’°å¢ƒè®Šé‡ä¸æ´©éœ²
   - æ€§èƒ½åŸºæº–æ¸¬è©¦

---

## ç›¸é—œé€£çµ

- [Sprint 77 è¨ˆåŠƒ](../../sprint-planning/phase-21/sprint-77-plan.md)
- [Sprint 77 Checklist](../../sprint-planning/phase-21/sprint-77-checklist.md)
- [Phase 21 README](../../sprint-planning/phase-21/README.md)
- [PHASE-21-25-ROADMAP](../../sprint-planning/PHASE-21-24-ROADMAP.md)
