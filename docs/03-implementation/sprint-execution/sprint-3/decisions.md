# Sprint 3 Decisions

## 決策記錄

### Decision #1: Webhook 簽名算法選擇
- **日期**: 2025-11-30
- **背景**: 需要為 n8n Webhook 觸發實現安全的簽名驗證
- **選項**:
  1. HMAC-SHA256 - 業界標準，與 GitHub Webhooks 相同
  2. HMAC-SHA512 - 更強安全性但較長的簽名
  3. RSA 簽名 - 非對稱加密，更複雜
- **決定**: HMAC-SHA256 為默認，同時支持 SHA512
- **原因**: 與 n8n 和主流 Webhook 服務兼容，平衡安全性和性能
- **影響**: SignatureAlgorithm 枚舉支持擴展

### Decision #2: 重試策略
- **日期**: 2025-11-30
- **背景**: 需要處理網路暫時失敗的情況
- **選項**:
  1. 固定延遲重試 - 簡單但可能加重服務壓力
  2. 指數退避 - 逐漸增加延遲，減輕服務壓力
  3. 即時隊列 - 使用消息隊列，更可靠但複雜
- **決定**: 指數退避 (delay * 2^attempt)
- **原因**: 平衡可靠性和複雜度，MVP 階段不需要完整隊列
- **影響**: 默認最大重試 3 次，初始延遲 1 秒

### Decision #3: 回調失敗處理
- **日期**: 2025-11-30
- **背景**: 回調 n8n 時可能失敗，需要決定如何處理
- **選項**:
  1. 回調失敗導致觸發失敗 - 嚴格一致性
  2. 回調失敗不影響觸發結果 - 更彈性
  3. 回調失敗後重試 - 複雜但可靠
- **決定**: 回調失敗不影響觸發結果
- **原因**: 工作流觸發是主要功能，回調是附加通知，不應因通知失敗而影響核心功能
- **影響**: 回調錯誤僅記錄日誌，不影響 TriggerResult

### Decision #4: Prompt 模板變量語法
- **日期**: 2025-11-30
- **背景**: 需要選擇模板變量替換語法
- **選項**:
  1. `{{variable}}` - Jinja2/Mustache 風格
  2. `${variable}` - Shell/ES6 風格
  3. `{variable}` - Python format 風格
- **決定**: `{{variable}}` Jinja2 風格，支持空格 `{{ variable }}`
- **原因**:
  - 與 n8n 和大多數模板引擎兼容
  - 雙括號減少與 JSON/代碼的衝突
  - 空格支持提高可讀性
- **影響**: 使用正則表達式 `\{\{\s*(\w+)\s*\}\}` 匹配變量

### Decision #5: Prompt 模板存儲策略
- **日期**: 2025-11-30
- **背景**: 模板需要持久化存儲和版本管理
- **選項**:
  1. 數據庫存儲 - 完整 CRUD，但複雜
  2. YAML 文件 - 簡單，易於版本控制
  3. 混合方式 - YAML 為基礎，數據庫為用戶自定義
- **決定**: MVP 階段使用 YAML 文件 + 內存緩存
- **原因**:
  - YAML 易於編輯和版本控制
  - 符合 IaC (Infrastructure as Code) 原則
  - MVP 階段快速迭代
- **影響**: 生產環境需要實現數據庫持久化

---

## 決策模板

### Decision #X: 決策標題
- **日期**: YYYY-MM-DD
- **背景**: 為什麼需要這個決策
- **選項**:
  1. 選項 A - 優缺點
  2. 選項 B - 優缺點
- **決定**: 選擇的選項
- **原因**: 為什麼選擇這個
- **影響**: 對後續開發的影響
