# Sprint 26 Decisions: Workflow 模型遷移

**Sprint**: Sprint 26 - Workflow 模型遷移
**Phase**: Phase 5 - MVP Core 官方 API 遷移
**開始日期**: 2025-12-07

---

## 決策記錄

### D26-001: Executor 泛型類型設計

**日期**: 2025-12-07
**決策者**: Claude Code
**狀態**: 待確認

**背景**:
官方 `Executor` 使用泛型類型 `Executor[TInput, TOutput]`。需要決定 `WorkflowNodeExecutor` 的輸入/輸出類型設計。

**選項**:
1. **固定類型**: `Executor[NodeInput, NodeOutput]` - 所有節點使用相同的輸入/輸出類型
2. **動態類型**: 根據節點類型動態確定輸入/輸出
3. **Any 類型**: `Executor[Any, Any]` - 最大靈活性

**決策**: 選項 1 - 固定類型

**理由**:
- 類型安全性更好
- 符合 Pydantic 驗證模式
- 內部可以根據節點類型處理不同邏輯
- 保持 API 一致性

**影響**:
- 需要設計通用的 `NodeInput` 和 `NodeOutput` 模型
- 節點類型特定邏輯在內部處理

---

### D26-002: 條件表達式評估方式

**日期**: 2025-12-07
**決策者**: Claude Code
**狀態**: 待確認

**背景**:
`WorkflowEdge` 可能包含條件表達式，需要決定如何安全地評估這些條件。

**選項**:
1. **eval()**: 直接使用 Python eval - 不安全
2. **AST 解析**: 使用 Python AST 模組 - 中等安全
3. **規則引擎**: 使用專門的規則引擎 (如 simpleeval) - 安全
4. **JSONPath**: 使用 JSONPath 語法 - 安全但功能有限

**決策**: 選項 3 - 規則引擎 (simpleeval)

**理由**:
- 安全性高，避免代碼注入
- 功能足夠滿足條件評估需求
- 輕量級，不增加太多依賴
- 語法直觀，易於理解

**影響**:
- 需要添加 `simpleeval` 依賴
- 條件表達式語法需要文檔說明

---

### D26-003: 向後兼容策略

**日期**: 2025-12-07
**決策者**: Claude Code
**狀態**: 確認

**背景**:
遷移過程中需要保持現有功能不中斷。

**決策**: 漸進式遷移

**策略**:
1. 保留現有 `domain/workflows/models.py` 代碼
2. 在舊代碼中添加 `@deprecated` 裝飾器
3. API Routes 暫時同時支持兩種實現
4. 完整測試通過後再切換
5. Phase 5 結束後再清理舊代碼

**影響**:
- 短期內會有代碼重複
- 需要維護兩套實現直到遷移完成
- 測試需要覆蓋兩種路徑

---

## 待決策項目

| ID | 主題 | 狀態 | 優先級 |
|----|------|------|--------|
| D26-004 | CheckpointStorage 整合方式 | 待討論 | 中 |
| D26-005 | 錯誤處理統一策略 | 待討論 | 高 |

---

## 決策審查

**下次審查日期**: Sprint 26 中期 (約 Day 5)

**審查項目**:
- [ ] D26-001 類型設計是否符合需求
- [ ] D26-002 條件評估是否安全有效
- [ ] D26-003 向後兼容是否順利
