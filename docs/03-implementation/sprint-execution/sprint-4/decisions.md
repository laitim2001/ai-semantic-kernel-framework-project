# Sprint 4 技術決策記錄

## 開發者體驗 (Developer Experience)

---

## 決策 1: 模板存儲策略

**日期**: 2025-11-30
**決策者**: 開發團隊
**狀態**: 已批准

### 上下文
需要決定如何存儲和管理 Agent 模板。

### 選項
1. **YAML 文件存儲**: 模板定義為 YAML 文件，運行時加載
2. **數據庫存儲**: 模板存儲在 PostgreSQL 中
3. **混合方案**: 預置模板用 YAML，自定義模板存數據庫

### 決策
採用 **混合方案**:
- 預置模板: `backend/templates/*.yaml`
- 自定義模板: 存儲在數據庫中
- 運行時統一加載到內存

### 理由
- YAML 文件易於版本控制和審查
- 數據庫支持動態創建和修改
- 統一 API 接口簡化使用

---

## 決策 2: Few-shot 相似度算法

**日期**: 2025-11-30
**決策者**: 開發團隊
**狀態**: 已批准

### 上下文
需要選擇相似度搜索算法來找到相似的學習案例。

### 選項
1. **pg_trgm**: PostgreSQL 內置，基於 trigram
2. **向量搜索**: 使用 embedding + pgvector
3. **Elasticsearch**: 全文搜索引擎

### 決策
採用 **內存相似度計算** (MVP 階段):
- 使用 Python difflib 進行文本相似度計算
- 生產環境遷移到 pg_trgm 或 pgvector

### 理由
- MVP 階段無需複雜配置
- 內存計算速度快
- 易於測試和驗證
- 未來可平滑遷移到數據庫搜索

---

## 決策 3: DevUI 追蹤事件存儲

**日期**: 2025-11-30
**決策者**: 開發團隊
**狀態**: 已批准

### 上下文
需要決定如何存儲執行追蹤事件。

### 選項
1. **內存存儲**: 追蹤事件保存在內存中
2. **Redis 存儲**: 使用 Redis 列表存儲
3. **數據庫存儲**: 持久化到 PostgreSQL

### 決策
採用 **內存存儲** (MVP 階段):
- 追蹤事件保存在 ExecutionTracer 實例中
- 每個執行 ID 有獨立的事件列表
- 執行結束後自動清理

### 理由
- 調試追蹤是臨時數據
- 內存訪問速度最快
- 無需額外依賴
- 生產環境可擴展到 Redis

---

## 決策 4: 版本控制策略

**日期**: 2025-11-30
**決策者**: 開發團隊
**狀態**: 已批准

### 上下文
需要決定模板版本管理的實現方式。

### 選項
1. **Git-like 分支**: 完整的分支和合併支持
2. **線性版本**: 簡單的 major.minor.patch 版本鏈
3. **快照版本**: 每個版本獨立存儲完整內容

### 決策
採用 **線性版本 + 快照存儲**:
- Semantic Versioning (major.minor.patch)
- 每個版本存儲完整內容
- 支持版本比較 (Diff)
- 支持回滾到任意版本

### 理由
- 簡單直觀，符合大多數使用場景
- 無需複雜的合併邏輯
- 每個版本獨立，易於回滾
- 未來可擴展分支支持

---

## 決策 5: API 路由組織

**日期**: 2025-11-30
**決策者**: 開發團隊
**狀態**: 已批准

### 上下文
FastAPI 路由順序問題導致動態路由 `/{id}` 匹配靜態路由 `/health`。

### 決策
**靜態路由必須在動態路由之前定義**:
```python
# Static Routes (MUST be before dynamic routes)
@router.get("/health")
@router.get("/statistics")
@router.get("/categories/list")

# Dynamic Routes (after static routes)
@router.get("/{template_id}")
@router.post("/{template_id}/instantiate")
```

### 理由
- FastAPI 按定義順序匹配路由
- 動態路由會捕獲所有路徑
- 統一規範避免未來問題

---

## 待決策事項

1. 模板市場 UI 設計方案
2. Few-shot 學習效果評估指標
3. WebSocket 實時追蹤實現細節 (Sprint 5)
4. 版本比較 UI 視覺化設計
